<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ================= PWA SETTINGS START ================= -->
    <!-- অ্যাপের নাম, আইকন এবং ডিসপ্লে মোড লোড করার জন্য ম্যানিফেস্ট ফাইল -->
    <link rel="manifest" href="manifest.json">
    
    <!-- মোবাইল ব্রাউজারের অ্যাড্রেস বারের রঙ (Android) -->
    <meta name="theme-color" content="#4361ee">
    
    <!-- iOS (iPhone/iPad) এর জন্য PWA সেটিংস (Full Screen) -->
    <meta name="apple-mobile-web-app-capable" content="yes"> <!-- অ্যাপ হিসেবে ওপেন হবে -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- স্ট্যাটাস বার স্টাইল -->
    <meta name="apple-mobile-web-app-title" content="Cal Master Pro"> <!-- হোম স্ক্রিনে নাম -->
    
    <!-- আইকন পাথ ফিক্স (সরাসরি রুট ফোল্ডারে) -->
    <link rel="apple-touch-icon" href="icon-192x192.png"> 

    <!-- Android এর জন্য ফুল স্ক্রিন মোড -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Microsoft Windows Tiles সাপোর্ট -->
    <meta name="msapplication-TileColor" content="#4361ee"> <!-- টাইল কালার -->
    <meta name="msapplication-TileImage" content="icon-192x192.png"> <!-- উইন্ডোজ আইকন -->
    
    <!-- সাধারণ ফ্যাভিকন (Optional Backup) -->
    <link rel="icon" type="image/png" href="icon-192x192.png">
    <!-- ================= PWA SETTINGS END ================= -->

    <title>ক্যালকুলেটর মাস্টার প্রো</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f1f3f6;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #43aa8b;
            --bg-color: #e0e5ec;
            --text-color: #333;
            --card-bg: #e0e5ec;
            --border-color: #d1d9e6;
            --button-bg: #e0e5ec;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --display-bg: #e0e5ec;
        }

        [data-theme="dark"] {
            --primary-color: #4895ef;
            --secondary-color: #4361ee;
            --accent-color: #3f37c9;
            --light-color: #343a40;
            --dark-color: #f8f9fa;
            --bg-color: #1e1e1e;
            --text-color: #f8f9fa;
            --card-bg: #1e1e1e;
            --border-color: #343a40;
            --button-bg: #1e1e1e;
            --shadow-light: #2a2a2a;
            --shadow-dark: #141414;
            --display-bg: #1e1e1e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 0; 
            min-height: 100vh;
            display: flex;
            justify-content: stretch;
            align-items: stretch;
            overflow: hidden;
            /* PWA Full Screen এর জন্য নিচে প্যাডিং বন্ধ রাখা ভালো, বা প্রয়োজন হলে অ্যাডজাস্ট করুন */
        }
        
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--warning-color);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            z-index: 9999;
            display: none;
        }
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
        }
        #toast-notification.show {
            bottom: 30px;
            opacity: 1;
            visibility: visible;
        }
        #toast-notification.success { background-color: var(--primary-color); }
        #toast-notification.error { background-color: var(--danger-color); }


        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background-color: var(--card-bg);
            border-radius: 0;
            box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #app-announcement {
            padding: 10px 20px;
            background-color: var(--info-color);
            color: white;
            text-align: center;
            font-size: 0.9rem;
            display: none;
            margin: 0;
            border-bottom: 1px solid var(--border-color);
        }


        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: transparent;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            /* iOS Status bar padding fix if needed */
            padding-top: env(safe-area-inset-top, 15px);
        }

        .header h1 {
            font-size: clamp(1.2rem, 5vw, 1.5rem);
            font-weight: 600;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }
        
        .header-icon-button, .menu-toggle {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 10px;
            height: 10px;
            background-color: var(--danger-color);
            border-radius: 50%;
            border: 2px solid var(--card-bg);
            display: none;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 130%;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            z-index: 100;
            width: 250px;
            padding: 10px;
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            max-height: 70vh;
            overflow-y: auto;
        }
        .dropdown-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1rem;
            border-radius: 10px;
            cursor: pointer;
        }
        .menu-item:hover {
            background-color: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        .menu-item i {
            width: 20px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }


        .tab-container {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background-color: transparent;
            padding: 5px 10px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .tab-container::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            outline: none;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
            white-space: nowrap;
            font-weight: 500;
            border-radius: 10px;
            margin: 0 5px;
            transition: all 0.3s;
        }

        .tab:hover {
            opacity: 1;
            background-color: var(--bg-color);
        }

        .tab.active {
            opacity: 1;
            color: var(--primary-color);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeEffect 0.5s;
            flex-grow: 1;
            overflow-y: auto;
            /* Safe area for iPhone X+ */
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .tab-content-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        .tab-content-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        .info-button {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--info-color);
            font-size: 1.3rem;
            cursor: pointer;
        }

        .sub-tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .sub-tab {
            padding: 8px 12px;
            cursor: pointer;
            background-color: var(--button-bg);
            border: none;
            outline: none;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.8;
            font-weight: 500;
            border-radius: 10px;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        .sub-tab.active {
            opacity: 1;
            color: var(--primary-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        .sub-tab-content {
            display: none;
        }
        .sub-tab-content.active {
            display: block;
        }


        @keyframes fadeEffect {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .calculator-display {
            background-color: var(--display-bg);
            padding: 15px 20px;
            text-align: right;
            border-radius: 15px;
            height: 140px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            font-family: 'Roboto Mono', monospace;
            word-wrap: break-word;
            word-break: break-all;
        }

        .calculator-history {
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.6;
            min-height: 25px;
            margin-bottom: 5px;
            overflow-wrap: break-word;
            word-break: break-all;
            white-space: normal;
            text-align: right;
        }

        .calculator-current {
            font-size: 2.8rem;
            font-weight: 500;
            transition: font-size 0.2s ease-in-out;
            line-height: 1.2;
        }

        .calculator-buttons {
            display: grid;
            grid-gap: 15px;
            margin-top: 20px;
        }
        .calculator-buttons { grid-template-columns: repeat(4, 1fr); }

        .calculator-button {
            padding: 20px 10px;
            font-size: 1.3rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-weight: 500;
            transition: all 0.1s linear;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            position: relative;
        }

        .calculator-button:active {
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            font-size: 1.25rem;
        }

        .calculator-button.operator, .calculator-button.function { color: var(--primary-color); }
        .calculator-button.equals { background-color: var(--primary-color); color: white; }
        .calculator-button.equals:active { box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); }
        .calculator-button.clear { color: var(--danger-color); }
        
        .form-group { margin-bottom: 15px; }
        .form-group.inline-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }


        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-wrapper #copy-share-link-btn {
            padding: 0 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        .input-wrapper #copy-share-link-btn:active {
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        .password-toggle-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.7;
            cursor: pointer;
        }


        .fishing-role-input {
            display: grid;
            grid-template-columns: 0.8fr 0.6fr 1fr 0.6fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .fishing-role-input label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        .fishing-role-input input {
            padding: 10px;
            text-align: center;
        }
        .fishing-role-input input[disabled] {
             background-color: var(--display-bg);
             box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        
        .individual-crew-input {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        /* Fishing Expense Row Styles */
        .fishing-expense-row {
            display: grid;
            grid-template-columns: 1fr 0.7fr 0.3fr;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        .fishing-expense-row button {
            padding: 8px 0;
            font-size: 1rem;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        
        /* Preset Buttons */
        .preset-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: none;
            border-radius: 20px;
            background-color: var(--bg-color);
            color: var(--primary-color);
            cursor: pointer;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            font-weight: 500;
            transition: all 0.2s;
        }
        .preset-btn:active {
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input:disabled, select:disabled, button:disabled {
            background-color: var(--border-color);
            opacity: 0.7;
            cursor: not-allowed;
        }

        input:focus, select:focus, textarea:focus { outline: none; }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .calculate-button, .lock-button, .pdf-button, .reset-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            transition: all 0.1s linear;
            margin-top: 0;
        }
        .calculate-button { background-color: var(--primary-color); color: white; }
        .lock-button { background-color: var(--warning-color); color: white; }
        .reset-button { background-color: var(--info-color); color: white; }
        .pdf-button { background-color: var(--danger-color); color: white; margin-top: 15px; display: none; }

        .calculate-button:active, .lock-button:active, .pdf-button:active, .reset-button:active { 
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); 
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--display-bg);
            border-radius: 8px;
            font-size: 1rem;
            display: none;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            text-align: left;
        }
        .disclaimer {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 15px;
            text-align: center;
            color: var(--warning-color);
        }
        
        .package-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .package-card {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
        }
        .package-card h3 {
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .package-card .price {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .package-card .calculate-button {
            width: auto;
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        .payment-methods {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .payment-methods img {
            height: 35px;
            max-width: 100px;
            object-fit: contain;
            cursor: pointer;
            border-radius: 5px;
            background: #fff;
            padding: 5px;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        hr.divider {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 25px 0;
        }
        .calculator-section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            margin-bottom: 25px;
        }
        .calculator-section h3 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
        }
        .result-details {
            font-size: 0.9rem;
            line-height: 1.8;
        }
        .result-details .total {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .zakat-details {
            font-size: 0.9rem;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-color);
            border-radius: 8px;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        .zakat-details h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .zakat-details ul {
            list-style-position: inside;
            padding-left: 5px;
        }


        .full-page-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 200;
            display: none;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            animation: fadeEffect 0.3s;
            padding-top: env(safe-area-inset-top, 10px);
        }
        .page-content {
            max-width: 400px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 20px;
            padding-bottom: 80px;
            border-radius: 20px;
            box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
            position: relative;
        }
        .page-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            justify-content: space-between;
        }
        .page-header h2 {
            flex-grow: 1;
            color: var(--primary-color);
            font-size: 1.3rem;
            text-align: center;
            margin: 0;
        }
        .page-header .header-action-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .page-back-button {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 210;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
        }

        .payment-details p {
            margin-bottom: 12px;
            font-size: 1rem;
            background: var(--bg-color);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-details strong {
            user-select: all;
            color: var(--primary-color);
        }
        .copy-btn {
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.6;
            cursor: pointer;
            font-size: 1rem;
        }

        .history-item {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        .history-item div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .history-item .status {
            font-weight: bold;
        }
        .history-item .status-pending { color: var(--warning-color); }
        .history-item .status-active { color: var(--success-color); }
        .history-item .dates {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 8px;
        }
        
        .calc-history-item {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            position: relative;
        }
        .delete-history-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.1rem;
        }
        .calc-history-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-color);
            padding-right: 25px;
        }
        .calc-history-body {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .calc-history-body pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Roboto Mono', monospace;
            background: var(--display-bg);
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
        }


        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeEffect 0.3s;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
            max-width: 90%;
            width: 380px;
            position: relative;
            text-align: center;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--danger-color);
            cursor: pointer;
        }
        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .modal-content p {
            margin-bottom: 20px;
            text-align: left;
            white-space: pre-wrap;
        }
        .modal-content .cancel-button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            background-color: var(--danger-color);
            color: white;
        }
         .modal-content .cancel-button:active {
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
         }
         
        .poultry-sale-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr 0.5fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        .poultry-sale-row button {
            padding: 10px 0;
            font-size: 1.1rem;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        .poultry-sale-row button:active {
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        .add-row-btn {
            width: auto;
            display: block;
            margin: -5px auto 15px auto;
            padding: 8px 20px;
            background-color: var(--info-color);
            color: white;
        }

        .farming-individual-sale-row {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr 0.5fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        .farming-individual-sale-row label {
             margin-bottom: 0;
             font-size: 0.9rem;
             opacity: 0.8;
             text-align: right;
        }
         .farming-individual-sale-row button {
            padding: 8px 0;
            font-size: 1rem;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        
        #note-list-item {
            display: grid;
            grid-template-columns: auto 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        #note-list-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            box-shadow: none;
        }
        #note-list-item .delete-note-item-btn {
            padding: 8px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            justify-content: center;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .floating-calculator {
            position: absolute;
            top: 20%;
            left: 10%;
            width: 320px;
            min-width: 280px;
            max-width: 90vw;
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 10px 10px 30px rgba(0,0,0,0.3), -10px -10px 20px var(--shadow-light);
            z-index: 100;
            display: none;
            resize: both;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .floating-calculator-header {
            padding: 10px;
            cursor: move;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .floating-calculator-header span {
            font-weight: 500;
        }
        .floating-calculator-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .floating-calculator .calculator-container {
            padding: 15px;
        }
        .floating-calculator .calculator-display { height: 90px; }
        .floating-calculator .calculator-current { font-size: 2.2rem; }
        .floating-calculator .calculator-buttons { grid-gap: 10px; }
        .floating-calculator .calculator-button { padding: 15px 5px; font-size: 1.1rem; }
        .floating-calculator .calculator-button:active { font-size: 1rem; }
        
        .star-rating-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 2rem;
            color: #ccc;
            cursor: pointer;
        }
        .star-rating-container .fa-star {
            transition: color 0.2s;
        }
        .star-rating-container .fa-star.hover,
        .star-rating-container .fa-star.selected {
            color: var(--warning-color);
        }

        .tithi-container {
            margin-top: 15px;
            text-align: left;
        }
        .tithi-list {
            list-style: none;
            padding: 0;
        }
        .tithi-list li {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        .tithi-list li:last-child {
            border-bottom: none;
        }
        .tithi-list li.highlight-purnima, .tithi-list li.highlight-amavasya {
            background-color: var(--accent-color);
            color: white;
            border-radius: 5px;
        }
        .tithi-list li.highlight-ekadashi {
            background-color: var(--info-color);
            color: white;
            border-radius: 5px;
        }
         .tithi-list li.selected-day {
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            font-weight: bold;
        }

        .other-app-card {
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .other-app-card img.logo {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            object-fit: cover;
            margin-bottom: 15px;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
        }
        .other-app-card h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        .other-app-card p {
            opacity: 0.8;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .other-app-card .screenshots {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 15px;
            width: 100%;
            scrollbar-width: thin;
        }
        .other-app-card .screenshots img {
            height: 180px;
            width: auto;
            border-radius: 8px;
            object-fit: contain;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            cursor: pointer;
        }
        .other-app-card .calculate-button {
            width: 100%;
            margin-top: 15px;
            text-decoration: none;
        }

        .image-viewer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .image-viewer-overlay img {
            max-width: 95%;
            max-height: 80%;
            object-fit: contain;
            border-radius: 5px;
        }
        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
        }

    </style>
</head>
<body>
    
    <div class="offline-banner" id="offline-banner">
        আপনি অফলাইনে আছেন। কিছু ফিচার কাজ নাও করতে পারে।
    </div>

    <div class="container">
        <div class="header">
            <h1 data-translate-key="appName">ক্যালকুলেটর মাস্টার প্রো</h1>
            <div class="header-controls">
                <button class="header-icon-button" id="notification-toggle">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge"></span>
                </button>
                <div class="menu-container">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="dropdown-menu" id="dropdown-menu">
                        <div id="auth-menu-item">
                        </div>
                        <div class="menu-item" id="theme-toggle-menu">
                            <i class="fas fa-moon"></i>
                            <span data-translate-key="menu_theme" style="flex-grow: 1;">থিম পরিবর্তন</span>
                            <label class="switch">
                                <input type="checkbox" id="theme-toggle-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="menu-item" onclick="showCalculationHistoryPage()">
                            <i class="fas fa-history"></i> <span data-translate-key="menu_history">হিসাব হিস্টেরি</span>
                        </div>
                        <div class="menu-item" id="change-password-menu-item" style="display: none;" onclick="showPasswordChangePage()">
                            <i class="fas fa-key"></i> <span data-translate-key="menu_change_password">পাসওয়ার্ড পরিবর্তন</span>
                        </div>
                        <div class="menu-item" onclick="showPasswordRecoveryPage()">
                            <i class="fas fa-unlock-alt"></i> <span data-translate-key="menu_password_recovery">পাসওয়ার্ড রিকভারি</span>
                        </div>
                         <div class="menu-item" onclick="showReviewPage()">
                            <i class="fas fa-star-half-alt"></i> <span>রিভিউ দিন</span>
                        </div>
                        <div class="menu-item" onclick="showHelpSupportPage()">
                            <i class="fas fa-headset"></i> <span data-translate-key="menu_help_support">হেল্প ও সাপোর্ট</span>
                        </div>
                        <div class="menu-item" onclick="showPrivacyPolicyPage()">
                             <i class="fas fa-shield-alt"></i> <span>প্রাইভেসি পলিসি</span>
                        </div>
                        <div class="menu-item" onclick="showOtherAppsPage()">
                             <i class="fas fa-th-large"></i> <span>অন্যান্য অ্যাপস</span>
                        </div>
                        <a href="https://t.me/km_crafts75" target="_blank" class="menu-item" id="idea-link">
                            <i class="fas fa-lightbulb"></i> <span data-translate-key="menu_help">আপনার আইডিয়া দিন</span>
                        </a>
                        <a href="https://t.me/myapk998" target="_blank" class="menu-item" id="update-link">
                            <i class="fas fa-sync-alt"></i> <span data-translate-key="menu_update">অ্যাপস আপডেট</span>
                        </a>
                        <div class="menu-item" onclick="shareApp()">
                            <i class="fas fa-share-alt"></i> <span data-translate-key="menu_share">শেয়ার</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="app-announcement"></div>

        <div class="tab-container">
             <div class="all-tabs-dropdown">
                <select onchange="openTab(event, this.value, true)">
                    <option value="" data-translate-key="all_tabs">All</option>
                    <option value="basic" data-tab-id="basic" data-translate-key="tab_basic_option">সাধারণ</option>
                    <option value="offer" data-tab-id="offer">অফার</option>
                    <option value="price" data-tab-id="price" data-translate-key="tab_price_option">মূল্য হিসেব</option>
                    <option value="bazar" data-tab-id="bazar">বাজার</option>
                    <option value="fishing" data-tab-id="fishing" data-translate-key="tab_fishing_option">মাছ ধরা</option>
                    <option value="farming" data-tab-id="farming" data-translate-key="tab_farming_option">খামার</option>
                    <option value="age" data-tab-id="age" data-translate-key="tab_age_option">বয়স</option>
                    <option value="health" data-tab-id="health" data-translate-key="tab_health_option">স্বাস্থ্য</option>
                    <option value="discount" data-tab-id="discount" data-translate-key="tab_discount_option">ডিসকাউন্ট</option>
                    <option value="bengali-date" data-tab-id="bengali-date" data-translate-key="tab_bengali_date_option">বাংলা তারিখ</option>
                    <option value="electricity" data-tab-id="electricity" data-translate-key="tab_electricity_option">বিদ্যুৎ</option>
                    <option value="land" data-tab-id="land" data-translate-key="tab_land_option">জমি</option>
                    <option value="inheritance" data-tab-id="inheritance" data-translate-key="tab_inheritance_option">উত্তরাধিকার</option>
                    <option value="zakat" data-tab-id="zakat" data-translate-key="tab_zakat_option">যাকাত</option>
                    <option value="tax" data-tab-id="tax" data-translate-key="tab_tax_option">ট্যাক্স</option>
                    <option value="investment" data-tab-id="investment" data-translate-key="tab_investment_option">বিনিয়োগ</option>
                    <option value="paint-carpet" data-tab-id="paint-carpet" data-translate-key="tab_paint_carpet_option">রং/কার্পেট</option>
                    <option value="construction" data-tab-id="construction" data-translate-key="tab_construction_option">নির্মাণ</option>
                    <option value="converter" data-tab-id="converter" data-translate-key="tab_converter_option">রূপান্তর</option>
                </select>
            </div>
            <button class="tab active" data-tab-id="basic" onclick="openTab(event, 'basic')" data-translate-key="tab_basic"><i class="fas fa-calculator"></i> সাধারণ</button>
            <button class="tab" data-tab-id="offer" onclick="openTab(event, 'offer')"><i class="fas fa-gift"></i> অফার</button>
            <button class="tab" data-tab-id="price" onclick="openTab(event, 'price')" data-translate-key="tab_price"><i class="fas fa-tag"></i> মূল্য হিসেব</button>
            <button class="tab" data-tab-id="bazar" onclick="openTab(event, 'bazar')"><i class="fas fa-shopping-cart"></i> বাজার</button>
            <button class="tab" data-tab-id="fishing" onclick="openTab(event, 'fishing')" data-translate-key="tab_fishing"><i class="fas fa-ship"></i> মাছ ধরা</button>
            <button class="tab" data-tab-id="farming" onclick="openTab(event, 'farming')" data-translate-key="tab_farming"><i class="fas fa-tractor"></i> খামার</button>
            <button class="tab" data-tab-id="age" onclick="openTab(event, 'age')" data-translate-key="tab_age"><i class="fas fa-birthday-cake"></i> বয়স</button>
            <button class="tab" data-tab-id="health" onclick="openTab(event, 'health')" data-translate-key="tab_health"><i class="fas fa-heartbeat"></i> স্বাস্থ্য</button>
            <button class="tab" data-tab-id="discount" onclick="openTab(event, 'discount')" data-translate-key="tab_discount"><i class="fas fa-percent"></i> ডিসকাউন্ট</button>
            <button class="tab" data-tab-id="bengali-date" onclick="openTab(event, 'bengali-date')" data-translate-key="tab_bengali_date"><i class="fas fa-calendar-alt"></i> বাংলা তারিখ</button>
            <button class="tab" data-tab-id="electricity" onclick="openTab(event, 'electricity')" data-translate-key="tab_electricity"><i class="fas fa-bolt"></i> বিদ্যুৎ</button>
            <button class="tab" data-tab-id="land" onclick="openTab(event, 'land')" data-translate-key="tab_land"><i class="fas fa-ruler-combined"></i> জমি</button>
            <button class="tab" data-tab-id="inheritance" onclick="openTab(event, 'inheritance')" data-translate-key="tab_inheritance"><i class="fas fa-users"></i> উত্তরাধিকার</button>
            <button class="tab" data-tab-id="zakat" onclick="openTab(event, 'zakat')" data-translate-key="tab_zakat"><i class="fas fa-hand-holding-heart"></i> যাকাত</button>
            <button class="tab" data-tab-id="tax" onclick="openTab(event, 'tax')" data-translate-key="tab_tax"><i class="fas fa-file-invoice-dollar"></i> ট্যাক্স</button>
            <button class="tab" data-tab-id="investment" onclick="openTab(event, 'investment')" data-translate-key="tab_investment"><i class="fas fa-chart-line"></i> বিনিয়োগ</button>
            <button class="tab" data-tab-id="paint-carpet" onclick="openTab(event, 'paint-carpet')" data-translate-key="tab_paint_carpet"><i class="fas fa-paint-roller"></i> রং/কার্পেট</button>
            <button class="tab" data-tab-id="construction" onclick="openTab(event, 'construction')" data-translate-key="tab_construction"><i class="fas fa-hard-hat"></i> নির্মাণ</button>
            <button class="tab" data-tab-id="converter" onclick="openTab(event, 'converter')" data-translate-key="tab_converter"><i class="fas fa-exchange-alt"></i> রূপান্তর</button>
        </div>
        
        <div id="basic" class="tab-content" style="display: block;">

            <div id="floating-calculator" class="floating-calculator">
                <div class="floating-calculator-header">
                    <span>মিনি ক্যালকুলেটর</span>
                    <button class="floating-calculator-close" onclick="toggleFloatingCalculator()">&times;</button>
                </div>
                <div class="calculator-container">
                    <div class="calculator-display">
                        <div class="calculator-history" id="floating-history"></div>
                        <div class="calculator-current" id="floating-display">0</div>
                    </div>
                    <div class="calculator-buttons" style="grid-template-columns: repeat(4, 1fr);">
                        <button onclick="clearDisplay('floating')" class="calculator-button clear">C</button>
                        <button onclick="backspace('floating')" class="calculator-button function">⌫</button>
                        <button onclick="appendToDisplay('floating', '%')" class="calculator-button function">%</button>
                        <button onclick="appendToDisplay('floating', '/')" class="calculator-button operator">÷</button>
                        <button onclick="appendToDisplay('floating', '7')" class="calculator-button">7</button>
                        <button onclick="appendToDisplay('floating', '8')" class="calculator-button">8</button>
                        <button onclick="appendToDisplay('floating', '9')" class="calculator-button">9</button>
                        <button onclick="appendToDisplay('floating', '*')" class="calculator-button operator">×</button>
                        <button onclick="appendToDisplay('floating', '4')" class="calculator-button">4</button>
                        <button onclick="appendToDisplay('floating', '5')" class="calculator-button">5</button>
                        <button onclick="appendToDisplay('floating', '6')" class="calculator-button">6</button>
                        <button onclick="appendToDisplay('floating', '-')" class="calculator-button operator">-</button>
                        <button onclick="appendToDisplay('floating', '1')" class="calculator-button">1</button>
                        <button onclick="appendToDisplay('floating', '2')" class="calculator-button">2</button>
                        <button onclick="appendToDisplay('floating', '3')" class="calculator-button">3</button>
                        <button onclick="appendToDisplay('floating', '+')" class="calculator-button operator">+</button>
                        <button onclick="appendToDisplay('floating', '0')" class="calculator-button" style="grid-column: span 2;">0</button>
                        <button onclick="appendToDisplay('floating', '.')" class="calculator-button">.</button>
                        <button onclick="calculate('floating')" class="calculator-button equals">=</button>
                    </div>
                </div>
            </div>

            <div class="calculator-container">
                <div class="calculator-display">
                    <div class="calculator-history" id="basic-history"></div>
                    <div class="calculator-current" id="basic-display">0</div>
                </div>
                <div class="calculator-buttons" style="grid-template-columns: repeat(5, 1fr);">
                    <button onclick="memoryClear('basic')" class="calculator-button function">MC</button>
                    <button onclick="memoryRecall('basic')" class="calculator-button function">MR</button>
                    <button onclick="memorySubtract('basic')" class="calculator-button function">M-</button>
                    <button onclick="memoryAdd('basic')" class="calculator-button function">M+</button>
                    <button onclick="toggleFloatingCalculator()" class="calculator-button function" title="ভাসমান ক্যালকুলেটর">⇱</button>
                    
                    <button onclick="clearDisplay('basic')" class="calculator-button clear">C</button>
                    <button onclick="appendToDisplay('basic', '(')" class="calculator-button function">(</button>
                    <button onclick="appendToDisplay('basic', ')')" class="calculator-button function">)</button>
                    <button onclick="backspace('basic')" class="calculator-button function">⌫</button>
                    <button onclick="appendToDisplay('basic', '/')" class="calculator-button operator">÷</button>
                    
                    <button onclick="appendToDisplay('basic', '7')" class="calculator-button">7</button>
                    <button onclick="appendToDisplay('basic', '8')" class="calculator-button">8</button>
                    <button onclick="appendToDisplay('basic', '9')" class="calculator-button">9</button>
                    <button onclick="appendToDisplay('basic', '*')" class="calculator-button operator" style="grid-column: 4 / 6;">×</button>

                    <button onclick="appendToDisplay('basic', '4')" class="calculator-button">4</button>
                    <button onclick="appendToDisplay('basic', '5')" class="calculator-button">5</button>
                    <button onclick="appendToDisplay('basic', '6')" class="calculator-button">6</button>
                    <button onclick="appendToDisplay('basic', '-')" class="calculator-button operator" style="grid-column: 4 / 6;">-</button>
                    
                    <button onclick="appendToDisplay('basic', '1')" class="calculator-button">1</button>
                    <button onclick="appendToDisplay('basic', '2')" class="calculator-button">2</button>
                    <button onclick="appendToDisplay('basic', '3')" class="calculator-button">3</button>
                    <button onclick="appendToDisplay('basic', '+')" class="calculator-button operator" style="grid-column: 4 / 6;">+</button>
                    
                    <button onclick="appendToDisplay('basic', '0')" class="calculator-button" style="grid-column: 1 / 3;">0</button>
                    <button onclick="appendToDisplay('basic', '.')" class="calculator-button">.</button>
                    <button onclick="calculate('basic')" class="calculator-button equals" style="grid-column: 4 / 6;">=</button>
                </div>
            </div>
        </div>
        
        <div id="offer" class="tab-content">
            <div class="tab-content-header">
                <h3>অফার ক্যালকুলেটর</h3>
                 <button class="info-button" onclick="showInfoModal('offer')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="offer-operator">অপারেটর সিলেক্ট করুন:</label>
                <select id="offer-operator">
                    <option value="0.67">Grameenphone (GP)</option>
                    <option value="0.60">Robi</option>
                    <option value="0.65">Airtel</option>
                    <option value="0.89">Banglalink</option>
                    <option value="0.45">Teletalk</option>
                    <option value="0.50">Skitto</option>
                </select>
            </div>
            <div class="form-group">
                <label for="offer-data">ডাটা (GB):</label>
                <input type="number" id="offer-data" placeholder="যেমন: 22">
            </div>
            <div class="form-group">
                <label for="offer-minutes">মিনিট:</label>
                <input type="number" id="offer-minutes" placeholder="যেমন: 500">
            </div>
            <div class="form-group">
                <label for="offer-price">মোট দাম (টাকা):</label>
                <input type="number" id="offer-price" placeholder="যেমন: 699">
            </div>
            <div class="form-group">
                <label for="offer-validity">মেয়াদ (দিন):</label>
                <input type="number" id="offer-validity" placeholder="যেমন: 30">
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetOfferTab()"><i class="fas fa-sync-alt"></i> রিসেট</button>
                <button class="calculate-button" onclick="calculateOffer()"><i class="fas fa-calculator"></i> হিসাব করুন</button>
            </div>
            <div class="result" id="offer-result"></div>
        </div>

        <div id="price" class="tab-content">
            <div class="tab-content-header">
                <h3 data-translate-key="price_ref_title">পণ্যের রেফারেন্স মূল্য</h3>
                <button class="info-button" onclick="showInfoModal('price')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="calculator-section" style="padding-top: 5px; margin-bottom: 15px;">
                <div class="form-group">
                    <label data-translate-key="price_ref_label">পণ্যের দাম ও ওজন লিখুন</label>
                    <div class="input-wrapper">
                        <input type="number" id="price-ref-amount" data-translate-key-placeholder="price_ref_amount_placeholder">
                        <input type="number" id="price-ref-weight" value="1000" data-translate-key-placeholder="price_ref_weight_placeholder">
                        <select id="price-ref-unit">
                            <option value="gram" data-translate-key="unit_gram">গ্রাম</option>
                            <option value="kg" data-translate-key="unit_kg">কেজি</option>
                        </select>
                    </div>
                     <!-- Quick Presets added -->
                    <div class="quick-presets" style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="preset-btn" onclick="setPriceWeight(250, 'gram')">২৫০ গ্রাম</button>
                        <button class="preset-btn" onclick="setPriceWeight(500, 'gram')">৫০০ গ্রাম</button>
                        <button class="preset-btn" onclick="setPriceWeight(1, 'kg')">১ কেজি</button>
                        <button class="preset-btn" onclick="setPriceWeight(5, 'kg')">৫ কেজি</button>
                    </div>
                </div>
            </div>
            
            <hr class="divider">
            
            <div class="form-group">
                <label data-translate-key="price_target_label">কতটুকু কিনবেন?</label>
                <div class="input-wrapper">
                    <input type="number" id="price-target-weight" oninput="togglePriceInputs('weight')" data-translate-key-placeholder="price_target_weight_placeholder">
                    <select id="price-target-unit" onchange="togglePriceInputs('weight')">
                        <option value="gram" data-translate-key="unit_gram_2">গ্রাম</option>
                        <option value="kg" data-translate-key="unit_kg_2">কেজি</option>
                    </select>
                </div>
            </div>
            
            <p style="text-align:center; margin: -5px 0 10px 0;">অথবা</p>
            
             <div class="form-group">
                <label data-translate-key="price_budget_label">কত টাকার কিনবেন?</label>
                <input type="number" id="price-budget-amount" oninput="togglePriceInputs('budget')" data-translate-key-placeholder="price_budget_placeholder">
            </div>

            <div class="button-group">
                <button class="reset-button" onclick="resetPriceTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('price', calculatePriceOrQuantity)" data-translate-key-revert="price_calculate_btn_main"><i class="fas fa-calculator"></i> <span >হিসাব করুন</span></button>
            </div>
            <div class="result" id="price-tab-result" style="text-align: center;"></div>
        </div>
        
        <div id="bazar" class="tab-content">
            <div class="tab-content-header">
                <h3>বাজারের হিসাব</h3>
                <button class="info-button" onclick="showInfoModal('bazar')"><i class="fas fa-info-circle"></i></button>
            </div>

            <div class="calculator-section">
                <label>আপনার বাজারের তালিকা:</label>
                <div id="note-list-container" style="margin-top: 10px;">
                </div>
                <button class="calculate-button add-row-btn" onclick="addNoteListItem()" style="margin-top: 15px;"><i class="fas fa-plus"></i> আইটেম যোগ করুন</button>
                <hr class="divider" style="margin: 15px 0;">
                <div class="button-group">
                    <button class="reset-button" onclick="resetNoteTab()"><i class="fas fa-sync-alt"></i> রিসেট</button>
                    <button class="calculate-button" onclick="calculateNoteListTotal()"><i class="fas fa-calculator"></i> মোট হিসাব</button>
                </div>
                <div class="result" id="note-list-result" style="text-align: center;"></div>
            </div>
        </div>

        <div id="fishing" class="tab-content">
            <div class="tab-content-header">
                <h3 data-translate-key="tab_fishing_option">মাছ ধরার হিসাব</h3>
                <button class="info-button" onclick="showInfoModal('fishing')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div id="fishing-inputs">
                <div class="form-group">
                    <label for="fishing-earnings" data-translate-key="fishing_earnings_label">মাছ বিক্রি করে মোট আয়:</label>
                    <input type="number" id="fishing-earnings" data-translate-key-placeholder="fishing_earnings_placeholder">
                </div>

                <div class="form-group">
                    <label data-translate-key="fishing_expenses_label">ট্রলার ও অন্যান্য খরচ:</label>
                    <div class="radio-group" style="justify-content: flex-start;">
                        <label><input type="radio" name="fishing-expense-method" value="total" onchange="toggleFishingExpenseMode(this.value)" checked> মোট খরচ</label>
                        <label><input type="radio" name="fishing-expense-method" value="details" onchange="toggleFishingExpenseMode(this.value)"> খরচের বিবরণ</label>
                    </div>

                    <div id="fishing-expense-total-container">
                        <input type="number" id="fishing-expenses" value="" data-translate-key-placeholder="fishing_expenses_placeholder">
                    </div>

                    <div id="fishing-expense-details-container" style="display: none;">
                        <!-- Fixed expense fields -->
                        <div class="form-group" style="margin-bottom: 8px;">
                             <div class="fishing-expense-row">
                                <input type="text" value="তেল/ডিজেল" readonly style="background-color: var(--button-bg);">
                                <input type="number" id="exp-diesel" class="fishing-expense-amount" placeholder="টাকা">
                                <span style="text-align:center;">-</span>
                            </div>
                             <div class="fishing-expense-row">
                                <input type="text" value="বরফ (Ice)" readonly style="background-color: var(--button-bg);">
                                <input type="number" id="exp-ice" class="fishing-expense-amount" placeholder="টাকা">
                                <span style="text-align:center;">-</span>
                            </div>
                             <div class="fishing-expense-row">
                                <input type="text" value="বাজার/রেশন" readonly style="background-color: var(--button-bg);">
                                <input type="number" id="exp-food" class="fishing-expense-amount" placeholder="টাকা">
                                <span style="text-align:center;">-</span>
                            </div>
                             <div class="fishing-expense-row">
                                <input type="text" value="মেরামত/অন্যান্য" readonly style="background-color: var(--button-bg);">
                                <input type="number" id="exp-repair" class="fishing-expense-amount" placeholder="টাকা">
                                <span style="text-align:center;">-</span>
                            </div>
                        </div>
                        <div id="fishing-expense-rows-container"></div>
                        <button class="calculate-button add-row-btn" onclick="addFishingExpenseRow()"><i class="fas fa-plus"></i> অন্যান্য খরচ যোগ করুন</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="fishing-owner-share" data-translate-key="fishing_owner_share_label">ট্রলার মালিকের ভাগ (%):</label>
                    <input type="number" id="fishing-owner-share" data-translate-key-placeholder="fishing_owner_share_placeholder">
                </div>
                <hr style="border-color: var(--border-color); margin: 15px 0;">
                
                <div class="fishing-role-input">
                    <label for="fishing-majhi-count" data-translate-key="fishing_majhi_label">মাঝি:</label>
                    <input type="number" id="fishing-majhi-count" value="1" min="0" max="4" oninput="generateCrewInputs()">
                    <label for="fishing-majhi-share" data-translate-key="fishing_majhi_share_label">মাঝির ভাগ:</label>
                    <input type="number" id="fishing-majhi-share" value="2" min="0" step="0.1">
                </div>
                <div class="fishing-role-input">
                    <label for="fishing-baburchi-count" data-translate-key="fishing_baburchi_label">বাবুর্চি:</label>
                    <input type="number" id="fishing-baburchi-count" value="1" min="0" max="4" oninput="generateCrewInputs()">
                    <label for="fishing-baburchi-share" data-translate-key="fishing_baburchi_share_label">বাবুর্চি ভাগ:</label>
                    <input type="number" id="fishing-baburchi-share" value="1.5" min="0" step="0.1">
                </div>
                <div class="fishing-role-input">
                    <label for="fishing-crew-count" data-translate-key="fishing_crew_label">সাধারণ জেলে:</label>
                    <input type="number" id="fishing-crew-count" min="0" max="30" oninput="generateCrewInputs()">
                    <label for="fishing-crew-share" data-translate-key="fishing_crew_share_label">জেলের ভাগ:</label>
                    <input type="number" value="1" disabled title="সাধারণ জেলের ভাগ ১">
                </div>
                <hr style="border-color: var(--border-color); margin: 15px 0;">

                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label data-translate-key="fishing_advance_details_label" style="margin-bottom:0;">জেলেদের নাম ও ব্যক্তিগত অগ্রিম:</label>
                    <div>
                        <button onclick="saveCrewTeam()" class="header-icon-button" title="টিম সেভ করুন"><i class="fas fa-save"></i></button>
                        <button onclick="loadCrewTeam()" class="header-icon-button" title="টিম লোড করুন"><i class="fas fa-upload"></i></button>
                        <button onclick="toggleCrewList(event)" class="header-icon-button" style="padding: 5px;">
                            <i id="crew-list-icon" class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div id="crew-details-container" style="margin-top: 10px; display: none;"></div>
            </div>
            
            <div class="button-group">
                <button class="reset-button" onclick="resetFishingTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="lock-button" id="lock-button-fishing" onclick="toggleLock('fishing')" data-locked="false">
                    <i class="fas fa-unlock"></i> <span data-translate-key="lock_inputs_btn">লক</span>
                </button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('fishing', calculateFishingShares)" data-translate-key-revert="fishing_calculate_btn">
                    <i class="fas fa-calculator"></i> <span>হিসাব করুন</span>
                </button>
            </div>
            
            <div class="result" id="fishing-result">
            </div>
        </div>

        <div id="farming" class="tab-content">
            <div class="tab-content-header">
                <h3 data-translate-key="tab_farming_option">খামারের হিসাব</h3>
                <button class="info-button" onclick="showInfoModal('farming')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div id="farming-inputs">
                <label data-translate-key="farming_initial_costs_label">প্রাথমিক খরচ:</label>
                <div class="form-group inline-group">
                    <input type="number" id="farming-chick-count" data-translate-key-placeholder="farming_chick_count_placeholder">
                    <input type="number" id="farming-chick-price" data-translate-key-placeholder="farming_chick_price_placeholder">
                </div>
                
                <label data-translate-key="farming_running_costs_label">চলমান খরচ:</label>
                <div class="form-group">
                    <input type="number" id="farming-feed-cost" data-translate-key-placeholder="farming_feed_cost_placeholder">
                </div>
                 <div class="form-group">
                    <input type="number" id="farming-medicine-cost" data-translate-key-placeholder="farming_medicine_cost_placeholder">
                </div>
                 <div class="form-group">
                    <input type="number" id="farming-other-cost" data-translate-key-placeholder="farming_other_cost_placeholder">
                </div>

                <hr class="divider">
                
                <label data-translate-key="farming_other_info_label">অন্যান্য তথ্য:</label>
                <div class="form-group inline-group">
                     <input type="number" id="farming-mortality" data-translate-key-placeholder="farming_mortality_placeholder">
                     <input type="number" id="farming-duration" data-translate-key-placeholder="farming_duration_placeholder">
                </div>
                
                <hr class="divider">
                
                <label data-translate-key="farming_sales_label">বিক্রির বিবরণ:</label>
                 <div class="form-group">
                     <label for="farming-price-per-kg" data-translate-key="farming_price_per_kg_label">প্রতি কেজি মুরগির বিক্রয় দর:</label>
                     <input type="number" id="farming-price-per-kg" data-translate-key-placeholder="farming_price_per_kg_placeholder">
                </div>

                <div class="form-group radio-group">
                    <label><input type="radio" name="farming-weight-method" value="total" onchange="toggleFarmingWeightInputs(this.value)" checked> মোট ওজন</label>
                    <label><input type="radio" name="farming-weight-method" value="individual" onchange="toggleFarmingWeightInputs(this.value)"> আলাদা ওজন</label>
                </div>

                <div id="farming-total-weight-container">
                    <div class="form-group">
                        <label for="farming-total-weight">বিক্রি করা মোট ওজন (কেজি):</label>
                        <input type="number" id="farming-total-weight" placeholder="যেমন: 1250.5">
                    </div>
                </div>

                <div id="farming-individual-weight-container" style="display: none;">
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                        <div style="flex-grow: 1;">
                            <label for="farming-generate-rows-count" data-translate-key="farming_generate_rows_label">সারি সংখ্যা লিখুন:</label>
                            <div class="input-wrapper">
                                 <input type="number" id="farming-generate-rows-count" placeholder="_ _ _">
                                 <button class="calculate-button" style="padding: 0 15px;" onclick="generateFarmingSaleRows()" data-translate-key="farming_generate_rows_btn">তৈরি</button>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <label data-translate-key="farming_toggle_rows_label">তালিকা</label>
                            <button onclick="toggleFarmingSaleRows(event)" class="header-icon-button" style="font-size: 1.5rem;">
                                <i id="farming-rows-icon" class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>

                    <div id="farming-individual-sales-rows" style="display: none; max-height: 200px; overflow-y: auto; padding: 10px; border-radius: 8px; background-color: var(--bg-color); box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);">
                    </div>
                    <button class="calculate-button add-row-btn" onclick="addIndividualFarmingSaleRow()"><i class="fas fa-plus"></i> <span data-translate-key="farming_add_one_sale_btn">একটি সারি যোগ করুন</span></button>
                </div>
            </div>
            
            <div class="button-group">
                <button class="reset-button" onclick="resetFarmingTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="lock-button" id="lock-button-farming" onclick="toggleLock('farming')" data-locked="false">
                    <i class="fas fa-unlock"></i> <span data-translate-key="lock_inputs_btn">লক</span>
                </button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('farming', calculateFarmingProfitLoss)" data-translate-key-revert="farming_calculate_btn">
                    <i class="fas fa-calculator"></i> <span>হিসাব করুন</span>
                </button>
            </div>
            
            <div class="result" id="farming-result">
            </div>
        </div>

        <div id="age" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_age_option">বয়স ক্যালকুলেটর</h3>
                <button class="info-button" onclick="showInfoModal('age')"><i class="fas fa-info-circle"></i></button>
            </div>
            
            <div class="sub-tab-container">
                <button class="sub-tab active" onclick="openSubTab(event, 'age-calc')">বয়স বের করুন</button>
                <button class="sub-tab" onclick="openSubTab(event, 'age-compare')">বয়স তুলনা</button>
            </div>

            <!-- Age Calculate Sub-tab -->
            <div id="age-calc" class="sub-tab-content active">
                <div class="form-group">
                    <label for="birth-date" data-translate-key="age_label">আপনার জন্ম তারিখ লিখুন:</label>
                    <input type="date" id="birth-date" style="padding: 12px 15px;">
                </div>
                <div class="button-group">
                    <button class="reset-button" onclick="resetAgeTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                    <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('age', calculateAge)" data-translate-key-revert="age_calculate_btn"><i class="fas fa-calculator"></i> <span>বয়স হিসাব করুন</span></button>
                </div>
                <div class="result" id="age-result" style="text-align: center;"></div>
            </div>

            <!-- Age Compare Sub-tab -->
            <div id="age-compare" class="sub-tab-content">
                <div class="form-group">
                    <label for="age-compare-1">প্রথম ব্যক্তির জন্ম তারিখ:</label>
                    <input type="date" id="age-compare-1" style="padding: 12px 15px;">
                </div>
                 <div class="form-group">
                    <label for="age-compare-2">দ্বিতীয় ব্যক্তির জন্ম তারিখ:</label>
                    <input type="date" id="age-compare-2" style="padding: 12px 15px;">
                </div>
                <div class="button-group">
                    <button class="reset-button" onclick="resetAgeTab()"><i class="fas fa-sync-alt"></i> রিসেট</button>
                    <button class="calculate-button" onclick="calculateAgeDifference()"><i class="fas fa-calculator"></i> পার্থক্য দেখুন</button>
                </div>
                <div class="result" id="age-compare-result" style="text-align: center;"></div>
            </div>
        </div>

        <div id="health" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_health_option">স্বাস্থ্য ক্যালকুলেটর</h3>
                <button class="info-button" onclick="showInfoModal('health')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="health-age" data-translate-key="health_age_label">বয়স (বছর):</label>
                <input type="number" id="health-age" data-translate-key-placeholder="health_age_placeholder">
            </div>
             <div class="form-group">
                <label for="health-gender" data-translate-key="health_gender_label">লিঙ্গ:</label>
                <select id="health-gender">
                    <option value="male" data-translate-key="gender_male">পুরুষ</option>
                    <option value="female" data-translate-key="gender_female">মহিলা</option>
                </select>
            </div>
             <div class="form-group">
                <label data-translate-key="health_height_label">উচ্চতা:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="health-height-ft" data-translate-key-placeholder="height_ft_placeholder">
                    <input type="number" id="health-height-in" data-translate-key-placeholder="height_in_placeholder">
                </div>
            </div>
            <div class="form-group">
                <label for="health-weight" data-translate-key="health_weight_label">ওজন (কেজি):</label>
                <input type="number" id="health-weight" data-translate-key-placeholder="health_weight_placeholder">
            </div>
            <div class="form-group">
                <label for="health-calories" data-translate-key="health_calories_label">আপনার দৈনিক ক্যালোরি গ্রহণের পরিমাণ:</label>
                <input type="number" id="health-calories" data-translate-key-placeholder="health_calories_placeholder">
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetHealthTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('health', calculateHealth)" data-translate-key-revert="health_calculate_btn"><i class="fas fa-calculator"></i> <span>হিসাব করুন</span></button>
            </div>
            <div class="result" id="health-result"></div>
        </div>

        <div id="discount" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_discount_option">ডিসকাউন্ট ক্যালকুলেটর</h3>
                <button class="info-button" onclick="showInfoModal('discount')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="discount-price" data-translate-key="discount_price_label">পণ্যের আসল মূল্য:</label>
                <input type="number" id="discount-price" data-translate-key-placeholder="discount_price_placeholder">
            </div>
            <div class="form-group">
                <label for="discount-percentage" data-translate-key="discount_percentage_label">ছাড়ের হার (%):</label>
                <input type="number" id="discount-percentage" data-translate-key-placeholder="discount_percentage_placeholder">
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetDiscountTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('discount', calculateDiscount)" data-translate-key-revert="discount_calculate_btn"><i class="fas fa-calculator"></i> <span>হিসাব করুন</span></button>
            </div>
            <div class="result" id="discount-result"></div>
        </div>

        <div id="bengali-date" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_bengali_date_option">বাংলা তারিখ কনভার্টার</h3>
                <button class="info-button" onclick="showInfoModal('bengali-date')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="gregorian-date" data-translate-key="bengali_date_label">ইংরেজি তারিখ নির্বাচন করুন:</label>
                <input type="date" id="gregorian-date" style="padding: 12px 15px;">
            </div>
            <div class="button-group">
                 <button class="reset-button" onclick="resetBengaliDateTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('bengali-date', calculateBengaliDate)" data-translate-key-revert="bengali_date_calculate_btn"><i class="fas fa-calculator"></i> <span>রূপান্তর করুন</span></button>
            </div>
            <div class="result" id="bengali-date-result" style="text-align: center;"></div>
        </div>

        <div id="electricity" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="elec_title">আবাসিক বিদ্যুৎ বিল হিসাব</h3>
                <button class="info-button" onclick="showInfoModal('electricity')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="electricity-prev" data-translate-key="elec_prev_label">পূর্ববর্তী মাসের রিডিং (Unit):</label>
                <input type="number" id="electricity-prev" data-translate-key-placeholder="elec_prev_placeholder">
            </div>
            <div class="form-group">
                <label for="electricity-current" data-translate-key="elec_current_label">বর্তমান মাসের রিডিং (Unit):</label>
                <input type="number" id="electricity-current" data-translate-key-placeholder="elec_current_placeholder">
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetElectricityTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('electricity', calculateElectricityBill)" data-translate-key-revert="elec_calculate_btn"><i class="fas fa-calculator"></i> <span>বিল হিসাব করুন</span></button>
            </div>
            <div class="result" id="electricity-result"></div>
             <div class="disclaimer" style="margin-top: 15px;" data-translate-key="elec_disclaimer">
                <strong>দ্রষ্টব্য:</strong> এটি একটি আনুমানিক হিসাব। বিদ্যুতের মূল্যহার পরিবর্তনশীল।
            </div>
        </div>
        
        <div id="land" class="tab-content">
            <div class="tab-content-header">
                <h3 data-translate-key="tab_land_option">জমি পরিমাপক</h3>
                <button class="info-button" onclick="showInfoModal('land')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="land-length" data-translate-key="land_length_label">দৈর্ঘ্য (ফুট):</label>
                <input type="number" id="land-length" data-translate-key-placeholder="land_length_placeholder">
            </div>
            <div class="form-group">
                <label for="land-width" data-translate-key="land_width_label">প্রস্থ (ফুট):</label>
                <input type="number" id="land-width" data-translate-key-placeholder="land_width_placeholder">
            </div>
            <div class="form-group">
                <label for="land-unit" data-translate-key="land_unit_label">একক:</label>
                <select id="land-unit">
                    <option value="sqft" data-translate-key="land_unit_sqft">বর্গফুট</option>
                    <option value="sqm" data-translate-key="land_unit_sqm">বর্গমিটার</option>
                    <option value="katha" data-translate-key="land_unit_katha">কাঠা</option>
                    <option value="bigha" data-translate-key="land_unit_bigha">বিঘা</option>
                    <option value="acre" data-translate-key="land_unit_acre">একর</option>
                    <option value="hectare" data-translate-key="land_unit_hectare">হেক্টর</option>
                </select>
            </div>
            <div class="button-group">
                 <button class="reset-button" onclick="resetLandTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('land', calculateLandArea)" data-translate-key-revert="land_calculate_btn"><i class="fas fa-calculator"></i> <span>পরিমাপ নির্ণয় করুন</span></button>
            </div>
            <div class="result" id="land-result" style="text-align: center;">
                <div class="result-title" data-translate-key="land_result_title">ফলাফল:</div>
                <div id="land-area"></div>
            </div>
        </div>

        <div id="inheritance" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_inheritance_option">উত্তরাধিকার ক্যালকুলেটর</h3>
                 <button class="info-button" onclick="showInfoModal('inheritance')"><i class="fas fa-info-circle"></i></button>
            </div>
            
            <label data-translate-key="inheritance_property_label">মোট সম্পত্তি:</label>
            <div class="form-group">
                <label for="inheritance-money" data-translate-key="inheritance_money_label">টাকা:</label>
                <input type="number" id="inheritance-money" data-translate-key-placeholder="inheritance_money_placeholder">
            </div>
            <div class="form-group">
                <label for="inheritance-land-value" data-translate-key="inheritance_land_label">জমি:</label>
                <div class="input-wrapper">
                    <input type="number" id="inheritance-land-value" data-translate-key-placeholder="inheritance_land_placeholder">
                    <select id="inheritance-land-unit">
                        <option value="শতাংশ">শতাংশ</option>
                        <option value="কাঠা" selected>কাঠা</option>
                        <option value="বিঘা">বিঘা</option>
                        <option value="একর">একর</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="inheritance-other" data-translate-key="inheritance_other_label">অন্যান্য সম্পদ (টাকায়):</label>
                <input type="number" id="inheritance-other" data-translate-key-placeholder="inheritance_other_placeholder">
            </div>

            <hr class="divider" style="margin: 15px 0;">
            <label data-translate-key="inheritance_relatives_label">জীবিত আত্মীয়-স্বজন:</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; grid-gap: 10px;">
                <div class="form-group">
                    <label for="inheritance-wife" data-translate-key="inheritance_wife_label">স্ত্রী</label>
                    <input type="number" id="inheritance-wife" min="0" max="4" value="0">
                </div>
                <div class="form-group">
                    <label for="inheritance-husband" data-translate-key="inheritance_husband_label">স্বামী</label>
                    <input type="number" id="inheritance-husband" min="0" max="1" value="0">
                </div>
                <div class="form-group">
                    <label for="inheritance-father" data-translate-key="inheritance_father_label">পিতা</label>
                    <input type="number" id="inheritance-father" min="0" max="1" value="0">
                </div>
                <div class="form-group">
                    <label for="inheritance-mother" data-translate-key="inheritance_mother_label">মাতা</label>
                    <input type="number" id="inheritance-mother" min="0" max="1" value="0">
                </div>
                 <div class="form-group">
                    <label for="inheritance-sons" data-translate-key="inheritance_sons_label">ছেলে</label>
                    <input type="number" id="inheritance-sons" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="inheritance-daughters" data-translate-key="inheritance_daughters_label">মেয়ে</label>
                    <input type="number" id="inheritance-daughters" min="0" value="0">
                </div>
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetInheritanceTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('inheritance', calculateInheritance)" data-translate-key-revert="inheritance_calculate_btn"><i class="fas fa-calculator"></i> <span>অংশ হিসাব করুন</span></button>
            </div>
            <div class="result" id="inheritance-result"></div>
        </div>

        <div id="zakat" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_zakat_option">যাকাত ক্যালকুলেটর</h3>
                 <button class="info-button" onclick="showInfoModal('zakat')"><i class="fas fa-info-circle"></i></button>
            </div>
            <h4 data-translate-key="zakat_assets_header" style="margin-bottom: 15px;">যাকাতযোগ্য সম্পদ বিস্তারিত লিখুন:</h4>
            <div class="form-group">
                <label for="zakat-cash" data-translate-key="zakat_cash_label">নগদ টাকা ও ব্যাংক ব্যালেন্স:</label>
                <input type="number" id="zakat-cash" data-translate-key-placeholder="zakat_cash_placeholder">
            </div>
            <div class="form-group">
                <label data-translate-key="zakat_gold_label">স্বর্ণ:</label>
                <div class="input-wrapper">
                     <input type="number" id="zakat-gold-grams" data-translate-key-placeholder="zakat_grams_placeholder">
                     <input type="number" id="zakat-gold-rate" data-translate-key-placeholder="zakat_rate_placeholder">
                </div>
            </div>
             <div class="form-group">
                <label data-translate-key="zakat_silver_label">রৌপ্য:</label>
                <div class="input-wrapper">
                     <input type="number" id="zakat-silver-grams" data-translate-key-placeholder="zakat_grams_placeholder">
                     <input type="number" id="zakat-silver-rate" data-translate-key-placeholder="zakat_rate_placeholder">
                </div>
            </div>
            <div class="form-group">
                <label for="zakat-business" data-translate-key="zakat_business_label">ব্যবসার পণ্য (ক্রয়মূল্য):</label>
                <input type="number" id="zakat-business" data-translate-key-placeholder="zakat_cash_placeholder">
            </div>
            <div class="form-group">
                <label for="zakat-shares" data-translate-key="zakat_shares_label">শেয়ার ও বন্ড (বর্তমান বাজার মূল্য):</label>
                <input type="number" id="zakat-shares" data-translate-key-placeholder="zakat_cash_placeholder">
            </div>
            <hr class="divider" style="margin: 15px 0;">

            <div class="form-group">
                <label for="zakat-debt" data-translate-key="zakat_debt_label">ঋণের পরিমাণ:</label>
                <input type="number" id="zakat-debt" data-translate-key-placeholder="zakat_debt_placeholder">
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetZakatTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('zakat', calculateZakat)" data-translate-key-revert="zakat_calculate_btn"><i class="fas fa-hand-holding-usd"></i> <span>যাকাত নির্ণয় করুন</span></button>
            </div>
            <div class="result" id="zakat-result" style="text-align: left;"></div>
        </div>
        
        <div id="tax" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_tax_option">ট্যাক্স ক্যালকুলেটর</h3>
                 <button class="info-button" onclick="showInfoModal('tax')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="tax-income" data-translate-key="tax_income_label">বার্ষিক আয়:</label>
                <input type="number" id="tax-income" data-translate-key-placeholder="tax_income_placeholder">
            </div>
            <div class="form-group" id="tax-investment-container">
                <label for="tax-investment" data-translate-key="tax_investment_label">বিনিয়োগ:</label>
                <input type="number" id="tax-investment" data-translate-key-placeholder="tax_investment_placeholder">
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetTaxTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('tax', calculateTax)" data-translate-key-revert="tax_calculate_btn"><i class="fas fa-file-invoice-dollar"></i> <span>ট্যাক্স নির্ণয় করুন</span></button>
            </div>
            <div class="result" id="tax-result" style="text-align: center;">
                <div class="result-title" data-translate-key="tax_result_title">প্রদেয় ট্যাক্স:</div>
                <div id="tax-amount"></div>
                 <div style="margin-top: 10px; font-size: 0.8rem; opacity: 0.8;" data-translate-key="tax_disclaimer">
                    (এটি একটি আনুমানিক হিসাব। সর্বশেষ ট্যাক্স আইনের জন্য NBR ওয়েবসাইট দেখুন)
                </div>
            </div>
        </div>

        <div id="investment" class="tab-content">
            <div class="tab-content-header">
                <h3 data-translate-key="inv_title">বিনিয়োগ ক্যালকুলেটর</h3>
                 <button class="info-button" onclick="showInfoModal('investment')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="inv-type" data-translate-key="inv_type_label">হিসাবের ধরন:</label>
                <select id="inv-type" onchange="toggleInvestmentInputs()">
                    <option value="sip" data-translate-key="inv_type_sip">SIP</option>
                    <option value="compound" data-translate-key="inv_type_compound">চক্রবৃদ্ধি সুদ</option>
                </select>
            </div>
            <div class="form-group" id="inv-sip-amount-group">
                <label for="inv-sip-amount" data-translate-key="inv_sip_amount_label">মাসিক কিস্তি (টাকা):</label>
                <input type="number" id="inv-sip-amount" data-translate-key-placeholder="inv_sip_amount_placeholder">
            </div>
            <div class="form-group" id="inv-principal-group" style="display: none;">
                <label for="inv-principal" data-translate-key="inv_principal_label">মূলধন (টাকা):</label>
                <input type="number" id="inv-principal" data-translate-key-placeholder="inv_principal_placeholder">
            </div>
            <div class="form-group">
                <label for="inv-rate" data-translate-key="inv_rate_label">আনুমানিক বার্ষিক রিটার্ন (%):</label>
                <input type="number" id="inv-rate" data-translate-key-placeholder="inv_rate_placeholder">
            </div>
            <div class="form-group">
                <label data-translate-key="inv_years_label">মেয়াদ:</label>
                <div class="input-wrapper">
                    <input type="number" id="inv-years" placeholder="বছর">
                    <input type="number" id="inv-months" placeholder="মাস">
                </div>
            </div>
            <div class="button-group">
                 <button class="reset-button" onclick="resetInvestmentTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('investment', calculateInvestment)" data-translate-key-revert="inv_calculate_btn"><i class="fas fa-calculator"></i> <span>হিসাব করুন</span></button>
            </div>
            <div class="result" id="inv-result"></div>
        </div>
        
        <div id="paint-carpet" class="tab-content">
            <div class="tab-content-header">
                <h3 data-translate-key="pc_title">রং/কার্পেট ক্যালকুলেটর</h3>
                 <button class="info-button" onclick="showInfoModal('paint-carpet')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="pc-type" data-translate-key="pc_type_label">হিসাবের ধরন:</label>
                <select id="pc-type" onchange="togglePaintCarpetInputs()">
                    <option value="paint" data-translate-key="pc_type_paint">দেয়ালের রং</option>
                    <option value="carpet" data-translate-key="pc_type_carpet">মেঝের কার্পেট</option>
                </select>
            </div>
            <div class="form-group">
                <label data-translate-key="pc_dimensions_label">ঘরের মাপ (ফুট):</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <input type="number" id="pc-length" data-translate-key-placeholder="pc_length_placeholder">
                    <input type="number" id="pc-width" data-translate-key-placeholder="pc_width_placeholder">
                    <input type="number" id="pc-height" data-translate-key-placeholder="pc_height_placeholder">
                </div>
            </div>
            <div id="pc-paint-only-inputs">
                <div class="form-group">
                    <label data-translate-key="pc_exclusions_label">বাদ যাবে (দরজা/জানালা):</label>
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="pc-doors" value="0" data-translate-key-placeholder="pc_doors_placeholder">
                        <input type="number" id="pc-windows" value="0" data-translate-key-placeholder="pc_windows_placeholder">
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button class="reset-button" onclick="resetPaintCarpetTab()"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('paint-carpet', calculatePaintCarpet)" data-translate-key-revert="pc_calculate_btn"><i class="fas fa-calculator"></i> <span>হিসাব করুন</span></button>
            </div>
            <div class="result" id="pc-result" style="text-align: center;"></div>
        </div>

        <div id="construction" class="tab-content">
            <div class="tab-content-header">
                <h3 data-translate-key="tab_construction_option">নির্মাণ ক্যালকুলেটর</h3>
                 <button class="info-button" onclick="showInfoModal('construction')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="sub-tab-container">
                <button class="sub-tab active" onclick="openSubTab(event, 'all-in-one-calc')">সম্পূর্ণ হিসাব</button>
                <button class="sub-tab" onclick="openSubTab(event, 'bricks-calc')">ইট</button>
                <button class="sub-tab" onclick="openSubTab(event, 'plaster-calc')">প্লাস্টার</button>
                <button class="sub-tab" onclick="openSubTab(event, 'concrete-calc')">কংক্রিট</button>
                <button class="sub-tab" onclick="openSubTab(event, 'steel-calc')">স্টিল</button>
            </div>
            
            <div id="all-in-one-calc" class="sub-tab-content active">
                <h3 style="text-align: center; margin-bottom: 20px;">সম্পূর্ণ নির্মাণ হিসাব</h3>

                <h4 style="margin-bottom: 10px;">ইটের গাঁথুনির হিসাব</h4>
                <div class="form-group">
                    <label data-translate-key="con_wall_dim_label">দেয়ালের মাপ (ফুট):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="all-con-wall-length" data-translate-key-placeholder="con_length_placeholder">
                        <input type="number" id="all-con-wall-height" data-translate-key-placeholder="con_height_placeholder">
                    </div>
                </div>
                <div class="form-group">
                    <label for="all-con-wall-thickness" data-translate-key="con_thickness_label">দেয়ালের পুরুত্ব:</label>
                    <select id="all-con-wall-thickness">
                        <option value="5" data-translate-key="con_thickness_5">৫ ইঞ্চি</option>
                        <option value="10" data-translate-key="con_thickness_10">১০ ইঞ্চি</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="all-con-mortar-ratio" data-translate-key="con_mortar_ratio_label">গাঁথুনির মসলার অনুপাত:</label>
                    <select id="all-con-mortar-ratio">
                        <option value="1:4">1:4</option>
                        <option value="1:5" selected>1:5</option>
                        <option value="1:6">1:6</option>
                    </select>
                </div>
                <hr class="divider">

                <h4 style="margin-bottom: 10px;">প্লাস্টারের হিসাব</h4>
                 <div class="form-group">
                    <label>প্লাস্টারের দেয়ালের মাপ (ফুট):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="all-plaster-wall-length" placeholder="দৈর্ঘ্য">
                        <input type="number" id="all-plaster-wall-height" placeholder="উচ্চতা">
                    </div>
                </div>
                <div class="form-group">
                    <label for="all-plaster-thickness">প্লাস্টারের পুরুত্ব (মিমি):</label>
                    <input type="number" id="all-plaster-thickness" value="12">
                </div>
                <div class="form-group">
                    <label for="all-plaster-mortar-ratio">প্লাস্টারের মসলার অনুপাত:</label>
                    <select id="all-plaster-mortar-ratio">
                        <option value="1:4">1:4</option>
                        <option value="1:5">1:5</option>
                        <option value="1:6" selected>1:6</option>
                    </select>
                </div>
                <hr class="divider">

                <h4 style="margin-bottom: 10px;">কংক্রিটের হিসাব</h4>
                <div class="form-group">
                    <label for="all-concrete-type">কিসের জন্য হিসাব করবেন?</label>
                    <select id="all-concrete-type">
                        <option value="slab">ছাদ (Slab)</option>
                        <option value="beam">বিম (Beam)</option>
                        <option value="column">কলাম (Column)</option>
                        <option value="footing">ভিত্তি (Footing)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>মাপ (ফুট):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="number" id="all-concrete-length" placeholder="দৈর্ঘ্য">
                        <input type="number" id="all-concrete-width" placeholder="প্রস্থ">
                        <input type="number" id="all-concrete-height" placeholder="উচ্চতা/পুরুত্ব">
                    </div>
                </div>
                 <div class="form-group">
                    <label for="all-concrete-mix-ratio">কংক্রিটের অনুপাত:</label>
                    <select id="all-concrete-mix-ratio">
                        <option value="1:2:4" selected>1:2:4</option>
                        <option value="1:1.5:3">1:1.5:3</option>
                        <option value="1:3:6">1:3:6</option>
                    </select>
                </div>
                <hr class="divider">

                <h4 style="margin-bottom: 10px;">স্টিল (রড) এর হিসাব</h4>
                <div class="form-group">
                    <label for="all-steel-element-type">কিসের জন্য হিসাব করবেন? (কংক্রিটের পরিমাণের উপর ভিত্তি করে)</label>
                    <select id="all-steel-element-type">
                        <option value="slab">ছাদ (Slab)</option>
                        <option value="beam">বিম (Beam)</option>
                        <option value="column">কলাম (Column)</option>
                        <option value="footing">ভিত্তি (Footing)</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="reset-button" onclick="resetConstructionTab('all-in-one')"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                    <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('construction', calculateAllConstruction)" data-translate-key-revert="con_calculate_btn" style="margin-top:0;"><i class="fas fa-calculator"></i> <span>হিসাব করুন</span></button>
                </div>
                <div class="result" id="con-all-in-one-result"></div>
            </div>

            <div id="bricks-calc" class="sub-tab-content">
                <h3 style="text-align: center; margin-bottom: 20px;" data-translate-key="con_title">ইটের গাঁথুনির হিসাব</h3>
                <div class="form-group">
                    <label data-translate-key="con_wall_dim_label">দেয়ালের মাপ (ফুট):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="con-wall-length" data-translate-key-placeholder="con_length_placeholder">
                        <input type="number" id="con-wall-height" data-translate-key-placeholder="con_height_placeholder">
                    </div>
                </div>
                <div class="form-group">
                    <label for="con-wall-thickness" data-translate-key="con_thickness_label">দেয়ালের পুরুত্ব:</label>
                    <select id="con-wall-thickness">
                        <option value="5" data-translate-key="con_thickness_5">৫ ইঞ্চি</option>
                        <option value="10" data-translate-key="con_thickness_10">১০ ইঞ্চি</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="con-mortar-ratio" data-translate-key="con_mortar_ratio_label">মসলার অনুপাত (সিমেন্ট:বালি):</label>
                    <select id="con-mortar-ratio">
                        <option value="1:4">1:4</option>
                        <option value="1:5" selected>1:5</option>
                        <option value="1:6">1:6</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="reset-button" onclick="resetConstructionTab('bricks')"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                    <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('construction', () => calculateConstruction('bricks'))" data-translate-key-revert="con_calculate_btn" style="margin-top:0;"><i class="fas fa-calculator"></i> <span>হিসাব করুন</span></button>
                </div>
                <div class="result" id="con-bricks-result"></div>
            </div>

            <div id="plaster-calc" class="sub-tab-content">
                 <h3 style="text-align: center; margin-bottom: 20px;">প্লাস্টারের হিসাব</h3>
                 <div class="form-group">
                    <label>দেয়ালের মাপ (ফুট):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="plaster-wall-length" placeholder="দৈর্ঘ্য">
                        <input type="number" id="plaster-wall-height" placeholder="উচ্চতা">
                    </div>
                </div>
                <div class="form-group">
                    <label for="plaster-thickness">প্লাস্টারের পুরুত্ব (মিমি):</label>
                    <input type="number" id="plaster-thickness" value="12">
                </div>
                <div class="form-group">
                    <label for="plaster-mortar-ratio">মসলার অনুপাত (সিমেন্ট:বালি):</label>
                    <select id="plaster-mortar-ratio">
                        <option value="1:4">1:4</option>
                        <option value="1:5">1:5</option>
                        <option value="1:6" selected>1:6</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="reset-button" onclick="resetConstructionTab('plaster')"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                    <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('construction', () => calculateConstruction('plaster'))" data-translate-key-revert="con_calculate_btn" style="margin-top:0;"><i class="fas fa-calculator"></i> হিসাব করুন</button>
                </div>
                <div class="result" id="con-plaster-result"></div>
            </div>

            <div id="concrete-calc" class="sub-tab-content">
                <h3 style="text-align: center; margin-bottom: 20px;">কংক্রিটের হিসাব</h3>
                <div class="form-group">
                    <label for="concrete-type">কিসের জন্য হিসাব করবেন?</label>
                    <select id="concrete-type">
                        <option value="slab">ছাদ (Slab)</option>
                        <option value="beam">বিম (Beam)</option>
                        <option value="column">কলাম (Column)</option>
                        <option value="footing">ভিত্তি (Footing)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label> মাপ (ফুট):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="number" id="concrete-length" placeholder="দৈর্ঘ্য">
                        <input type="number" id="concrete-width" placeholder="প্রস্থ">
                        <input type="number" id="concrete-height" placeholder="উচ্চতা/পুরুত্ব">
                    </div>
                </div>
                 <div class="form-group">
                    <label for="concrete-mix-ratio">কংক্রিটের অনুপাত:</label>
                    <select id="concrete-mix-ratio">
                        <option value="1:2:4" selected>1:2:4</option>
                        <option value="1:1.5:3">1:1.5:3</option>
                        <option value="1:3:6">1:3:6</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="reset-button" onclick="resetConstructionTab('concrete')"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                    <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('construction', () => calculateConstruction('concrete'))" data-translate-key-revert="con_calculate_btn" style="margin-top:0;"><i class="fas fa-calculator"></i> হিসাব করুন</button>
                </div>
                <div class="result" id="con-concrete-result"></div>
            </div>
            
            <div id="steel-calc" class="sub-tab-content">
                <h3 style="text-align: center; margin-bottom: 20px;">স্টিল (রড) এর হিসাব</h3>
                <div class="form-group">
                    <label for="steel-concrete-volume">কংক্রিটের পরিমাণ (ঘনফুট - cft):</label>
                    <input type="number" id="steel-concrete-volume" placeholder="কংক্রিটের মোট পরিমাণ লিখুন">
                </div>
                <div class="form-group">
                    <label for="steel-element-type">কিসের জন্য হিসাব করবেন?</label>
                    <select id="steel-element-type">
                        <option value="slab">ছাদ (Slab)</option>
                        <option value="beam">বিম (Beam)</option>
                        <option value="column">কলাম (Column)</option>
                        <option value="footing">ভিত্তি (Footing)</option>
                    </select>
                </div>
                 <div class="button-group">
                    <button class="reset-button" onclick="resetConstructionTab('steel')"><i class="fas fa-sync-alt"></i> <span data-translate-key="price_reset_btn">রিসেট</span></button>
                    <button class="calculate-button premium-calculate-btn" onclick="handlePremiumCalculation('construction', () => calculateConstruction('steel'))" data-translate-key-revert="con_calculate_btn" style="margin-top:0;"><i class="fas fa-calculator"></i> হিসাব করুন</button>
                </div>
                 <div class="result" id="con-steel-result"></div>
                <div class="disclaimer" style="margin-top: 15px;">
                    <strong>দ্রষ্টব্য:</strong> এটি একটি আনুমানিক হিসাব (থাম্ব রুল)। সঠিক হিসাবের জন্য অবশ্যই ইঞ্জিনিয়ারিং ডিজাইন অনুসরণ করুন।
                </div>
            </div>
        </div>


        <div id="converter" class="tab-content">
             <div class="tab-content-header">
                <h3 data-translate-key="tab_converter_option">একক রূপান্তরকারী</h3>
                 <button class="info-button" onclick="showInfoModal('converter')"><i class="fas fa-info-circle"></i></button>
            </div>
            <div class="form-group">
                <label for="converter-category" data-translate-key="converter_category_label">রূপান্তর ক্যাটাগরি:</label>
                <select id="converter-category" onchange="changeConverter()">
                    <option value="length" data-translate-key="converter_cat_length">দৈর্ঘ্য</option>
                    <option value="area" data-translate-key="converter_cat_area">ক্ষেত্রফল</option>
                    <option value="weight" data-translate-key="converter_cat_weight">ওজন</option>
                    <option value="volume" data-translate-key="converter_cat_volume">আয়তন</option>
                    <option value="temperature" data-translate-key="converter_cat_temp">তাপমাত্রা</option>
                </select>
            </div>
            <div class="unit-converter" style="display: flex; gap: 20px;">
                 <div style="flex:1;">
                    <label for="converter-from-unit" data-translate-key="converter_from_label">থেকে:</label>
                    <select id="converter-from-unit"></select>
                    <input type="number" id="converter-from-value" oninput="convertUnits()" style="margin-top:10px;" data-translate-key-placeholder="converter_from_placeholder">
                </div>
                 <div style="flex:1;">
                    <label for="converter-to-unit" data-translate-key="converter_to_label">এ:</label>
                    <select id="converter-to-unit"></select>
                    <input type="text" id="converter-to-value" readonly style="margin-top:10px;">
                </div>
            </div>
        </div>
    </div>

    <div id="announcement-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">গুরুত্বপূর্ণ ঘোষণা</h3>
            <p id="modal-body"></p>
            <button class="cancel-button" onclick="closeModal('announcement-modal')">বন্ধ করুন</button>
        </div>
    </div>
    
    <div id="info-modal" class="modal-overlay">
        <div class="modal-content">
             <button class="modal-close" onclick="closeModal('info-modal')">&times;</button>
            <h3 id="info-modal-title" data-translate-key="info_modal_title">তথ্য</h3>
            <p id="info-modal-body"></p>
        </div>
    </div>

    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('share-modal')">&times;</button>
            <h3 data-translate-key="share_modal_title">অ্যাপ শেয়ার করুন</h3>
            <p data-translate-key="share_modal_desc" style="text-align:center;">নিচের লিংকটি কপি করে বন্ধুদের সাথে শেয়ার করুন।</p>
            <div class="input-wrapper" style="margin-top: 15px;">
                <input type="text" id="share-link-input" readonly>
                <button id="copy-share-link-btn" onclick="copyShareLink(this)" data-translate-key="share_modal_copy_btn">কপি</button>
            </div>
        </div>
    </div>
    
    <div id="image-viewer-modal" class="image-viewer-overlay">
        <button class="image-viewer-close" onclick="closeImageViewer()">&times;</button>
        <img id="image-viewer-content" src="" alt="Full View">
    </div>

    <div id="login-page" class="full-page-overlay">
    </div>
    
    <div id="calc-history-page" class="full-page-overlay">
    </div>
    
    <div id="privacy-page" class="full-page-overlay">
    </div>
    
    <div id="password-recovery-page" class="full-page-overlay">
    </div>

    <div id="password-change-page" class="full-page-overlay">
    </div>

    <div id="help-support-page" class="full-page-overlay">
    </div>

    <div id="review-page" class="full-page-overlay">
    </div>
    
    <div id="other-apps-page" class="full-page-overlay">
    </div>

    <div id="toast-notification"></div>

    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js" onload="initializeFirebaseFeatures()"></script>

    <script>
        
        // Set to true by default to unlock all features
        let isPremiumUser = true;
        let currentAnnouncementMessage = '';
        let appSettings = {};
        let tabInfoContent = {};
        let memoryValue = 0; 
        
        let electricityRates = {
            slabs: [
                { limit: 75, rate: 4.63 },
                { limit: 200, rate: 5.26 },
                { limit: 300, rate: 5.61 },
                { limit: 400, rate: 5.93 },
                { limit: 600, rate: 12.67 },
                { limit: Infinity, rate: 14.61 }
            ]
        };
        let taxSettings = {
            taxFreeLimit: 350000,
            slabs: [
                { amount: 100000, rate: 0.05 },
                { amount: 300000, rate: 0.10 },
                { amount: 400000, rate: 0.15 },
                { amount: 500000, rate: 0.20 },
                { amount: Infinity, rate: 0.25 }
            ]
        };
        let calculatorSettings = {};
        let tabAccessSettings = {}; 
        
        const translations = {
            'bn': {
                appName: 'ক্যালকুলেটর মাস্টার প্রো',
                menu_theme: 'থিম পরিবর্তন',
                menu_share: 'শেয়ার',
                menu_history: 'হিসাব হিস্টেরি',
                tab_basic: 'সাধারণ',
                tab_price: 'মূল্য হিসেব',
                tab_age: 'বয়স',
                tab_health: 'স্বাস্থ্য',
                tab_discount: 'ডিসকাউন্ট',
                tab_bengali_date: 'বাংলা তারিখ',
                tab_electricity: 'বিদ্যুৎ',
                tab_land: 'জমি',
                tab_inheritance: 'উত্তরাধিকার',
                tab_zakat: 'যাকাত',
                tab_tax: 'ট্যাক্স',
                tab_investment: 'বিনিয়োগ',
                tab_paint_carpet: 'রং/কার্পেট',
                tab_construction: 'নির্মাণ',
                tab_converter: 'রূপান্তর',
                tab_fishing: 'মাছ ধরা',
                tab_farming: 'খামার',
                all_tabs: 'সব',
                tab_basic_option: 'সাধারণ',
                tab_price_option: 'মূল্য হিসেব',
                tab_age_option: 'বয়স',
                tab_health_option: 'স্বাস্থ্য',
                tab_discount_option: 'ডিসকাউন্ট',
                tab_bengali_date_option: 'বাংলা তারিখ',
                tab_electricity_option: 'বিদ্যুৎ',
                tab_land_option: 'জমি',
                tab_inheritance_option: 'উত্তরাধিকার',
                tab_zakat_option: 'যাকাত',
                tab_tax_option: 'ট্যাক্স',
                tab_investment_option: 'বিনিয়োগ',
                tab_paint_carpet_option: 'রং/কার্পেট',
                tab_construction_option: 'নির্মাণ',
                tab_converter_option: 'রূপান্তর',
                tab_fishing_option: 'মাছ ধরা',
                tab_farming_option: 'খামার',
                price_ref_title: 'পণ্যের রেফারেন্স মূল্য',
                price_ref_label: 'পণ্যের দাম ও ওজন লিখুন',
                price_ref_amount_placeholder: 'টাকা',
                price_ref_weight_placeholder: 'ওজন',
                unit_gram: 'গ্রাম',
                unit_kg: 'কেজি',
                price_target_label: 'কতটুকু কিনবেন?',
                price_target_weight_placeholder: 'ওজন',
                unit_gram_2: 'গ্রাম',
                unit_kg_2: 'কেজি',
                price_budget_label: 'কত টাকার কিনবেন?',
                price_budget_placeholder: 'আপনার বাজেট লিখুন',
                price_calculate_btn_main: 'হিসাব করুন',
                price_reset_btn: 'রিসেট',
                price_result_title: 'মোট মূল্য: <strong>${finalPrice} টাকা</strong>',
                price_quantity_result_title: 'আপনি পাবেন: <br><strong>${quantityGrams} গ্রাম</strong> <br>অথবা <strong>${quantityKg} কেজি</strong>',
                price_invalid_input: 'অনুগ্রহ করে রেফারেন্স মূল্য এবং হিসাবের জন্য পরিমাণ অথবা টাকা সঠিকভাবে লিখুন।',
                age_label: 'আপনার জন্ম তারিখ লিখুন:',
                age_calculate_btn: 'বয়স হিসাব করুন',
                health_age_label: 'বয়স (বছর):',
                health_age_placeholder: 'আপনার বয়স লিখুন',
                health_gender_label: 'লিঙ্গ:',
                gender_male: 'পুরুষ',
                gender_female: 'মহিলা',
                health_height_label: 'উচ্চতা:',
                height_ft_placeholder: 'ফুট',
                height_in_placeholder: 'ইঞ্চি',
                health_weight_label: 'ওজন (কেজি):',
                health_weight_placeholder: 'আপনার ওজন কেজি-তে লিখুন',
                health_calories_label: 'আপনার দৈনিক ক্যালোরি গ্রহণের পরিমাণ:',
                health_calories_placeholder: 'যেমন: 2200',
                health_calculate_btn: 'হিসাব করুন',
                discount_price_label: 'পণ্যের আসল মূল্য:',
                discount_price_placeholder: 'যেমন: 1200',
                discount_percentage_label: 'ছাড়ের হার (%):',
                discount_percentage_placeholder: 'যেমন: 20',
                discount_calculate_btn: 'হিসাব করুন',
                bengali_date_label: 'ইংরেজি তারিখ নির্বাচন করুন:',
                bengali_date_calculate_btn: 'রূপান্তর করুন',
                elec_title: 'আবাসিক বিদ্যুৎ বিল হিসাব',
                elec_prev_label: 'পূর্ববর্তী মাসের রিডিং (Unit):',
                elec_prev_placeholder: 'যেমন: 1500',
                elec_current_label: 'বর্তমান মাসের রিডিং (Unit):',
                elec_current_placeholder: 'যেমন: 1650',
                elec_calculate_btn: 'বিল হিসাব করুন',
                elec_disclaimer: '<strong>দ্রষ্টব্য:</strong> এটি একটি আনুমানিক হিসাব। বিদ্যুতের মূল্যহার পরিবর্তনশীল।',
                land_length_label: 'দৈর্ঘ্য (ফুট):',
                land_length_placeholder: 'ফুট এ দৈর্ঘ্য লিখুন',
                land_width_label: 'প্রস্থ (ফুট):',
                land_width_placeholder: 'ফুট এ প্রস্থ লিখুন',
                land_unit_label: 'একক:',
                land_unit_sqft: 'বর্গফুট',
                land_unit_sqm: 'বর্গমিটার',
                land_unit_katha: 'কাঠা',
                land_unit_bigha: 'বিঘা',
                land_unit_acre: 'একর',
                land_unit_hectare: 'হেক্টর',
                land_calculate_btn: 'পরিমাপ নির্ণয় করুন',
                land_result_title: 'ফলাফল:',
                inheritance_property_label: 'মোট সম্পত্তি:',
                inheritance_money_label: 'টাকা:',
                inheritance_money_placeholder: 'মোট টাকার পরিমাণ',
                inheritance_land_label: 'জমি:',
                inheritance_land_placeholder: 'জমির পরিমাণ',
                inheritance_other_label: 'অন্যান্য সম্পদ (টাকায়):',
                inheritance_other_placeholder: 'অন্যান্য সম্পদের আনুমানিক মূল্য',
                inheritance_relatives_label: 'জীবিত আত্মীয়-স্বজন:',
                inheritance_wife_label: 'স্ত্রী',
                inheritance_husband_label: 'স্বামী',
                inheritance_father_label: 'পিতা',
                inheritance_mother_label: 'মাতা',
                inheritance_sons_label: 'ছেলে',
                inheritance_daughters_label: 'মেয়ে',
                inheritance_calculate_btn: 'অংশ হিসাব করুন',
                inheritance_error_no_property: "অনুগ্রহ করে অন্তত একটি সম্পত্তির পরিমাণ লিখুন।",
                inheritance_error_spouse: "একই সাথে স্ত্রী এবং স্বামী জীবিত থাকতে পারে না।",
                inheritance_result_title: "<strong><u>উত্তরাধিকার বন্টন:</u></strong>",
                inheritance_result_husband: "স্বামী",
                inheritance_result_wife: "স্ত্রী",
                inheritance_result_father: "পিতা",
                inheritance_result_mother: "মাতা",
                inheritance_result_each_son: "প্রত্যেক ছেলে",
                inheritance_result_each_daughter: "প্রত্যেক মেয়ে",
                inheritance_result_gets: "পাবেন:",
                inheritance_result_total: "মোট",
                inheritance_result_jointly: "একত্রে",
                inheritance_no_heirs: 'অনুগ্রহ করে জীবিত আত্মীয়-স্বজনের সংখ্যা লিখুন।',
                zakat_debt_label: 'ঋণের পরিমাণ:',
                zakat_debt_placeholder: 'পরিশোধযোগ্য ঋণের পরিমাণ',
                zakat_calculate_btn: 'যাকাত নির্ণয় করুন',
                zakat_result_title: 'যাকাতের পরিমাণ:',
                zakat_assets_header: 'যাকাতযোগ্য সম্পদ বিস্তারিত লিখুন:',
                zakat_cash_label: 'নগদ টাকা ও ব্যাংক ব্যালেন্স:',
                zakat_cash_placeholder: 'টাকার পরিমাণ',
                zakat_gold_label: 'স্বর্ণ:',
                zakat_silver_label: 'রৌপ্য:',
                zakat_grams_placeholder: 'গ্রাম',
                zakat_rate_placeholder: 'প্রতি গ্রামের বর্তমান বাজারদর',
                zakat_business_label: 'ব্যবসার পণ্য (ক্রয়মূল্য):',
                zakat_shares_label: 'শেয়ার ও বন্ড (বর্তমান বাজার মূল্য):',
                zakat_result_total_assets: 'মোট সম্পদ:',
                zakat_result_total_debt: 'মোট ঋণ:',
                zakat_result_net_assets: ' যাকাতযোগ্য সম্পদ:',
                zakat_result_payable: 'প্রদেয় যাকাত (২.৫%):',
                zakat_not_applicable: 'আপনার মোট যাকাতযোগ্য সম্পদ নিসাব পরিমাণের কম।',
                zakat_invalid_input: 'অনুগ্রহ করে কমপক্ষে একটি সম্পদের পরিমাণ লিখুন।',
                tax_income_label: 'বার্ষিক আয়:',
                tax_income_placeholder: 'আপনার বার্ষিক আয় লিখুন',
                tax_investment_label: 'বিনিয়োগ:',
                tax_investment_placeholder: 'কর রেয়াতযোগ্য বিনিয়োগ',
                tax_calculate_btn: 'ট্যাক্স নির্ণয় করুন',
                tax_result_title: 'প্রদেয় ট্যাক্স:',
                tax_disclaimer: '(এটি একটি আনুমানিক হিসাব। সর্বশেষ ট্যাক্স আইনের জন্য NBR ওয়েবসাইট দেখুন)',
                converter_category_label: 'রূপান্তর ক্যাটাগরি:',
                converter_cat_length: 'দৈর্ঘ্য',
                converter_cat_area: 'ক্ষেত্রফল',
                converter_cat_weight: 'ওজন',
                converter_cat_volume: 'আয়তন',
                converter_cat_temp: 'তাপমাত্রা',
                converter_from_label: 'থেকে:',
                converter_from_placeholder: 'মান লিখুন',
                converter_to_label: 'এ:',
                age_result_text: 'আপনার বয়স: <strong>${years} বছর, ${months} মাস, ${days} দিন</strong>',
                birth_date_invalid: 'অনুগ্রহ করে আপনার জন্ম তারিখ দিন।',
                birth_date_future: 'জন্ম তারিখ ভবিষ্যতের হতে পারে না।',
                health_invalid_input: 'অনুগ্রহ করে বয়স, উচ্চতা এবং ওজনের সঠিক তথ্য পূরণ করুন।',
                bmi_category_underweight: 'কম ওজন',
                bmi_category_normal: 'স্বাভাবিক ওজন',
                bmi_category_overweight: 'অতিরিক্ত ওজন',
                bmi_category_obese: 'স্থূলতা',
                bmr_result_text: '<strong>বিএমআর (BMR): ${bmr} ক্যালোরি/দিন</strong> <small>(দৈনিক ন্যূনতম প্রয়োজনীয় ক্যালোরি)</small>',
                weight_gain_needed: 'স্বাভাবিক ওজনে (BMI 18.5) পৌঁছাতে আপনার প্রায় <strong>${weightToGain} কেজি</strong> ওজন বাড়ানো প্রয়োজন।<br>',
                days_to_goal: '<br>আপনার প্রদত্ত ${dailyCalories} ক্যালোরি গ্রহণ অনুযায়ী, লক্ষ্যে পৌঁছাতে আনুমানিক <strong>${days} দিন</strong> সময় লাগতে পারে।',
                calorie_intake_warning: '<br><span style="color:var(--warning-color);">ওজন বাড়ানোর জন্য, আপনার দৈনিক ক্যালোরি গ্রহণ আপনার BMR (${bmr}) এর চেয়ে বেশি হতে হবে।</span>',
                discount_invalid_input: 'অনুগ্রহ করে পণ্যের মূল্য এবং ছাড়ের হার লিখুন।',
                discount_result_text: 'ছাড়ের পর মূল্য: <strong>${finalPrice} টাকা</strong><br>আপনি সাশ্রয় করছেন: <strong>${savedAmount} টাকা</strong>',
                bengali_date_invalid_input: 'অনুগ্রহ করে একটি সঠিক ইংরেজি তারিখ নির্বাচন করুন।',
                bengali_date_result_text: 'বাংলা তারিখ: <br><strong>${bengaliDate} ${bengaliMonth}, ${bengaliYear} বঙ্গাব্দ</strong><br><span style="font-size: 1.1rem; color: var(--accent-color);">${tithiText}</span>',
                elec_invalid_input: 'অনুগ্রহ করে সকল তথ্য পূরণ করুন। বর্তমান রিডিং পূর্ববর্তী রিডিং থেকে বেশি হতে হবে।',
                elec_result_summary: 'মোট ব্যবহৃত ইউনিট: <strong>${units}</strong>',
                elec_result_step1: 'প্রথম ধাপ (০০-${limit}): ${units} ইউনিট x ${rate} = ${cost} টাকা',
                elec_result_step2: 'দ্বিতীয় ধাপ (${prev_limit}-${limit}): ${units} ইউনিট x ${rate} = ${cost} টাকা',
                elec_result_step3: 'তৃতীয় ধাপ (${prev_limit}-${limit}): ${units} ইউনিট x ${rate} = ${cost} টাকা',
                elec_result_step4: 'চতুর্থ ধাপ (${prev_limit}-${limit}): ${units} ইউনিট x ${rate} = ${cost} টাকা',
                elec_result_step5: 'পঞ্চম ধাপ (${prev_limit}-${limit}): ${units} ইউনিট x ${rate} = ${cost} টাকা',
                elec_result_step6: 'ষষ্ঠ ধাপ (${prev_limit}+): ${units} ইউনিট x ${rate} = ${cost} টাকা',
                elec_result_total: 'মোট বিল: ${bill} টাকা',
                fishing_earnings_label: 'মাছ বিক্রি করে মোট আয়:',
                fishing_earnings_placeholder: 'যেমন: 50000',
                fishing_expenses_label: 'ট্রলার ও অন্যান্য খরচ:',
                fishing_expenses_placeholder: 'যেমন: 10000',
                fishing_crew_label: 'সাধারণ জেলে:',
                fishing_majhi_label: 'মাঝি:',
                fishing_baburchi_label: 'বাবুর্চি:',
                fishing_majhi_share_label: 'মাঝির ভাগ:',
                fishing_baburchi_share_label: 'বাবুর্চি ভাগ:',
                fishing_crew_share_label: 'জেলের ভাগ:',
                fishing_owner_share_label: 'ট্রলার মালিকের ভাগ (%):',
                fishing_owner_share_placeholder: 'যেমন: 40',
                fishing_advance_details_label: 'জেলেদের নাম ও ব্যক্তিগত অগ্রিম:',
                fishing_calculate_btn: 'হিসাব করুন',
                lock_inputs_btn: 'লক',
                unlock_inputs_btn: 'আনলক',
                fishing_invalid_input: 'অনুগ্রহ করে সকল সঠিক তথ্য পূরণ করুন। আয় খরচের চেয়ে বেশি হতে হবে।',
                fishing_result_summary_title: '<strong><u>হিসাবের সারসংক্ষেপ:</u></strong>',
                fishing_result_net_earnings: 'খরচ বাদ দিয়ে মোট আয়: <strong>${netEarnings} টাকা</strong>',
                fishing_result_owner_share: 'ট্রলার মালিক পাবেন: <strong>${ownerShare} টাকা</strong>',
                fishing_result_crew_total: 'জেলেদের জন্য অবশিষ্ট: <strong>${crewTotal} টাকা</strong>',
                fishing_result_share_value: 'প্রতি ১ ভাগের মূল্য: <strong>${shareValue} টাকা</strong>',
                fishing_result_distribution_title: '<br><strong><u>ব্যক্তিগত ভাগের হিসাব:</u></strong>',
                fishing_result_person_share: '<strong>${name}</strong> (${shareCount} ভাগ): ${share} - ${advance} = <strong>${final} টাকা</strong>',
                menu_help: 'আপনার আইডিয়া দিন',
                menu_update: 'অ্যাপস আপডেট',
                lang_bn: 'বাংলা',
                lang_en: 'English',
                lang_hi: 'हिन्दी',
                pc_title: 'রং/কার্পেট ক্যালকুলেটর',
                pc_type_label: 'হিসাবের ধরন:',
                pc_type_paint: 'দেয়ালের রং',
                pc_type_carpet: 'মেঝের কার্পেট',
                pc_dimensions_label: 'ঘরের মাপ (ফুট):',
                pc_length_placeholder: 'দৈর্ঘ্য',
                pc_width_placeholder: 'প্রস্থ',
                pc_height_placeholder: 'উচ্চতা',
                pc_exclusions_label: 'বাদ যাবে (দরজা/জানালা):',
                pc_doors_placeholder: 'দরজা সংখ্যা',
                pc_windows_placeholder: 'জানালা সংখ্যা',
                pc_calculate_btn: 'হিসাব করুন',
                pc_paint_result: 'মোট দেয়ালের ক্ষেত্রফল: <strong>${area} বর্গফুট</strong><br>আনুমানিক রং লাগবে: <strong>${paint} লিটার</strong> (এক কোট)',
                pc_carpet_result: 'মেঝের ক্ষেত্রফল: <strong>${area} বর্গফুট</strong><br>কার্পেট লাগবে: <strong>${area} বর্গফুট</strong>',
                pc_invalid_input: 'অনুগ্রহ করে ঘরের সঠিক মাপ লিখুন।',
                inv_title: 'বিনিয়োগ ক্যালকুলেটর',
                inv_type_label: 'হিসাবের ধরন:',
                inv_type_sip: 'SIP',
                inv_type_compound: 'চক্রবৃদ্ধি সুদ',
                inv_sip_amount_label: 'মাসিক কিস্তি (টাকা):',
                inv_sip_amount_placeholder: 'যেমন: 5000',
                inv_principal_label: 'মূলধন (টাকা):',
                inv_principal_placeholder: 'যেমন: 100000',
                inv_rate_label: 'আনুমানিক বার্ষিক রিটার্ন (%):',
                inv_rate_placeholder: 'যেমন: 12',
                inv_years_label: 'মেয়াদ:',
                inv_years_placeholder: 'যেমন: 10',
                inv_calculate_btn: 'হিসাব করুন',
                inv_result: 'মোট বিনিয়োগ: <strong>${invested} টাকা</strong><br>জমাকৃত অর্থ: <strong>${returns} টাকা</strong><br>মোট মূল্য: <strong>${total} টাকা</strong>',
                inv_invalid_input: 'অনুগ্রহ করে সকল তথ্য সঠিকভাবে পূরণ করুন।',
                con_title: 'ইটের গাঁথুনির হিসাব',
                con_wall_dim_label: 'দেয়ালের মাপ (ফুট):',
                con_length_placeholder: 'দৈর্ঘ্য',
                con_height_placeholder: 'উচ্চতা',
                con_thickness_label: 'দেয়ালের পুরুত্ব:',
                con_thickness_5: '৫ ইঞ্চি',
                con_thickness_10: '১০ ইঞ্চি',
                con_mortar_ratio_label: 'মসলার অনুপাত (সিমেন্ট:বালি):',
                con_calculate_btn: 'হিসাব করুন',
                con_bricks_result: 'মোট ইট লাগবে: <strong>${bricks} টি</strong><br>সিমেন্ট লাগবে: <strong>${cement} ব্যাগ</strong><br>বালি লাগবে: <strong>${sand} CFT</strong>',
                con_plaster_result: 'সিমেন্ট লাগবে: <strong>${cement} ব্যাগ</strong><br>বালি লাগবে: <strong>${sand} CFT</strong>',
                con_concrete_result: 'সিমেন্ট লাগবে: <strong>${cement} ব্যাগ</strong><br>বালি লাগবে: <strong>${sand} CFT</strong><br>খোয়া লাগবে: <strong>${aggregate} CFT</strong>',
                con_steel_result: 'মোট স্টিল লাগবে: <strong>${steel} কেজি</strong>',
                con_invalid_input: 'অনুগ্রহ করে সঠিক মাপ লিখুন।',
                copied_to_clipboard: 'কপি হয়েছে!',
                share_app_text: 'এই অসাধারণ ক্যালকুলেটর অ্যাপটি ব্যবহার করে দেখুন!',
                exit_confirmation: 'আপনি কি অ্যাপ থেকে বের হয়ে যেতে চান?',
                calculation_history_title: 'হিসাবের হিস্টেরি',
                clear_history_btn: 'হিস্টোরি মুছুন',
                no_calc_history_msg: 'কোনো হিসাবের হিস্টেরি পাওয়া যায়নি।',
                calculator_type: 'ক্যালকুলেটরের ধরন',
                inputs: 'ইনপুট',
                result: 'ফলাফল',
                share_modal_title: 'অ্যাপ শেয়ার করুন',
                share_modal_desc: 'নিচের লিংকটি কপি করে বন্ধুদের সাথে শেয়ার করুন।',
                share_modal_copy_btn: 'কপি',
                info_modal_title: 'তথ্য',
                farming_initial_costs_label: 'প্রাথমিক খরচ:',
                farming_chick_count_placeholder: 'মুরগির বাচ্চার সংখ্যা',
                farming_chick_price_placeholder: 'প্রতি বাচ্চার দাম',
                farming_running_costs_label: 'চলমান খরচ:',
                farming_feed_cost_placeholder: 'মোট খাদ্য খরচ',
                farming_medicine_cost_placeholder: 'ঔষধ ও ভ্যাকসিন খরচ',
                farming_other_cost_placeholder: 'অন্যান্য খরচ (বিদ্যুৎ, কর্মচারী)',
                farming_other_info_label: 'অন্যান্য তথ্য:',
                farming_mortality_placeholder: 'মৃত মুরগির সংখ্যা',
                farming_duration_placeholder: 'পালনের সময় (মাস)',
                farming_sales_label: 'বিক্রির বিবরণ:',
                farming_add_one_sale_btn: 'একটি সারি যোগ করুন',
                farming_calculate_btn: 'হিসাব করুন',
                farming_invalid_input: 'অনুগ্রহ করে সকল সঠিক তথ্য পূরণ করুন।',
                farming_result_title: 'খামারের হিসাবের সারসংক্ষেপ',
                farming_total_chicks: 'মোট বাচ্চা:',
                farming_total_investment: 'মোট বিনিয়োগ:',
                farming_chick_cost: 'বাচ্চার খরচ:',
                farming_total_running_cost: 'মোট চলমান খরচ:',
                farming_total_sale: 'মোট বিক্রি:',
                farming_avg_weight: 'গড় ওজন:',
                farming_alive_chicks: 'জীবিত মুরগি:',
                farming_production_cost_per_chick: 'প্রতি মুরগির উৎপাদন খরচ:',
                farming_production_cost_per_kg: 'প্রতি কেজি উৎপাদন খরচ:',
                farming_net_profit: 'নিট লাভ:',
                farming_net_loss: 'নিট ক্ষতি:',
                farming_price_per_kg_label: 'প্রতি কেজি মুরগির বিক্রয় দর:',
                farming_price_per_kg_placeholder: 'যেমন: 180',
                farming_generate_rows_label: 'সারি সংখ্যা লিখুন:',
                farming_generate_rows_btn: 'তৈরি',
                farming_toggle_rows_label: 'তালিকা',
                farming_individual_weight_placeholder: 'ওজন (কেজি)',
                farming_chick_no: 'মুরগি',
                farming_performance_warning: 'বেশি সংখ্যক সারি (২০০-এর বেশি) তৈরি করলে অ্যাপটি ধীর হয়ে যেতে পারে। ২০০টি সারি তৈরি করা হয়েছে।',
                auth_login_register: 'লগইন/রেজিস্টার',
                auth_logout: 'লগআউট',
                auth_login_page_title: 'লগইন বা রেজিস্টার',
                auth_login_instructions: 'আপনার ইমেইল ও পাসওয়ার্ড দিয়ে লগইন করুন অথবা নতুন অ্যাকাউন্ট তৈরি করুন।',
                auth_email_label: 'আপনার ইমেইল:',
                auth_email_placeholder: 'example@email.com',
                auth_password_label: 'পাসওয়ার্ড:',
                auth_password_placeholder: 'কমপক্ষে ৬ অক্ষরের পাসওয়ার্ড',
                auth_login_btn: 'লগইন',
                auth_register_btn: 'রেজিস্টার',
                auth_login_required: 'এই সুবিধাটি ব্যবহার করতে অনুগ্রহ করে লগইন করুন।',
                menu_change_password: 'পাসওয়ার্ড পরিবর্তন',
                menu_password_recovery: 'পাসওয়ার্ড রিকভারি',
                menu_help_support: 'হেল্প ও সাপোর্ট',
                password_recovery_page_title: 'পাসওয়ার্ড পুনরুদ্ধার',
                password_recovery_instructions: 'আপনার অ্যাকাউন্টের সাথে যুক্ত ইমেইলটি লিখুন। আমরা আপনাকে পাসওয়ার্ড রিসেট করার জন্য একটি লিংক পাঠাবো।',
                send_recovery_link_btn: 'রিকভারি লিংক পাঠান',
                password_recovery_success: 'পাসওয়ার্ড পুনরুদ্ধারের জন্য একটি ইমেইল পাঠানো হয়েছে। আপনার ইনবক্স চেক করুন।',
                password_recovery_fail: 'ইমেইল পাঠাতে ব্যর্থ হয়েছে: ',
                password_change_page_title: 'পাসওয়ার্ড পরিবর্তন করুন',
                password_change_instructions: 'আপনার পুরাতন পাসওয়ার্ড দিন এবং একটি নতুন, শক্তিশালী পাসওয়ার্ড সেট করুন।',
                old_password_label: 'পুরাতন পাসওয়ার্ড:',
                old_password_placeholder: 'আপনার বর্তমান পাসওয়ার্ড',
                new_password_label: 'নতুন পাসওয়ার্ড:',
                new_password_placeholder: 'কমপক্ষে ৬ অক্ষরের নতুন পাসওয়ার্ড',
                confirm_password_label: 'নতুন পাসওয়ার্ড নিশ্চিত করুন:',
                confirm_password_placeholder: 'আবার নতুন পাসওয়ার্ড লিখুন',
                change_password_btn: 'পাসওয়ার্ড পরিবর্তন করুন',
                password_change_success: 'আপনার পাসওয়ার্ড সফলভাবে পরিবর্তন করা হয়েছে।',
                password_change_fail: 'পাসওয়ার্ড পরিবর্তন ব্যর্থ হয়েছে: ',
                password_reauth_fail: 'পুরাতন পাসওয়ার্ড সঠিক নয়।',
                passwords_do_not_match: 'দুটি নতুন পাসওয়ার্ড মিলছে না।',
                help_support_page_title: 'হেল্প ও সাপোর্ট',
                help_support_loading: 'তথ্য লোড হচ্ছে...',
                help_support_unavailable: 'সাপোর্ট তথ্য এই মুহূর্তে উপলব্ধ নেই।',
                help_support_contact_us: 'যেকোনো প্রয়োজনে আমাদের সাথে যোগাযোগ করুন:',
                help_support_call: 'কল করুন',
                help_support_visit_link: 'লিংক ভিজিট করুন',
            },
        };
        
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        function isUserLoggedIn() {
            return !!(typeof firebase !== 'undefined' && firebase.auth().currentUser);
        }
        
        function handlePremiumCalculation(calculatorId, callback) {
            // Always allow execution as the app is free
            callback();
        }
        
        function updatePremiumUI() {
            // No restrictions, just update UI to reflect unlocked state if needed
            const premiumButtons = document.querySelectorAll('.premium-calculate-btn');
            const lang = 'bn'; 
            
            premiumButtons.forEach(button => {
                const originalKey = button.getAttribute('data-translate-key-revert');
                const originalIcon = button.querySelector('i');
                const originalIconClass = originalIcon ? originalIcon.className : 'fas fa-calculator';
                
                if (originalKey && translations[lang][originalKey]) {
                    button.innerHTML = `<i class="${originalIconClass}"></i> <span>${translations[lang][originalKey]}</span>`;
                }
                button.style.backgroundColor = 'var(--primary-color)';
            });
        }
        
        function setLanguage() {
            const lang = 'bn'; 
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                const translation = translations[lang] ? translations[lang][key] : key;
                if (translation !== undefined) {
                    const icon = el.querySelector('i');
                    const span = el.querySelector('span');
                    if (span) {
                       span.innerHTML = translation;
                    } else if (icon) {
                       el.innerHTML = icon.outerHTML + ' ' + translation;
                    } else {
                        el.innerHTML = translation;
                    }
                }
            });
             
            document.querySelectorAll('.all-tabs-dropdown option, #pc-type option, #inv-type option, #con-wall-thickness option, #inheritance-property-type option').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (key) {
                    const translation = translations[lang] ? translations[lang][key] : key;
                    if (translation !== undefined) {
                        el.textContent = translation;
                    }
                }
            });

            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-key-placeholder');
                 if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            generateCrewInputs();
            updatePremiumUI();
            updateLoginUI();
        }

        function openTab(evt, tabName, isDropdown = false) {
             if (!tabName) return;
             
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            
            const dropdownMenu = document.getElementById('dropdown-menu');
            if (dropdownMenu.classList.contains('show')) {
                dropdownMenu.classList.remove('show');
            }

            let correspondingTab;
            for (i = 0; i < tablinks.length; i++) {
                if (tablinks[i].getAttribute('onclick').includes(`'${tabName}'`)) {
                    correspondingTab = tablinks[i];
                    break;
                }
            }
            if (correspondingTab) {
                correspondingTab.className += " active";
                correspondingTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }
        
        function openSubTab(event, subTabName) {
            const parentTab = event.target.closest('.tab-content');
            parentTab.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
            parentTab.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(subTabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        document.getElementById('theme-toggle-switch').addEventListener('change', function() {
            const body = document.body;
            const icon = document.querySelector('#theme-toggle-menu i');
            if (this.checked) {
                body.setAttribute('data-theme', 'dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                body.removeAttribute('data-theme');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });

        function adjustFontSize(displayElement) {
            const len = displayElement.innerText.length;
            const baseSize = displayElement.parentElement.id === 'floating-calculator' ? 2.2 : 2.8;
            if (len > 15) {
                displayElement.style.fontSize = (baseSize * 0.5) + 'rem';
            } else if (len > 9) {
                displayElement.style.fontSize = (baseSize * 0.65) + 'rem';
            } else {
                displayElement.style.fontSize = baseSize + 'rem';
            }
        }

        function appendToDisplay(id, val) {
            const d = document.getElementById(id + "-display");
            const operators = ['/', '*', '-', '+'];
            const lastChar = d.innerText.slice(-1);

            if (operators.includes(val) && operators.includes(lastChar)) {
                return;
            }

            const currentDisplay = d.innerText;
            if (currentDisplay === "0" || currentDisplay === "Error") {
                 d.innerText = (val === '.') ? "0" + val : val;
            } else {
                d.innerText += val;
            }
            adjustFontSize(d);
        }

        function clearDisplay(id) {
            const d = document.getElementById(id + "-display");
            d.innerText = "0";
            document.getElementById(id + "-history").innerText = "";
            adjustFontSize(d);
        }

        function backspace(id) {
            const d = document.getElementById(id + "-display");
            d.innerText = d.innerText.slice(0, -1);
            if (d.innerText === "") {
                d.innerText = "0";
            }
            adjustFontSize(d);
        }
        
        function memoryClear(id) {
            memoryValue = 0;
            showToast("Memory Cleared");
        }
        function memoryRecall(id) {
            document.getElementById(id + "-display").innerText = memoryValue;
            adjustFontSize(document.getElementById(id + "-display"));
        }
        function memoryAdd(id) {
            const currentValue = parseFloat(document.getElementById(id + "-display").innerText);
            if (!isNaN(currentValue)) {
                memoryValue += currentValue;
                showToast("Added to Memory");
            }
        }
        function memorySubtract(id) {
             const currentValue = parseFloat(document.getElementById(id + "-display").innerText);
            if (!isNaN(currentValue)) {
                memoryValue -= currentValue;
                showToast("Subtracted from Memory");
            }
        }
        
        function toggleFloatingCalculator() {
            const floatingCalc = document.getElementById('floating-calculator');
            floatingCalc.style.display = floatingCalc.style.display === 'block' ? 'none' : 'block';
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = element.querySelector(".floating-calculator-header");
            
            if (header) {
                header.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }


        function calculate(id) {
            const d = document.getElementById(id + "-display"), h = document.getElementById(id + "-history");
            let expression = '';
            try {
                expression = d.innerText;
                
                let e = expression.replace(/×/g, '*').replace(/÷/g, '/').replace(/%/g, '/100*');
                
                const operators = ['/', '*', '-', '+', '.'];
                if (operators.includes(e.slice(-1))) {
                    e = e.slice(0, -1);
                }
                
                let result = eval(e);
                let resultString = parseFloat(result.toPrecision(12)).toString();
                
                d.innerText = resultString;
                h.innerText = expression + "=";

                const hasOperator = /[+\-*/%]/.test(expression);
                if (resultString && resultString !== "Error" && resultString !== "NaN" && hasOperator && id === 'basic') {
                    saveCalculationToHistory(id, { expression: expression }, resultString);
                }

            }
            catch (error) {
                d.innerText = "Error";
                h.innerText = expression + "=";
            }
            adjustFontSize(d);
        }
        
        function resetOfferTab() {
            document.getElementById('offer-operator').selectedIndex = 0;
            document.getElementById('offer-data').value = '';
            document.getElementById('offer-minutes').value = '';
            document.getElementById('offer-price').value = '';
            document.getElementById('offer-validity').value = '';
            document.getElementById('offer-result').style.display = 'none';
        }
        function resetPriceTab() {
            document.getElementById('price-ref-amount').value = '';
            document.getElementById('price-ref-weight').value = '1000';
            const weightInput = document.getElementById('price-target-weight');
            const unitSelect = document.getElementById('price-target-unit');
            const budgetInput = document.getElementById('price-budget-amount');
            
            weightInput.value = '';
            budgetInput.value = '';
            weightInput.disabled = false;
            unitSelect.disabled = false;
            budgetInput.disabled = false;
            document.getElementById('price-tab-result').style.display = 'none';
        }
        function resetNoteTab() {
            document.getElementById('note-list-container').innerHTML = '';
            document.getElementById('note-list-result').style.display = 'none';
            addNoteListItem();
        }
        function resetFishingTab() {
            const defaultMajhiShare = (calculatorSettings?.fishing?.defaultMajhiShare) || 2;
            const defaultBaburchiShare = (calculatorSettings?.fishing?.defaultBaburchiShare) || 1.5;

            document.getElementById('fishing-earnings').value = '';
            
            document.querySelector('input[name="fishing-expense-method"][value="total"]').click();
            document.getElementById('fishing-expenses').value = '';
            
            // Clear fixed expenses
            document.getElementById('exp-diesel').value = '';
            document.getElementById('exp-ice').value = '';
            document.getElementById('exp-food').value = '';
            document.getElementById('exp-repair').value = '';

            document.getElementById('fishing-expense-rows-container').innerHTML = '';
            
            document.getElementById('fishing-owner-share').value = '';
            document.getElementById('fishing-majhi-count').value = '1';
            document.getElementById('fishing-majhi-share').value = defaultMajhiShare;
            document.getElementById('fishing-baburchi-count').value = '1';
            document.getElementById('fishing-baburchi-share').value = defaultBaburchiShare;
            document.getElementById('fishing-crew-count').value = '';
            
            generateCrewInputs();
            document.getElementById('fishing-result').style.display = 'none';
        }
        function resetAgeTab() {
            document.getElementById('birth-date').value = '';
            document.getElementById('age-result').style.display = 'none';
            document.getElementById('age-compare-1').value = '';
            document.getElementById('age-compare-2').value = '';
            document.getElementById('age-compare-result').style.display = 'none';
        }
        function resetHealthTab() {
            document.getElementById('health-age').value = '';
            document.getElementById('health-height-ft').value = '';
            document.getElementById('health-height-in').value = '';
            document.getElementById('health-weight').value = '';
            document.getElementById('health-calories').value = '';
            document.getElementById('health-result').style.display = 'none';
        }
        function resetDiscountTab() {
            document.getElementById('discount-price').value = '';
            document.getElementById('discount-percentage').value = '';
            document.getElementById('discount-result').style.display = 'none';
        }
        function resetBengaliDateTab() {
            document.getElementById('gregorian-date').value = '';
            document.getElementById('bengali-date-result').style.display = 'none';
        }
        function resetElectricityTab() {
            document.getElementById('electricity-prev').value = '';
            document.getElementById('electricity-current').value = '';
            document.getElementById('electricity-result').style.display = 'none';
        }
        function resetLandTab() {
            document.getElementById('land-length').value = '';
            document.getElementById('land-width').value = '';
            document.getElementById('land-result').style.display = 'none';
        }
        function resetInheritanceTab() {
            document.getElementById('inheritance-money').value = '';
            document.getElementById('inheritance-land-value').value = '';
            document.getElementById('inheritance-other').value = '';
            document.getElementById('inheritance-wife').value = '0';
            document.getElementById('inheritance-husband').value = '0';
            document.getElementById('inheritance-father').value = '0';
            document.getElementById('inheritance-mother').value = '0';
            document.getElementById('inheritance-sons').value = '0';
            document.getElementById('inheritance-daughters').value = '0';
            document.getElementById('inheritance-result').style.display = 'none';
        }
        function resetZakatTab() {
            document.getElementById('zakat-cash').value = '';
            document.getElementById('zakat-gold-grams').value = '';
            document.getElementById('zakat-gold-rate').value = '';
            document.getElementById('zakat-silver-grams').value = '';
            document.getElementById('zakat-silver-rate').value = '';
            document.getElementById('zakat-business').value = '';
            document.getElementById('zakat-shares').value = '';
            document.getElementById('zakat-debt').value = '';
            document.getElementById('zakat-result').style.display = 'none';
        }
        function resetTaxTab() {
            document.getElementById('tax-income').value = '';
            document.getElementById('tax-investment').value = '';
            document.getElementById('tax-result').style.display = 'none';
        }
        function resetPaintCarpetTab() {
            document.getElementById('pc-length').value = '';
            document.getElementById('pc-width').value = '';
            document.getElementById('pc-height').value = '';
            document.getElementById('pc-doors').value = '0';
            document.getElementById('pc-windows').value = '0';
            document.getElementById('pc-result').style.display = 'none';
        }
        function resetInvestmentTab() {
            document.getElementById('inv-sip-amount').value = '';
            document.getElementById('inv-principal').value = '';
            document.getElementById('inv-rate').value = '';
            document.getElementById('inv-years').value = '';
            document.getElementById('inv-months').value = '';
            document.getElementById('inv-result').style.display = 'none';
        }
        function resetConstructionTab(type) {
             if (type === 'all-in-one') {
                document.querySelectorAll('#all-in-one-calc input, #all-in-one-calc select').forEach(el => {
                    if (el.tagName === 'SELECT') el.selectedIndex = 0;
                    else el.value = '';
                });
                document.getElementById('con-all-in-one-result').style.display = 'none';
            } else if (type === 'bricks') {
                document.getElementById('con-wall-length').value = '';
                document.getElementById('con-wall-height').value = '';
                document.getElementById('con-bricks-result').style.display = 'none';
            } else if (type === 'plaster') {
                document.getElementById('plaster-wall-length').value = '';
                document.getElementById('plaster-wall-height').value = '';
                document.getElementById('plaster-thickness').value = '12';
                document.getElementById('con-plaster-result').style.display = 'none';
            } else if (type === 'concrete') {
                document.getElementById('concrete-length').value = '';
                document.getElementById('concrete-width').value = '';
                document.getElementById('concrete-height').value = '';
                document.getElementById('con-concrete-result').style.display = 'none';
            } else if (type === 'steel') {
                document.getElementById('steel-concrete-volume').value = '';
                document.getElementById('con-steel-result').style.display = 'none';
            }
        }

        function calculateOffer() {
            const operatorRate = parseFloat(document.getElementById('offer-operator').value);
            const dataGB = parseFloat(document.getElementById('offer-data').value) || 0;
            const minutes = parseFloat(document.getElementById('offer-minutes').value) || 0;
            const totalPrice = parseFloat(document.getElementById('offer-price').value) || 0;
            const validity = parseFloat(document.getElementById('offer-validity').value) || 0;
            const resultDiv = document.getElementById('offer-result');

            if (totalPrice <= 0 || validity <= 0 || (dataGB <= 0 && minutes <= 0)) {
                resultDiv.innerHTML = '<p>অনুগ্রহ করে সকল তথ্য সঠিকভাবে পূরণ করুন।</p>';
                resultDiv.style.display = 'block';
                return;
            }

            const minutesCost = minutes * operatorRate;
            const dataCost = totalPrice - minutesCost;
            
            const costPerGB = dataGB > 0 ? dataCost / dataGB : 0;
            const costPerMB = dataGB > 0 ? dataCost / (dataGB * 1024) : 0;
            const costPerMinute = minutes > 0 ? minutesCost / minutes : 0;
            const costPerDay = totalPrice / validity;

            const costPerGBWithoutMinutes = dataGB > 0 ? totalPrice / dataGB : 0;
            const savings = costPerGBWithoutMinutes - costPerGB;
            const savingsPercentage = costPerGBWithoutMinutes > 0 ? (savings / costPerGBWithoutMinutes) * 100 : 0;
            
            let resultHTML = `
                <div class="result-details">
                    <h4>অফার সামারি:</h4>
                    <p><strong>${dataGB} GB + ${minutes} মিনিট, মেয়াদ ${validity} দিন, মোট ${totalPrice} টাকা</strong></p>
                    <hr class="divider" style="margin: 10px 0;">
                    
                    <h4>মূল্য বিভাজন:</h4>
                    <p>মোট মিনিটের মূল্য: <strong>${minutesCost.toFixed(2)} টাকা</strong> (${((minutesCost/totalPrice)*100).toFixed(2)}%)</p>
                    <p>মোট জিবির মূল্য: <strong>${dataCost.toFixed(2)} টাকা</strong> (${((dataCost/totalPrice)*100).toFixed(2)}%)</p>
                    <hr class="divider" style="margin: 10px 0;">

                    <h4>প্রতি ইউনিট দাম:</h4>
                    <p>প্রতি GB-এর দাম: <strong>${costPerGB.toFixed(2)} টাকা</strong></p>
                    <p>প্রতি MB-এর দাম: <strong>${costPerMB.toFixed(4)} টাকা</strong></p>
                    <p>প্রতি মিনিটের দাম: <strong>${costPerMinute.toFixed(2)} টাকা</strong></p>
                    <p>প্রতিদিনের দাম: <strong>${costPerDay.toFixed(2)} টাকা</strong></p>
                    <hr class="divider" style="margin: 10px 0;">

                    <h4>তুলনা:</h4>
                    <p>শুধু ডাটা কিনলে প্রতি GB খরচ হতো: <strong>${costPerGBWithoutMinutes.toFixed(2)} টাকা</strong></p>
                    <p>মিনিট সহ কেনায় প্রতি GB খরচ হলো: <strong>${costPerGB.toFixed(2)} টাকা</strong></p>
                    <p style="color: var(--success-color);">আপনার লাভ হলো: <strong>${savings.toFixed(2)} টাকা/GB</strong> (${savingsPercentage.toFixed(2)}%)</p>
                </div>
            `;
            
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';
        }

        function togglePriceInputs(activeInput) {
            const weightInput = document.getElementById('price-target-weight');
            const unitSelect = document.getElementById('price-target-unit');
            const budgetInput = document.getElementById('price-budget-amount');

            if (activeInput === 'weight') {
                if (weightInput.value !== '') {
                    budgetInput.value = '';
                    budgetInput.disabled = true;
                } else {
                    budgetInput.disabled = false;
                }
            } else if (activeInput === 'budget') {
                if (budgetInput.value !== '') {
                    weightInput.value = '';
                    weightInput.disabled = true;
                    unitSelect.disabled = true;
                } else {
                    weightInput.disabled = false;
                    unitSelect.disabled = false;
                }
            }
        }
        
        // New Function for Preset Buttons
        function setPriceWeight(amount, unit) {
            const weightInput = document.getElementById('price-target-weight');
            const unitSelect = document.getElementById('price-target-unit');
            
            weightInput.value = amount;
            unitSelect.value = unit;
            
            // Trigger toggle logic
            togglePriceInputs('weight');
            calculatePriceOrQuantity();
        }
        
        function calculatePriceOrQuantity() {
            const lang = 'bn';
            const resultDiv = document.getElementById('price-tab-result');
            
            const refAmount = parseFloat(document.getElementById('price-ref-amount').value) || 0;
            const refWeight = parseFloat(document.getElementById('price-ref-weight').value) || 0;
            const refUnit = document.getElementById('price-ref-unit').value;

            const targetWeight = parseFloat(document.getElementById('price-target-weight').value) || 0;
            const targetUnit = document.getElementById('price-target-unit').value;
            const budgetAmount = parseFloat(document.getElementById('price-budget-amount').value) || 0;

            if (refAmount <= 0 || refWeight <= 0) {
                resultDiv.innerHTML = translations[lang].price_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }
            
            const refWeightInGrams = refUnit === 'kg' ? refWeight * 1000 : refWeight;
            
            let inputs = { refAmount, refWeight, refUnit };
            let resultText;

            if (targetWeight > 0) {
                inputs.targetWeight = targetWeight;
                inputs.targetUnit = targetUnit;
                const targetWeightInGrams = targetUnit === 'kg' ? targetWeight * 1000 : targetWeight;
                const finalPrice = (refAmount / refWeightInGrams) * targetWeightInGrams;
                resultText = translations[lang].price_result_title.replace('${finalPrice}', finalPrice.toFixed(2));
                resultDiv.innerHTML = resultText;
                resultDiv.style.display = 'block';
            } else if (budgetAmount > 0) {
                inputs.budgetAmount = budgetAmount;
                const pricePerGram = refAmount / refWeightInGrams;
                const quantityInGrams = budgetAmount / pricePerGram;
                resultText = translations[lang].price_quantity_result_title
                    .replace('${quantityGrams}', quantityInGrams.toFixed(2))
                    .replace('${quantityKg}', (quantityInGrams / 1000).toFixed(3));
                resultDiv.innerHTML = resultText;
                resultDiv.style.display = 'block';
            } else {
                resultDiv.innerHTML = translations[lang].price_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }
            saveCalculationToHistory('price', inputs, resultText);
        }
        
        function addNoteListItem() {
            const container = document.getElementById('note-list-container');
            const newItem = document.createElement('div');
            newItem.id = 'note-list-item';
            newItem.innerHTML = `
                <input type="checkbox" class="note-item-checkbox">
                <input type="text" placeholder="আইটেমের নাম">
                <input type="number" placeholder="টাকা/পরিমাণ">
                <button class="delete-note-item-btn" onclick="removeNoteListItem(this)"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(newItem);
        }
        function removeNoteListItem(button) {
            button.parentElement.remove();
        }
        function calculateNoteListTotal() {
            const items = document.querySelectorAll('#note-list-item');
            let total = 0;
            items.forEach(item => {
                const checkbox = item.querySelector('.note-item-checkbox');
                if (checkbox.checked) {
                    const value = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                    total += value;
                }
            });
            const resultDiv = document.getElementById('note-list-result');
            resultDiv.innerHTML = `আপনার বাজারের মোট খরচ: <strong>${total.toFixed(2)} টাকা</strong>`;
            resultDiv.style.display = 'block';
        }
        
        let fishingExpenseRowCounter = 0;

        function toggleFishingExpenseMode(mode) {
            const totalContainer = document.getElementById('fishing-expense-total-container');
            const detailsContainer = document.getElementById('fishing-expense-details-container');
            
            if (mode === 'total') {
                totalContainer.style.display = 'block';
                detailsContainer.style.display = 'none';
            } else {
                totalContainer.style.display = 'none';
                detailsContainer.style.display = 'block';
            }
        }

        function addFishingExpenseRow() {
            fishingExpenseRowCounter++;
            const container = document.getElementById('fishing-expense-rows-container');
            const newRow = document.createElement('div');
            newRow.className = 'fishing-expense-row';
            newRow.id = `fishing-expense-row-${fishingExpenseRowCounter}`;
            
            newRow.innerHTML = `
                <input type="text" placeholder="অন্যান্য খরচ">
                <input type="number" class="fishing-expense-amount" placeholder="টাকা">
                <button onclick="removeFishingExpenseRow(${fishingExpenseRowCounter})"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(newRow);
        }

        function removeFishingExpenseRow(rowId) {
            const row = document.getElementById(`fishing-expense-row-${rowId}`);
            if (row) row.remove();
        }

        function calculateFishingExpenses() {
            const mode = document.querySelector('input[name="fishing-expense-method"]:checked').value;
            if (mode === 'total') {
                return parseFloat(document.getElementById('fishing-expenses').value) || 0;
            } else {
                let total = 0;
                // Sum fixed expenses
                total += parseFloat(document.getElementById('exp-diesel').value) || 0;
                total += parseFloat(document.getElementById('exp-ice').value) || 0;
                total += parseFloat(document.getElementById('exp-food').value) || 0;
                total += parseFloat(document.getElementById('exp-repair').value) || 0;

                // Sum dynamic expenses
                document.querySelectorAll('#fishing-expense-rows-container .fishing-expense-amount').forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                return total;
            }
        }
        
        // Crew Save/Load Logic
        function saveCrewTeam() {
            const team = [];
            // Majhi
            const majhiCount = parseInt(document.getElementById('fishing-majhi-count').value) || 0;
            for(let i=1; i<=majhiCount; i++) {
                const el = document.getElementById(`name_majhi_${i}`);
                if(el && el.value) team.push({role: 'majhi', index: i, name: el.value});
            }
            // Baburchi
            const baburchiCount = parseInt(document.getElementById('fishing-baburchi-count').value) || 0;
            for(let i=1; i<=baburchiCount; i++) {
                const el = document.getElementById(`name_baburchi_${i}`);
                if(el && el.value) team.push({role: 'baburchi', index: i, name: el.value});
            }
             // Crew
            const crewCount = parseInt(document.getElementById('fishing-crew-count').value) || 0;
            for(let i=1; i<=crewCount; i++) {
                const el = document.getElementById(`name_crew_${i}`);
                if(el && el.value) team.push({role: 'crew', index: i, name: el.value});
            }

            if(team.length > 0) {
                const teamData = {
                    majhiCount: majhiCount,
                    baburchiCount: baburchiCount,
                    crewCount: crewCount,
                    members: team
                };
                localStorage.setItem('fishingCrewTeam', JSON.stringify(teamData));
                showToast("টিম সফলভাবে সেভ হয়েছে!");
            } else {
                alert("সেভ করার জন্য কোন নাম পাওয়া যায়নি।");
            }
        }

        function loadCrewTeam() {
            const savedData = localStorage.getItem('fishingCrewTeam');
            if(savedData) {
                try {
                    const teamData = JSON.parse(savedData);
                    
                    // Set counts
                    document.getElementById('fishing-majhi-count').value = teamData.majhiCount || 0;
                    document.getElementById('fishing-baburchi-count').value = teamData.baburchiCount || 0;
                    document.getElementById('fishing-crew-count').value = teamData.crewCount || 0;
                    
                    // Regenerate inputs
                    generateCrewInputs();
                    
                    // Fill names
                    teamData.members.forEach(member => {
                        const el = document.getElementById(`name_${member.role}_${member.index}`);
                        if(el) el.value = member.name;
                    });
                    
                    // Show the list if hidden
                    const container = document.getElementById('crew-details-container');
                    if(container.style.display === 'none') {
                         toggleCrewList({preventDefault:()=>{}}); 
                    }
                    
                    showToast("টিম লোড হয়েছে!");
                } catch(e) {
                    console.error(e);
                    alert("টিম লোড করতে সমস্যা হয়েছে।");
                }
            } else {
                alert("কোন সেভ করা টিম পাওয়া যায়নি।");
            }
        }


        function calculateAge() {
            const birthDateInput = document.getElementById("birth-date").value, resultDiv = document.getElementById("age-result"), lang = 'bn';
            if (!birthDateInput) { resultDiv.innerHTML = translations[lang].birth_date_invalid; resultDiv.style.display = "block"; return; }
            const birthDate = new Date(birthDateInput), today = new Date();
            if (birthDate > today) { resultDiv.innerHTML = translations[lang].birth_date_future; resultDiv.style.display = "block"; return; }
            let years = today.getFullYear() - birthDate.getFullYear(), months = today.getMonth() - birthDate.getMonth(), days = today.getDate() - birthDate.getDate();
            if (days < 0) { months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); }
            if (months < 0) { years--; months += 12; }
            const resultText = translations[lang].age_result_text.replace('${years}', years).replace('${months}', months).replace('${days}', days);
            resultDiv.innerHTML = resultText;
            resultDiv.style.display = "block";
            saveCalculationToHistory('age', { birthDate: birthDateInput }, resultText);
        }

        function calculateAgeDifference() {
            const d1Str = document.getElementById("age-compare-1").value;
            const d2Str = document.getElementById("age-compare-2").value;
            const resultDiv = document.getElementById("age-compare-result");
            
            if (!d1Str || !d2Str) {
                resultDiv.innerHTML = "অনুগ্রহ করে দুটি তারিখ নির্বাচন করুন।";
                resultDiv.style.display = "block";
                return;
            }

            let d1 = new Date(d1Str);
            let d2 = new Date(d2Str);

            // Ensure d1 is the earlier date
            if (d1 > d2) {
                [d1, d2] = [d2, d1];
            }

            let years = d2.getFullYear() - d1.getFullYear();
            let months = d2.getMonth() - d1.getMonth();
            let days = d2.getDate() - d1.getDate();

            if (days < 0) {
                months--;
                // Get days in previous month
                days += new Date(d2.getFullYear(), d2.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }

            resultDiv.innerHTML = `পার্থক্য: <strong>${years} বছর, ${months} মাস, ${days} দিন</strong>`;
            resultDiv.style.display = "block";
        }

        function calculateHealth() {
            const age = parseInt(document.getElementById('health-age').value), gender = document.getElementById('health-gender').value, heightFt = parseInt(document.getElementById('health-height-ft').value) || 0, heightIn = parseInt(document.getElementById('health-height-in').value) || 0, weight = parseFloat(document.getElementById('health-weight').value), dailyCalories = parseInt(document.getElementById('health-calories').value), resultDiv = document.getElementById('health-result'), lang = 'bn';
            if (!age || !weight || !heightFt && !heightIn || age <= 0 || weight <= 0) { resultDiv.innerHTML = translations[lang].health_invalid_input; resultDiv.style.display = "block"; return; }
            const heightInMeters = ((heightFt * 12) + heightIn) * 0.0254, bmi = weight / (heightInMeters * heightInMeters);
            let bmiCategoryKey = bmi < 18.5 ? 'bmi_category_underweight' : bmi < 25 ? 'bmi_category_normal' : bmi < 30 ? 'bmi_category_overweight' : 'bmi_category_obese';
            const bmr = gender === 'male' ? 88.362 + (13.397 * weight) + (4.799 * heightInMeters * 100) - (5.677 * age) : 447.593 + (9.247 * weight) + (3.098 * heightInMeters * 100) - (4.330 * age);
            let healthReport = `<strong>BMI: ${bmi.toFixed(2)}</strong> (${translations[lang][bmiCategoryKey]})<br>` + translations[lang].bmr_result_text.replace('${bmr}', bmr.toFixed(2));
            if (bmi < 18.5) {
                const weightToGain = (18.5 * heightInMeters * heightInMeters) - weight;
                healthReport += `<hr style="margin: 10px 0; border-top: 1px solid var(--border-color);">` + translations[lang].weight_gain_needed.replace('${weightToGain}', weightToGain.toFixed(1));
                if (dailyCalories && dailyCalories > bmr) {
                    const daysToGoal = (weightToGain * 7700) / (dailyCalories - bmr);
                    healthReport += translations[lang].days_to_goal.replace('${dailyCalories}', dailyCalories).replace('${days}', Math.round(daysToGoal));
                } else if (dailyCalories) { healthReport += translations[lang].calorie_intake_warning.replace('${bmr}', bmr.toFixed(0)); }
            }
            resultDiv.innerHTML = healthReport; resultDiv.style.display = 'block';
            saveCalculationToHistory('health', { age, gender, heightFt, heightIn, weight, dailyCalories }, healthReport);
        }

        function calculateDiscount() {
            const originalPrice = parseFloat(document.getElementById('discount-price').value);
            const discountPercentage = parseFloat(document.getElementById('discount-percentage').value);
            const resultDiv = document.getElementById('discount-result');
            const lang = 'bn';

            if (!originalPrice || !discountPercentage || originalPrice <= 0 || discountPercentage < 0) {
                resultDiv.innerHTML = translations[lang].discount_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }

            const savedAmount = (originalPrice * discountPercentage) / 100;
            const finalPrice = originalPrice - savedAmount;

            const resultText = translations[lang].discount_result_text
                .replace('${finalPrice}', finalPrice.toFixed(2))
                .replace('${savedAmount}', savedAmount.toFixed(2));
            resultDiv.innerHTML = resultText;
            resultDiv.style.display = 'block';
            saveCalculationToHistory('discount', { price: originalPrice, discount: discountPercentage }, resultText);
        }

        function getTithiInfo(date) {
            const tithiNames = [
                "প্রতিপদ", "দ্বিতীয়া", "তৃতীয়া", "চতুর্থী", "পঞ্চমী", "ষষ্ঠী", "সপ্তমী", "অষ্টমী", "নবমী", "দশমী", "একাদশী", "দ্বাদশী", "ত্রয়োদশী", "চতুর্দশী", "পূর্ণিমা",
                "প্রতিপদ", "দ্বিতীয়া", "তৃতীয়া", "চতুর্থী", "পঞ্চমী", "ষষ্ঠী", "সপ্তমী", "অষ্টমী", "নবমী", "দশমী", "একাদশী", "দ্বাদশী", "ত্রয়োদশী", "চতুর্দশী", "অমাবস্যা"
            ];
            const referenceAmavasya = new Date('2024-02-09T13:31:00Z');
            const LUNAR_MONTH_DAYS = 29.530588853;
            const diffMillis = date.getTime() - referenceAmavasya.getTime();
            const diffDays = diffMillis / (1000 * 60 * 60 * 24);
            let lunarPhase = (diffDays / LUNAR_MONTH_DAYS) % 1;
            if (lunarPhase < 0) { lunarPhase += 1; } 
            const tithiIndex = Math.floor(lunarPhase * 30);
            const tithiName = tithiNames[tithiIndex];
            const paksha = (tithiIndex < 15) ? "শুক্লপক্ষ" : "কৃষ্ণপক্ষ";
            return { name: tithiName, paksha: paksha, index: tithiIndex };
        }

        function calculateBengaliDate() {
            const dateInput = document.getElementById('gregorian-date').value;
            const resultDiv = document.getElementById('bengali-date-result');
            const lang = 'bn';

            if (!dateInput) {
                resultDiv.innerHTML = translations[lang].bengali_date_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }

            const engDate = new Date(dateInput);
            const localDate = new Date(engDate.getTime() + engDate.getTimezoneOffset() * 60000);
            const engYear = localDate.getFullYear();
            const engMonth = localDate.getMonth();
            const engDay = localDate.getDate();
            const isLeapYear = (year) => (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
            let bengaliYear = (engMonth < 3 || (engMonth === 3 && engDay < 14)) ? engYear - 594 : engYear - 593;
            const startEngYear = (engMonth < 3 || (engMonth === 3 && engDay < 14)) ? engYear - 1 : engYear;
            const bengaliNewYear = new Date(startEngYear, 3, 14); 
            const dayDifference = Math.round((localDate - bengaliNewYear) / (1000 * 60 * 60 * 24));
            const bengaliMonths = ['বৈশাখ', 'জ্যৈষ্ঠ', 'আষাঢ়', 'শ্রাবণ', 'ভাদ্র', 'আশ্বিন', 'কার্তিক', 'অগ্রহায়ণ', 'পৌষ', 'মাঘ', 'ফাল্গুন', 'চৈত্র'];
            let bengaliMonthDays = [31, 31, 31, 31, 31, 30, 30, 30, 30, 30, isLeapYear(startEngYear + 1) ? 31 : 30, 30];
            let dayCount = dayDifference;
            let monthIndex = 0;
            for (let i = 0; i < bengaliMonthDays.length; i++) {
                if (dayCount < bengaliMonthDays[i]) {
                    monthIndex = i;
                    break;
                }
                dayCount -= bengaliMonthDays[i];
            }
            const bengaliDate = dayCount + 1;
            const bengaliMonth = bengaliMonths[monthIndex];
            const mainTithiInfo = getTithiInfo(localDate);
            let tithiText = `${mainTithiInfo.name} (${mainTithiInfo.paksha})`;
            if(mainTithiInfo.name === 'পূর্ণিমা' || mainTithiInfo.name === 'অমাবস্যা' || mainTithiInfo.name === 'একাদশী' || mainTithiInfo.name === 'দ্বাদশী') {
                 tithiText = `<strong>${tithiText}</strong>`;
            }
            const resultText = translations[lang].bengali_date_result_text.replace('${bengaliDate}', bengaliDate).replace('${bengaliMonth}', bengaliMonth).replace('${bengaliYear}', bengaliYear).replace('${tithiText}', tithiText);
            let extraInfoHTML = '<div class="tithi-container"><h5>পূর্ববর্তী সপ্তাহ</h5><ul class="tithi-list">';
            for (let i = 7; i > 0; i--) {
                const prevDate = new Date(localDate);
                prevDate.setDate(localDate.getDate() - i);
                const tithiInfo = getTithiInfo(prevDate);
                let className = '';
                if(tithiInfo.name === 'পূর্ণিমা') className = 'highlight-purnima';
                if(tithiInfo.name === 'অমাবস্যা') className = 'highlight-amavasya';
                if(tithiInfo.name === 'একাদশী') className = 'highlight-ekadashi';
                extraInfoHTML += `<li class="${className}"><span>${prevDate.toLocaleDateString('bn-BD')}</span> <span>${tithiInfo.name}</span></li>`;
            }
            extraInfoHTML += '</ul><h5 style="margin-top:15px;">পরবর্তী সপ্তাহ</h5><ul class="tithi-list">';
             extraInfoHTML += `<li class="selected-day"><span>${localDate.toLocaleDateString('bn-BD')} (আজ)</span> <span>${mainTithiInfo.name}</span></li>`;
            for (let i = 1; i <= 7; i++) {
                const nextDate = new Date(localDate);
                nextDate.setDate(localDate.getDate() + i);
                const tithiInfo = getTithiInfo(nextDate);
                let className = '';
                if(tithiInfo.name === 'পূর্ণিমা') className = 'highlight-purnima';
                if(tithiInfo.name === 'অমাবস্যা') className = 'highlight-amavasya';
                if(tithiInfo.name === 'একাদশী') className = 'highlight-ekadashi';
                extraInfoHTML += `<li class="${className}"><span>${nextDate.toLocaleDateString('bn-BD')}</span> <span>${tithiInfo.name}</span></li>`;
            }
             extraInfoHTML += '</ul></div>';
            resultDiv.innerHTML = resultText + extraInfoHTML;
            resultDiv.style.display = 'block';
            saveCalculationToHistory('bengali-date', { gregorianDate: dateInput }, resultText.replace(/<[^>]*>/g, ' '));
        }


        function calculateElectricityBill() {
            const prevReading = parseFloat(document.getElementById('electricity-prev').value);
            const currentReading = parseFloat(document.getElementById('electricity-current').value);
            const resultDiv = document.getElementById('electricity-result');
            const lang = 'bn';

            if (isNaN(prevReading) || isNaN(currentReading) || currentReading < prevReading) {
                resultDiv.innerHTML = translations[lang].elec_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }

            const units = currentReading - prevReading;
            const slabs = electricityRates.slabs;

            let remainingUnits = units;
            let totalBill = 0;
            let lastLimit = 0;
            let resultHTML = `<div class="result-details">`;
            resultHTML += `${translations[lang].elec_result_summary.replace('${units}', units.toFixed(2))}<hr style="border-color: var(--border-color); margin: 10px 0;">`;
            
            for (let i = 0; i < slabs.length; i++) {
                const slab = slabs[i];
                const slabUnits = Math.min(remainingUnits, slab.limit - lastLimit);

                if (slabUnits > 0) {
                    const slabCost = slabUnits * slab.rate;
                    totalBill += slabCost;
                    const translationKey = `elec_result_step${i+1}`;
                    
                    let limitText = isFinite(slab.limit) ? slab.limit : '';
                    let prevLimitText = (lastLimit + 1);

                    resultHTML += `${translations[lang][translationKey]
                        .replace('${units}', slabUnits.toFixed(2))
                        .replace('${rate}', slab.rate.toFixed(2))
                        .replace('${cost}', slabCost.toFixed(2))
                        .replace('${limit}', limitText)
                        .replace('${prev_limit}', prevLimitText)
                    }<br>`;
                }
                
                remainingUnits -= slabUnits;
                lastLimit = slab.limit;

                if (remainingUnits <= 0) break;
            }
            
            resultHTML += `<div class="total">${translations[lang].elec_result_total.replace('${bill}', totalBill.toFixed(2))}</div>`;
            resultHTML += `</div>`;
            
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';
            saveCalculationToHistory('electricity', { prevReading, currentReading }, resultHTML);
        }


        function calculateLandArea() {
            const length = parseFloat(document.getElementById("land-length").value) || 0, width = parseFloat(document.getElementById("land-width").value) || 0, unit = document.getElementById("land-unit").value;
            const resultDiv = document.getElementById("land-result");
            const areaSqft = length * width;
            const conversions = { sqft: 1, sqm: 0.092903, katha: 1 / 720, bigha: 1 / 14400, acre: 1 / 43560, hectare: 1 / 107639 };
            const resultValue = (areaSqft * conversions[unit]).toFixed(4);
            const resultText = `<strong>${resultValue}</strong>`;
            document.getElementById("land-area").innerHTML = resultText;
            resultDiv.style.display = "block";
            saveCalculationToHistory('land', { length, width, unit }, `${resultValue} ${unit}`);
        }
        
        function calculateZakat() {
            const lang = 'bn';
            const tr = translations[lang];
            const resultDiv = document.getElementById("zakat-result");
            
            const cash = parseFloat(document.getElementById("zakat-cash").value) || 0;
            const goldGrams = parseFloat(document.getElementById("zakat-gold-grams").value) || 0;
            const goldRate = parseFloat(document.getElementById("zakat-gold-rate").value) || 0;
            const silverGrams = parseFloat(document.getElementById("zakat-silver-grams").value) || 0;
            const silverRate = parseFloat(document.getElementById("zakat-silver-rate").value) || 0;
            const business = parseFloat(document.getElementById("zakat-business").value) || 0;
            const shares = parseFloat(document.getElementById("zakat-shares").value) || 0;
            const debt = parseFloat(document.getElementById("zakat-debt").value) || 0;

            const goldValue = goldGrams * goldRate;
            const silverValue = silverGrams * silverRate;
            
            const totalAssets = cash + goldValue + silverValue + business + shares;

            if (totalAssets <= 0) {
                resultDiv.innerHTML = tr.zakat_invalid_input;
                resultDiv.style.display = "block";
                return;
            }
            
            const netAssets = totalAssets - debt;
            const nisab = (calculatorSettings?.zakat?.nisab) || 50000;

            let resultText = '';
            if (netAssets >= nisab) {
                const zakatAmount = netAssets * 0.025;
                resultText = `
                    <div class="result-details">
                        ${tr.zakat_result_total_assets} <strong>${totalAssets.toFixed(2)} টাকা</strong><br>
                        ${tr.zakat_result_total_debt} <strong>${debt.toFixed(2)} টাকা</strong>
                        <hr style="border-color: var(--border-color); margin: 8px 0;">
                        ${tr.zakat_result_net_assets} <strong>${netAssets.toFixed(2)} টাকা</strong>
                        <div class="total" style="font-size: 1.2rem;">
                            ${tr.zakat_result_payable} <strong>${zakatAmount.toFixed(2)} টাকা</strong>
                        </div>
                    </div>
                `;
            } else {
                resultText = `
                    <div class="result-details">
                        ${tr.zakat_result_net_assets} <strong>${netAssets.toFixed(2)} টাকা</strong><br>
                        <p style="margin-top: 10px;">${tr.zakat_not_applicable}</p>
                    </div>
                `;
            }

            resultDiv.innerHTML = resultText;
            resultDiv.style.display = "block";
            const inputs = { cash, goldGrams, goldRate, silverGrams, silverRate, business, shares, debt };
            saveCalculationToHistory('zakat', inputs, resultText.replace(/<[^>]*>/g, ' ').replace(/\s\s+/g, '\n'));
        }

        
        function calculateTax() {
            const income = parseFloat(document.getElementById("tax-income").value) || 0;
            const investment = parseFloat(document.getElementById("tax-investment").value) || 0;
            const resultDiv = document.getElementById("tax-result");
            const taxAmountDiv = document.getElementById("tax-amount");
            const lang = 'bn';

            let taxableIncome = income > taxSettings.taxFreeLimit ? income - taxSettings.taxFreeLimit : 0;
            let tax = 0;
            let incomeLeftToTax = taxableIncome;
            
            if (taxableIncome > 0) {
                for (const slab of taxSettings.slabs) {
                    if (incomeLeftToTax <= 0) break;
                    const taxableInThisSlab = Math.min(incomeLeftToTax, slab.amount);
                    tax += taxableInThisSlab * slab.rate;
                    incomeLeftToTax -= taxableInThisSlab;
                }
            }
            const maxRebateInvestment = income * 0.20;
            const rebateEligibleInvestment = Math.min(investment, maxRebateInvestment);
            const rebate = rebateEligibleInvestment * 0.15;
            const finalTax = Math.max(0, tax - rebate);
            const resultText = `<strong>${finalTax.toFixed(2)}</strong>`;
            taxAmountDiv.innerHTML = resultText;
            resultDiv.style.display = "block";
            saveCalculationToHistory('tax', { income, investment }, resultText);
        }

        function calculateInheritance() {
            const lang = 'bn';
            const tr = translations[lang];
            const resultDiv = document.getElementById('inheritance-result');

            const money = parseFloat(document.getElementById('inheritance-money').value) || 0;
            const land = parseFloat(document.getElementById('inheritance-land-value').value) || 0;
            const landUnit = document.getElementById('inheritance-land-unit').value;
            const otherAssets = parseFloat(document.getElementById('inheritance-other').value) || 0;

            const wives = parseInt(document.getElementById('inheritance-wife').value) || 0;
            const husband = parseInt(document.getElementById('inheritance-husband').value) || 0;
            const father = parseInt(document.getElementById('inheritance-father').value) || 0;
            const mother = parseInt(document.getElementById('inheritance-mother').value) || 0;
            const sons = parseInt(document.getElementById('inheritance-sons').value) || 0;
            const daughters = parseInt(document.getElementById('inheritance-daughters').value) || 0;

            if (money <= 0 && land <= 0 && otherAssets <= 0) {
                resultDiv.innerHTML = tr.inheritance_error_no_property;
                resultDiv.style.display = 'block';
                return;
            }
            if (wives > 0 && husband > 0) {
                resultDiv.innerHTML = tr.inheritance_error_spouse;
                resultDiv.style.display = 'block';
                return;
            }
            if (wives === 0 && husband === 0 && father === 0 && mother === 0 && sons === 0 && daughters === 0) {
                 resultDiv.innerHTML = tr.inheritance_no_heirs;
                 resultDiv.style.display = 'block';
                 return;
            }

            const totalMoneyValue = money + otherAssets;
            let remainingFraction = 1.0;
            let results = [];
            let hasChildren = sons > 0 || daughters > 0;

            const addResult = (heirKey, count, fraction) => {
                const shareMoney = totalMoneyValue * fraction;
                const shareLand = land * fraction;
                let heirText = (count > 1) ? `${count} ${tr[heirKey]} ${tr.inheritance_result_jointly}` : tr[heirKey];
                
                let resultLine = `<strong>${heirText} ${tr.inheritance_result_gets}</strong><br>`;
                if (shareMoney > 0) resultLine += `&nbsp;&nbsp;• টাকা: ${shareMoney.toFixed(2)}<br>`;
                if (shareLand > 0) resultLine += `&nbsp;&nbsp;• জমি: ${shareLand.toFixed(4)} ${landUnit}<br>`;
                results.push(resultLine);
                remainingFraction -= fraction;
            };

            if (husband > 0) addResult('inheritance_result_husband', 1, hasChildren ? 1 / 4 : 1 / 2);
            if (wives > 0) addResult('inheritance_result_wife', wives, hasChildren ? 1 / 8 : 1 / 4);
            let fatherFraction = 0;
            let motherFraction = 0;
            if (father > 0) fatherFraction = 1/6;
            if (mother > 0) motherFraction = 1/6;
            if (father > 0) { results.push(`<strong>${tr.inheritance_result_father} ${tr.inheritance_result_gets}</strong><br>`); remainingFraction -= fatherFraction; }
             if (mother > 0) { results.push(`<strong>${tr.inheritance_result_mother} ${tr.inheritance_result_gets}</strong><br>`); remainingFraction -= motherFraction; }
            if (hasChildren && remainingFraction > 0.0001) {
                const totalParts = (sons * 2) + daughters;
                const sharePerPart = remainingFraction / totalParts;
                const sonFraction = sharePerPart * 2;
                const daughterFraction = sharePerPart;
                if (sons > 0) {
                    const shareMoney = totalMoneyValue * sonFraction;
                    const shareLand = land * sonFraction;
                    let resultLine = `<strong>${tr.inheritance_result_each_son} ${tr.inheritance_result_gets}</strong><br>`;
                    if (shareMoney > 0) resultLine += `&nbsp;&nbsp;• টাকা: ${shareMoney.toFixed(2)}<br>`;
                    if (shareLand > 0) resultLine += `&nbsp;&nbsp;• জমি: ${shareLand.toFixed(4)} ${landUnit}<br>`;
                    results.push(resultLine);
                }
                if (daughters > 0) {
                    const shareMoney = totalMoneyValue * daughterFraction;
                    const shareLand = land * daughterFraction;
                    let resultLine = `<strong>${tr.inheritance_result_each_daughter} ${tr.inheritance_result_gets}</strong><br>`;
                    if (shareMoney > 0) resultLine += `&nbsp;&nbsp;• টাকা: ${shareMoney.toFixed(2)}<br>`;
                    if (shareLand > 0) resultLine += `&nbsp;&nbsp;• জমি: ${shareLand.toFixed(4)} ${landUnit}<br>`;
                    results.push(resultLine);
                }
            } else if (remainingFraction > 0.0001 && father > 0) {
                fatherFraction += remainingFraction;
            }
            if (father > 0) {
                 const shareMoney = totalMoneyValue * fatherFraction;
                 const shareLand = land * fatherFraction;
                 let idx = results.findIndex(r => r.includes(tr.inheritance_result_father));
                 if (shareMoney > 0) results[idx] += `&nbsp;&nbsp;• টাকা: ${shareMoney.toFixed(2)}<br>`;
                 if (shareLand > 0) results[idx] += `&nbsp;&nbsp;• জমি: ${shareLand.toFixed(4)} ${landUnit}<br>`;
            }
            if (mother > 0) {
                 const shareMoney = totalMoneyValue * motherFraction;
                 const shareLand = land * motherFraction;
                 let idx = results.findIndex(r => r.includes(tr.inheritance_result_mother));
                 if (shareMoney > 0) results[idx] += `&nbsp;&nbsp;• টাকা: ${shareMoney.toFixed(2)}<br>`;
                 if (shareLand > 0) results[idx] += `&nbsp;&nbsp;• জমি: ${shareLand.toFixed(4)} ${landUnit}<br>`;
            }

            const finalResultText = `${tr.inheritance_result_title}<br><br>${results.join('<hr style="border-color: var(--border-color); margin: 8px 0;">')}`;
            resultDiv.innerHTML = finalResultText;
            resultDiv.style.display = 'block';
            const inputs = { money, land: `${land} ${landUnit}`, otherAssets, wives, husband, father, mother, sons, daughters };
            saveCalculationToHistory('inheritance', inputs, finalResultText);
        }

        
        function toggleCrewList(event) {
            if(event.preventDefault) event.preventDefault();
            const container = document.getElementById('crew-details-container');
            const icon = document.getElementById('crew-list-icon');
            const isHidden = container.style.display === 'none';
            
            container.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function generateCrewInputs() {
            const container = document.getElementById('crew-details-container');
            const lang = 'bn';
            const crewData = [
                { count: parseInt(document.getElementById('fishing-majhi-count').value) || 0, name: 'মাঝি', role: 'majhi' },
                { count: parseInt(document.getElementById('fishing-baburchi-count').value) || 0, name: 'বাবুর্চি', role: 'baburchi' },
                { count: parseInt(document.getElementById('fishing-crew-count').value) || 0, name: 'জেলে', role: 'crew' }
            ];
            container.innerHTML = '';
            let totalCrew = 0;
            crewData.forEach(group => {
                for (let i = 1; i <= group.count; i++) {
                    totalCrew++;
                    const div = document.createElement('div');
                    div.className = 'individual-crew-input';
                    div.innerHTML = `<input type="text" id="name_${group.role}_${i}" placeholder="${group.name} ${i} নাম"><input type="number" id="advance_${group.role}_${i}" value="0" min="0" placeholder="অগ্রিম">`;
                    container.appendChild(div);
                }
            });
            if (totalCrew === 0) {
                container.innerHTML = `<p style="opacity: 0.7; text-align: center;">(জেলেদের সংখ্যা লিখলে এখানে নাম ও অগ্রিম লেখার ঘর তৈরি হবে)</p>`;
            }
        }
        
        function calculateFishingShares() {
            const resultDiv = document.getElementById('fishing-result');
            const lang = 'bn';
            resultDiv.innerHTML = '';
            const totalEarnings = parseFloat(document.getElementById('fishing-earnings').value) || 0;
            
            const totalExpenses = calculateFishingExpenses();
            const expenseMode = document.querySelector('input[name="fishing-expense-method"]:checked').value;

            const ownerPercentage = parseFloat(document.getElementById('fishing-owner-share').value) || 0;
            const majhiCount = parseInt(document.getElementById('fishing-majhi-count').value) || 0;
            const majhiShareVal = parseFloat(document.getElementById('fishing-majhi-share').value) || 0;
            const baburchiCount = parseInt(document.getElementById('fishing-baburchi-count').value) || 0;
            const baburchiShareVal = parseFloat(document.getElementById('fishing-baburchi-share').value) || 0;
            const regularCrewCount = parseInt(document.getElementById('fishing-crew-count').value) || 0;
            
            const netEarnings = totalEarnings - totalExpenses;

            if (totalEarnings <= 0 || netEarnings < 0) {
                resultDiv.innerHTML = translations[lang].fishing_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }

            const ownerShareAmount = netEarnings * (ownerPercentage / 100);
            const amountForCrew = netEarnings - ownerShareAmount;
            let totalParts = (majhiCount * majhiShareVal) + (baburchiCount * baburchiShareVal) + (regularCrewCount * 1);
            if (totalParts <= 0) {
                resultDiv.innerHTML = translations[lang].fishing_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }
            const valuePerShare = amountForCrew / totalParts;

            let summaryHTML = `<h3 style="text-align:center;">${translations[lang].tab_fishing_option}</h3><br>` 
            summaryHTML += translations[lang].fishing_result_summary_title + '<br>';
            // Add expense summary if detailed mode
            if (expenseMode === 'details') {
                 summaryHTML += `মোট খরচ: <strong>${totalExpenses.toFixed(2)} টাকা</strong><br>`;
            }
            summaryHTML += translations[lang].fishing_result_net_earnings.replace('${netEarnings}', netEarnings.toFixed(2)) + '<br>';
            summaryHTML += translations[lang].fishing_result_owner_share.replace('${ownerShare}', ownerShareAmount.toFixed(2)) + '<br>';
            summaryHTML += translations[lang].fishing_result_crew_total.replace('${crewTotal}', amountForCrew.toFixed(2)) + '<br>';
            summaryHTML += translations[lang].fishing_result_share_value.replace('${shareValue}', valuePerShare.toFixed(2));
            summaryHTML += '<hr style="margin: 10px 0; border-color: var(--border-color);">';
            
            let distributionHTML = translations[lang].fishing_result_distribution_title + '<br>';
            let crewDetailsForHistory = [];
            const crewData = [
                { count: majhiCount, share: majhiShareVal, name: 'মাঝি', role: 'majhi' },
                { count: baburchiCount, share: baburchiShareVal, name: 'বাবুর্চি', role: 'baburchi' },
                { count: regularCrewCount, share: 1, name: 'জেলে', role: 'crew' }
            ];
            crewData.forEach(group => {
                for (let i = 1; i <= group.count; i++) {
                    const nameInput = document.getElementById(`name_${group.role}_${i}`);
                    const advanceInput = document.getElementById(`advance_${group.role}_${i}`);
                    const name = nameInput ? (nameInput.value.trim() || `${group.name} ${i}`) : `${group.name} ${i}`;
                    const advance = advanceInput ? parseFloat(advanceInput.value) || 0 : 0;
                    const shareAmount = valuePerShare * group.share;
                    const finalPay = shareAmount - advance;
                    crewDetailsForHistory.push({ name, advance, share: group.share });
                    distributionHTML += translations[lang].fishing_result_person_share.replace('${name}', name).replace('${shareCount}', group.share).replace('${share}', shareAmount.toFixed(2)).replace('${advance}', advance.toFixed(2)).replace('${final}', finalPay.toFixed(2)) + '<br>';
                }
            });
            
            resultDiv.innerHTML = summaryHTML + distributionHTML;
            resultDiv.style.display = 'block';
            const inputs = { totalEarnings, totalExpenses, expenseMode, ownerPercentage, majhiCount, majhiShareVal, baburchiCount, baburchiShareVal, regularCrewCount, crewDetails: crewDetailsForHistory };
            saveCalculationToHistory('fishing', inputs, summaryHTML + distributionHTML);
        }

        function toggleLock(tabId) {
            const button = document.getElementById(`lock-button-${tabId}`);
            const icon = button.querySelector('i');
            const span = button.querySelector('span');
            const isLocked = button.getAttribute('data-locked') === 'true';
            const lang = 'bn';
            
            const inputsToToggle = document.querySelectorAll(`#${tabId}-inputs input, #${tabId}-inputs select`);

            inputsToToggle.forEach(input => {
                if (input.disabled && input.title === "সাধারণ জেলের ভাগ ১") {
                } else {
                    input.disabled = !isLocked;
                }
            });

            if (isLocked) {
                button.setAttribute('data-locked', 'false');
                icon.className = 'fas fa-unlock';
                span.textContent = translations[lang].lock_inputs_btn;
            } else {
                button.setAttribute('data-locked', 'true');
                icon.className = 'fas fa-lock';
                span.textContent = translations[lang].unlock_inputs_btn;
            }
        }
        
        function togglePaintCarpetInputs() {
            const type = document.getElementById('pc-type').value;
            const heightInput = document.getElementById('pc-height');
            const paintOnlyDiv = document.getElementById('pc-paint-only-inputs');

            if (type === 'paint') {
                heightInput.style.display = 'block';
                paintOnlyDiv.style.display = 'block';
            } else { // carpet
                heightInput.style.display = 'none';
                paintOnlyDiv.style.display = 'none';
            }
        }

        function calculatePaintCarpet() {
            const type = document.getElementById('pc-type').value;
            const length = parseFloat(document.getElementById('pc-length').value) || 0;
            const width = parseFloat(document.getElementById('pc-width').value) || 0;
            const height = parseFloat(document.getElementById('pc-height').value) || 0;
            const resultDiv = document.getElementById('pc-result');
            const lang = 'bn';

            if (length <= 0 || width <= 0) {
                resultDiv.innerHTML = translations[lang].pc_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }
            let resultText, inputs = { type, length, width };

            if (type === 'carpet') {
                const area = length * width;
                resultText = translations[lang].pc_carpet_result.replace(/\${area}/g, area.toFixed(2));
            } else { // paint
                if (height <= 0) {
                    resultDiv.innerHTML = translations[lang].pc_invalid_input;
                    resultDiv.style.display = 'block';
                    return;
                }
                const doors = parseInt(document.getElementById('pc-doors').value) || 0;
                const windows = parseInt(document.getElementById('pc-windows').value) || 0;
                inputs.height = height;
                inputs.doors = doors;
                inputs.windows = windows;
                const wallArea = 2 * (length + width) * height;
                const exclusionArea = (doors * 20) + (windows * 15);
                const finalArea = wallArea - exclusionArea;
                const paintNeeded = finalArea / 350;
                
                resultText = translations[lang].pc_paint_result.replace('${area}', finalArea.toFixed(2)).replace('${paint}', paintNeeded.toFixed(2));
            }
            resultDiv.innerHTML = resultText;
            resultDiv.style.display = 'block';
            saveCalculationToHistory('paint-carpet', inputs, resultText);
        }

        function toggleInvestmentInputs() {
            const type = document.getElementById('inv-type').value;
            if (type === 'sip') {
                document.getElementById('inv-sip-amount-group').style.display = 'block';
                document.getElementById('inv-principal-group').style.display = 'none';
            } else { // compound
                document.getElementById('inv-sip-amount-group').style.display = 'none';
                document.getElementById('inv-principal-group').style.display = 'block';
            }
        }
        
        function calculateInvestment() {
            const type = document.getElementById('inv-type').value;
            const rate = parseFloat(document.getElementById('inv-rate').value) || 0;
            const years = parseFloat(document.getElementById('inv-years').value) || 0;
            const months_input = parseFloat(document.getElementById('inv-months').value) || 0;
            const resultDiv = document.getElementById('inv-result');
            const lang = 'bn';
            
            let totalInvested = 0, totalValue = 0;
            const totalMonths = (years * 12) + months_input;
            const totalYears = totalMonths / 12;
            let inputs = { type, rate, years, months: months_input };

            if (!rate || totalMonths <= 0) {
                resultDiv.innerHTML = translations[lang].inv_invalid_input;
                resultDiv.style.display = 'block';
                return;
            }

            const rateDecimal = rate / 100;

            if (type === 'sip') {
                const monthlyInvestment = parseFloat(document.getElementById('inv-sip-amount').value) || 0;
                inputs.monthlyInvestment = monthlyInvestment;
                if (!monthlyInvestment || monthlyInvestment <= 0) {
                    resultDiv.innerHTML = translations[lang].inv_invalid_input; resultDiv.style.display = 'block'; return;
                }
                const monthlyRate = rateDecimal / 12;
                totalValue = monthlyInvestment * ( (Math.pow(1 + monthlyRate, totalMonths) - 1) / monthlyRate ) * (1 + monthlyRate);
                totalInvested = monthlyInvestment * totalMonths;

            } else { // compound
                const principal = parseFloat(document.getElementById('inv-principal').value) || 0;
                inputs.principal = principal;
                 if (!principal || principal <= 0) {
                    resultDiv.innerHTML = translations[lang].inv_invalid_input; resultDiv.style.display = 'block'; return;
                }
                totalValue = principal * Math.pow((1 + rateDecimal), totalYears);
                totalInvested = principal;
            }

            const totalReturns = totalValue - totalInvested;
            const resultText = translations[lang].inv_result
                .replace('${invested}', totalInvested.toLocaleString('en-IN', {maximumFractionDigits: 0}))
                .replace('${returns}', totalReturns.toLocaleString('en-IN', {maximumFractionDigits: 0}))
                .replace('${total}', totalValue.toLocaleString('en-IN', {maximumFractionDigits: 0}));
            resultDiv.innerHTML = resultText;
            resultDiv.style.display = 'block';
            saveCalculationToHistory('investment', inputs, resultText);
        }


        function calculateAllConstruction() {
            const lang = 'bn';
            const resultDiv = document.getElementById('con-all-in-one-result');
            const consSettings = calculatorSettings?.construction || {};
            const bricksSettings = consSettings.bricks || {};
            const plasterSettings = consSettings.plaster || {};
            const concreteSettings = consSettings.concrete || {};
            const steelSettings = consSettings.steel || {};

            let finalResultHTML = '<div class="result-details">';
            let hasCalculatedSomething = false;

            const brickLength = parseFloat(document.getElementById('all-con-wall-length').value) || 0;
            if (brickLength > 0) {
                const brickHeight = parseFloat(document.getElementById('all-con-wall-height').value) || 0;
                const thickness = parseFloat(document.getElementById('all-con-wall-thickness').value);
                const mortarRatio = document.getElementById('all-con-mortar-ratio').value.split(':').map(Number);

                const wallVolumeCFT = brickLength * brickHeight * (thickness / 12);
                const mortarVolumeCFT = wallVolumeCFT * ((bricksSettings.mortarPercent || 25) / 100);
                const bricksPerCFT = thickness === 5 ? (bricksSettings.bpc5 || 5.5) : (bricksSettings.bpc10 || 11);
                const totalBricks = Math.ceil(wallVolumeCFT * bricksPerCFT * (1 + ((bricksSettings.wastagePercent || 5) / 100)));
                const dryMortarVolume = mortarVolumeCFT * (bricksSettings.dryFactor || 1.5);
                const ratioSum = mortarRatio[0] + mortarRatio[1];
                const cementVolume = (dryMortarVolume * mortarRatio[0]) / ratioSum;
                const sandVolume = (dryMortarVolume * mortarRatio[1]) / ratioSum;
                const cementBags = Math.ceil(cementVolume / (bricksSettings.cementBagVolume || 1.25));
                
                finalResultHTML += `<strong>ইটের গাঁথুনি:</strong><br>
                - মোট ইট: <strong>${totalBricks} টি</strong><br>
                - সিমেন্ট: <strong>${cementBags} ব্যাগ</strong><br>
                - বালি: <strong>${sandVolume.toFixed(2)} CFT</strong><hr class="divider" style="margin: 8px 0;">`;
                hasCalculatedSomething = true;
            }

            const plasterLength = parseFloat(document.getElementById('all-plaster-wall-length').value) || 0;
            if (plasterLength > 0) {
                const plasterHeight = parseFloat(document.getElementById('all-plaster-wall-height').value) || 0;
                const thicknessMM = parseFloat(document.getElementById('all-plaster-thickness').value) || 0;
                const mortarRatio = document.getElementById('all-plaster-mortar-ratio').value.split(':').map(Number);
                
                const thicknessFT = thicknessMM / (25.4 * 12);
                const wetVolumeCFT = plasterLength * plasterHeight * thicknessFT;
                const dryVolumeCFT = wetVolumeCFT * (plasterSettings.dryFactor || 1.33);
                const ratioSum = mortarRatio[0] + mortarRatio[1];
                const cementVolume = (dryVolumeCFT * mortarRatio[0]) / ratioSum;
                const sandVolume = (dryVolumeCFT * mortarRatio[1]) / ratioSum;
                const cementBags = Math.ceil(cementVolume / (bricksSettings.cementBagVolume || 1.25));

                finalResultHTML += `<strong>প্লাস্টার:</strong><br>
                - সিমেন্ট: <strong>${cementBags} ব্যাগ</strong><br>
                - বালি: <strong>${sandVolume.toFixed(2)} CFT</strong><hr class="divider" style="margin: 8px 0;">`;
                hasCalculatedSomething = true;
            }

            const concreteLength = parseFloat(document.getElementById('all-concrete-length').value) || 0;
            if (concreteLength > 0) {
                const concreteWidth = parseFloat(document.getElementById('all-concrete-width').value) || 0;
                const concreteHeight = parseFloat(document.getElementById('all-concrete-height').value) || 0;
                const mixRatio = document.getElementById('all-concrete-mix-ratio').value.split(':').map(Number);
                const elementType = document.getElementById('all-steel-element-type').value;

                const wetVolumeCFT = concreteLength * concreteWidth * concreteHeight;
                const dryVolumeCFT = wetVolumeCFT * (concreteSettings.dryFactor || 1.54);
                const ratioSum = mixRatio[0] + mixRatio[1] + mixRatio[2];
                const cementVolume = (dryVolumeCFT * mixRatio[0]) / ratioSum;
                const sandVolume = (dryVolumeCFT * mixRatio[1]) / ratioSum;
                const aggregateVolume = (dryVolumeCFT * mixRatio[2]) / ratioSum;
                const cementBags = Math.ceil(cementVolume / (bricksSettings.cementBagVolume || 1.25));
                
                const steelPercentages = { 
                    slab: (steelSettings.slabPercent || 1) / 100, 
                    beam: (steelSettings.beamPercent || 2) / 100, 
                    column: (steelSettings.columnPercent || 2.5) / 100, 
                    footing: (steelSettings.footingPercent || 0.8) / 100 
                };
                const steelDensity = steelSettings.density || 222.24;
                const steelVolume = wetVolumeCFT * steelPercentages[elementType];
                const steelWeight = steelVolume * steelDensity;

                finalResultHTML += `<strong>কংক্রিট ও স্টিল:</strong><br>
                - সিমেন্ট: <strong>${cementBags} ব্যাগ</strong><br>
                - বালি: <strong>${sandVolume.toFixed(2)} CFT</strong><br>
                - খোয়া: <strong>${aggregateVolume.toFixed(2)} CFT</strong><br>
                - স্টিল: <strong>${steelWeight.toFixed(2)} কেজি</strong>`;
                hasCalculatedSomething = true;
            }

            if (!hasCalculatedSomething) {
                resultDiv.innerHTML = translations[lang].con_invalid_input;
            } else {
                 resultDiv.innerHTML = finalResultHTML + '</div>';
            }
            resultDiv.style.display = 'block';
        }


        function calculateConstruction(type) {
            const lang = 'bn';
            const consSettings = calculatorSettings?.construction || {};
            const bricksSettings = consSettings.bricks || {};
            const plasterSettings = consSettings.plaster || {};
            const concreteSettings = consSettings.concrete || {};
            const steelSettings = consSettings.steel || {};
            let inputs = {}, resultText, resultDiv;

            if (type === 'bricks') {
                const length = parseFloat(document.getElementById('con-wall-length').value) || 0;
                const height = parseFloat(document.getElementById('con-wall-height').value) || 0;
                const thickness = parseFloat(document.getElementById('con-wall-thickness').value);
                const mortarRatio = document.getElementById('con-mortar-ratio').value.split(':').map(Number);
                resultDiv = document.getElementById('con-bricks-result');
                inputs = { type, length, height, thickness, mortarRatio: mortarRatio.join(':') };

                if (length <= 0 || height <= 0) {
                    resultDiv.innerHTML = translations[lang].con_invalid_input; resultDiv.style.display = 'block'; return;
                }

                const wallVolumeCFT = length * height * (thickness / 12);
                const mortarVolumeCFT = wallVolumeCFT * ((bricksSettings.mortarPercent || 25) / 100);
                const bricksPerCFT = thickness === 5 ? (bricksSettings.bpc5 || 5.5) : (bricksSettings.bpc10 || 11);
                const totalBricks = Math.ceil(wallVolumeCFT * bricksPerCFT * (1 + ((bricksSettings.wastagePercent || 5) / 100)));
                const dryMortarVolume = mortarVolumeCFT * (bricksSettings.dryFactor || 1.5);
                const ratioSum = mortarRatio[0] + mortarRatio[1];
                const cementVolume = (dryMortarVolume * mortarRatio[0]) / ratioSum;
                const sandVolume = (dryMortarVolume * mortarRatio[1]) / ratioSum;
                const cementBags = Math.ceil(cementVolume / (bricksSettings.cementBagVolume || 1.25));

                resultText = translations[lang].con_bricks_result.replace('${bricks}', totalBricks).replace('${cement}', cementBags).replace('${sand}', sandVolume.toFixed(2));
                resultDiv.innerHTML = resultText;
                resultDiv.style.display = 'block';

            } else if (type === 'plaster') {
                const length = parseFloat(document.getElementById('plaster-wall-length').value) || 0;
                const height = parseFloat(document.getElementById('plaster-wall-height').value) || 0;
                const thicknessMM = parseFloat(document.getElementById('plaster-thickness').value) || 0;
                const mortarRatio = document.getElementById('plaster-mortar-ratio').value.split(':').map(Number);
                resultDiv = document.getElementById('con-plaster-result');
                inputs = { type, length, height, thicknessMM, mortarRatio: mortarRatio.join(':') };
                
                if (length <= 0 || height <= 0 || thicknessMM <=0) {
                    resultDiv.innerHTML = translations[lang].con_invalid_input; resultDiv.style.display = 'block'; return;
                }

                const thicknessFT = thicknessMM / (25.4 * 12);
                const wetVolumeCFT = length * height * thicknessFT;
                const dryVolumeCFT = wetVolumeCFT * (plasterSettings.dryFactor || 1.33);
                const ratioSum = mortarRatio[0] + mortarRatio[1];
                const cementVolume = (dryVolumeCFT * mortarRatio[0]) / ratioSum;
                const sandVolume = (dryVolumeCFT * mortarRatio[1]) / ratioSum;
                const cementBags = Math.ceil(cementVolume / (bricksSettings.cementBagVolume || 1.25));

                resultText = translations[lang].con_plaster_result.replace('${cement}', cementBags).replace('${sand}', sandVolume.toFixed(2));
                resultDiv.innerHTML = resultText;
                resultDiv.style.display = 'block';

            } else if (type === 'concrete') {
                const length = parseFloat(document.getElementById('concrete-length').value) || 0;
                const width = parseFloat(document.getElementById('concrete-width').value) || 0;
                const height = parseFloat(document.getElementById('concrete-height').value) || 0;
                const mixRatio = document.getElementById('concrete-mix-ratio').value.split(':').map(Number);
                resultDiv = document.getElementById('con-concrete-result');
                inputs = { type, length, width, height, mixRatio: mixRatio.join(':') };
                
                if (length <= 0 || width <= 0 || height <= 0) {
                    resultDiv.innerHTML = translations[lang].con_invalid_input; resultDiv.style.display = 'block'; return;
                }

                const wetVolumeCFT = length * width * height;
                const dryVolumeCFT = wetVolumeCFT * (concreteSettings.dryFactor || 1.54);
                const ratioSum = mixRatio[0] + mixRatio[1] + mixRatio[2];
                const cementVolume = (dryVolumeCFT * mixRatio[0]) / ratioSum;
                const sandVolume = (dryVolumeCFT * mixRatio[1]) / ratioSum;
                const aggregateVolume = (dryVolumeCFT * mixRatio[2]) / ratioSum;
                const cementBags = Math.ceil(cementVolume / (bricksSettings.cementBagVolume || 1.25));

                resultText = translations[lang].con_concrete_result.replace('${cement}', cementBags).replace('${sand}', sandVolume.toFixed(2)).replace('${aggregate}', aggregateVolume.toFixed(2));
                resultDiv.innerHTML = resultText;
                resultDiv.style.display = 'block';
            
            } else if (type === 'steel') {
                const concreteVolume = parseFloat(document.getElementById('steel-concrete-volume').value) || 0;
                const elementType = document.getElementById('steel-element-type').value;
                resultDiv = document.getElementById('con-steel-result');
                inputs = { type, concreteVolume, elementType };

                if (concreteVolume <= 0) {
                    resultDiv.innerHTML = translations[lang].con_invalid_input; resultDiv.style.display = 'block'; return;
                }
                
                const steelPercentages = { 
                    slab: (steelSettings.slabPercent || 1) / 100, 
                    beam: (steelSettings.beamPercent || 2) / 100, 
                    column: (steelSettings.columnPercent || 2.5) / 100, 
                    footing: (steelSettings.footingPercent || 0.8) / 100 
                };
                const steelDensity = steelSettings.density || 222.24;
                
                const steelVolume = concreteVolume * steelPercentages[elementType];
                const steelWeight = steelVolume * steelDensity;

                resultText = translations[lang].con_steel_result.replace('${steel}', steelWeight.toFixed(2));
                resultDiv.innerHTML = resultText;
                resultDiv.style.display = 'block';
            }
            saveCalculationToHistory('construction', inputs, resultText);
        }


        const unitData = { length: { meter: 1, km: 1000, cm: 0.01, inch: 0.0254 }, area: { sqm: 1, acre: 4046.86 }, weight: { kg: 1, gram: 0.001, pound: 0.453592 }, volume: { liter: 1, ml: 0.001 }, temperature: { c: 'c', f: 'f', k: 'k' }};
        function populateUnits() {
            const category = document.getElementById("converter-category").value, fromUnit = document.getElementById("converter-from-unit"), toUnit = document.getElementById("converter-to-unit");
            fromUnit.innerHTML = ""; toUnit.innerHTML = "";
            for (const unit in unitData[category]) { fromUnit.innerHTML += `<option value="${unit}">${unit}</option>`; toUnit.innerHTML += `<option value="${unit}">${unit}</option>`; }
            if (Object.keys(unitData[category]).length > 1) toUnit.selectedIndex = 1;
        }
        function changeConverter() { populateUnits(); convertUnits(); }
        function convertUnits() {
            const category = document.getElementById("converter-category").value, fromValue = parseFloat(document.getElementById("converter-from-value").value) || 0, fromUnit = document.getElementById("converter-from-unit").value, toUnit = document.getElementById("converter-to-unit").value, resultInput = document.getElementById("converter-to-value");
            let result;
            if (category === "temperature") {
                if (fromUnit === toUnit) result = fromValue;
                else if (fromUnit === 'c') result = toUnit === 'f' ? (fromValue * 9 / 5) + 32 : fromValue + 273.15;
                else if (fromUnit === 'f') result = toUnit === 'c' ? (fromValue - 32) * 5 / 9 : ((fromValue - 32) * 5 / 9) + 273.15;
                else if (fromUnit === 'k') result = toUnit === 'c' ? fromValue - 273.15 : ((fromValue - 273.15) * 9 / 5) + 32;
            } else { result = fromValue * unitData[category][fromUnit] / unitData[category][toUnit]; }
            resultInput.value = result.toFixed(5);
        }

        // --- FARMING CALCULATOR LOGIC ---
        let individualSaleRowCounter = 0;

        function toggleFarmingWeightInputs(selectedValue) {
            const totalContainer = document.getElementById('farming-total-weight-container');
            const individualContainer = document.getElementById('farming-individual-weight-container');
            if (selectedValue === 'total') {
                totalContainer.style.display = 'block';
                individualContainer.style.display = 'none';
            } else {
                totalContainer.style.display = 'none';
                individualContainer.style.display = 'block';
            }
        }

        function generateFarmingSaleRows() {
            const lang = 'bn';
            const tr = translations[lang];
            let count = parseInt(document.getElementById('farming-generate-rows-count').value) || 0;
            const container = document.getElementById('farming-individual-sales-rows');
            
            if (count > 200) {
                showToast(tr.farming_performance_warning, 'error');
                count = 200;
            }

            container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                addIndividualFarmingSaleRow(true);
            }
            individualSaleRowCounter = count;
        }

        function addIndividualFarmingSaleRow(isGenerating = false) {
            if (!isGenerating) individualSaleRowCounter++;
            else individualSaleRowCounter = document.querySelectorAll('.farming-individual-sale-row').length + 1;
            
            const lang = 'bn';
            const tr = translations[lang];
            const container = document.getElementById('farming-individual-sales-rows');
            const newRow = document.createElement('div');
            newRow.className = 'farming-individual-sale-row';
            newRow.id = `farming-individual-row-${individualSaleRowCounter}`;
            
            newRow.innerHTML = `
                <label for="farming-weight-${individualSaleRowCounter}">${tr.farming_chick_no} ${individualSaleRowCounter}:</label>
                <input type="number" step="0.01" class="farming-individual-weight" id="farming-weight-${individualSaleRowCounter}" placeholder="${tr.farming_individual_weight_placeholder}">
                <button onclick="removeIndividualFarmingSaleRow(${individualSaleRowCounter})"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(newRow);
        }
        
        function removeIndividualFarmingSaleRow(rowId) {
            const row = document.getElementById(`farming-individual-row-${rowId}`);
            if (row) row.remove();
        }

        function toggleFarmingSaleRows(event) {
            if(event.preventDefault) event.preventDefault();
            const container = document.getElementById('farming-individual-sales-rows');
            const icon = document.getElementById('farming-rows-icon');
            const isHidden = container.style.display === 'none';
            
            container.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function resetFarmingTab() {
            document.querySelectorAll('#farming-inputs input').forEach(input => {
                if(input.type !== 'radio') input.value = '';
            });
            document.querySelector('input[name="farming-weight-method"][value="total"]').checked = true;
            toggleFarmingWeightInputs('total');
            document.getElementById('farming-individual-sales-rows').innerHTML = '';
            individualSaleRowCounter = 0;
            addIndividualFarmingSaleRow();
            document.getElementById('farming-result').style.display = 'none';
        }

        function calculateFarmingProfitLoss() {
            const lang = 'bn';
            const tr = translations[lang];
            const resultDiv = document.getElementById('farming-result');

            const chickCount = parseInt(document.getElementById('farming-chick-count').value) || 0;
            const chickPrice = parseFloat(document.getElementById('farming-chick-price').value) || 0;
            const feedCost = parseFloat(document.getElementById('farming-feed-cost').value) || 0;
            const medicineCost = parseFloat(document.getElementById('farming-medicine-cost').value) || 0;
            const otherCost = parseFloat(document.getElementById('farming-other-cost').value) || 0;
            const mortality = parseInt(document.getElementById('farming-mortality').value) || 0;
            const pricePerKg = parseFloat(document.getElementById('farming-price-per-kg').value) || 0;
            const weightMethod = document.querySelector('input[name="farming-weight-method"]:checked').value;

            if (chickCount <= 0 || pricePerKg <= 0) {
                resultDiv.innerHTML = `<p>${tr.farming_invalid_input}</p>`;
                resultDiv.style.display = 'block';
                return;
            }

            const chickCostTotal = chickCount * chickPrice;
            const totalInvestment = chickCostTotal + feedCost + medicineCost + otherCost;

            let totalSoldCount = 0;
            let totalSoldWeight = 0;
            let individualWeightsForHistory = [];

            if (weightMethod === 'total') {
                totalSoldWeight = parseFloat(document.getElementById('farming-total-weight').value) || 0;
                totalSoldCount = chickCount - mortality; 
            } else {
                const weightInputs = document.querySelectorAll('.farming-individual-weight');
                weightInputs.forEach(input => {
                    const weight = parseFloat(input.value);
                    if (weight && weight > 0) {
                        totalSoldWeight += weight;
                        totalSoldCount++;
                        individualWeightsForHistory.push(weight);
                    }
                });
            }

            if (totalSoldWeight <= 0) {
                resultDiv.innerHTML = `<p>অনুগ্রহ করে বিক্রিত মুরগির ওজন সঠিকভাবে লিখুন।</p>`;
                resultDiv.style.display = 'block';
                return;
            }
            
            const totalSaleAmount = totalSoldWeight * pricePerKg;
            const aliveChicks = chickCount - mortality;
            const costPerChick = aliveChicks > 0 ? totalInvestment / aliveChicks : 0;
            const costPerKg = totalSoldWeight > 0 ? totalInvestment / totalSoldWeight : 0;
            const netProfitLoss = totalSaleAmount - totalInvestment;

            let resultHTML = `<div class="result-details">
                <h4 style="text-align:center; color: var(--primary-color);">${tr.farming_result_title}</h4>
                <hr style="border-color: var(--border-color); margin: 8px 0;">
                <p>${tr.farming_total_chicks} <strong>${chickCount} টি</strong></p>
                <p>${tr.farming_total_investment} <strong>${totalInvestment.toFixed(2)} টাকা</strong></p>
                <ul style="padding-left: 20px;">
                    <li>${tr.farming_chick_cost} ${chickCostTotal.toFixed(2)} টাকা</li>
                    <li>${tr.farming_total_running_cost} ${(feedCost + medicineCost + otherCost).toFixed(2)} টাকা</li>
                </ul>
                <hr style="border-color: var(--border-color); margin: 8px 0;">
                <p>${tr.farming_total_sale} (${totalSoldCount} টি, ${totalSoldWeight.toFixed(2)} কেজি): <strong>${totalSaleAmount.toFixed(2)} টাকা</strong></p>
                <p>${tr.farming_avg_weight} <strong>${(totalSoldCount > 0 ? totalSoldWeight / totalSoldCount : 0).toFixed(2)} কেজি</strong></p>
                <p>${tr.farming_alive_chicks} <strong>${aliveChicks} টি</strong></p>
                <p>${tr.farming_production_cost_per_chick} <strong>${isFinite(costPerChick) ? costPerChick.toFixed(2) : 0} টাকা</strong></p>
                <p>${tr.farming_production_cost_per_kg} <strong>${isFinite(costPerKg) ? costPerKg.toFixed(2) : 0} টাকা</strong></p>
            `;
            
            if (netProfitLoss >= 0) {
                resultHTML += `<div class="total" style="color: var(--success-color);">${tr.farming_net_profit}: <strong>${netProfitLoss.toFixed(2)} টাকা</strong></div>`;
            } else {
                resultHTML += `<div class="total" style="color: var(--danger-color);">${tr.farming_net_loss}: <strong>${Math.abs(netProfitLoss).toFixed(2)} টাকা</strong></div>`;
            }
            
            resultHTML += `</div>`;
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';

            const inputs = {
                chickCount, chickPrice, feedCost, medicineCost, otherCost, mortality, pricePerKg,
                weightMethod,
                ...(weightMethod === 'total' ? { totalSoldWeight } : { individualWeights: individualWeightsForHistory })
            };
            saveCalculationToHistory('farming', inputs, resultHTML);
        }
        
        function initializeFirebaseFeatures() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyARxMfrvqwxGDCe6hhH-VPAra1r9swRrz4",
                    authDomain: "calculator-master-pro-61a4c.firebaseapp.com",
                    databaseURL: "https://calculator-master-pro-61a4c-default-rtdb.firebaseio.com",
                    projectId: "calculator-master-pro-61a4c",
                    storageBucket: "calculator-master-pro-61a4c.appspot.com",
                    messagingSenderId: "549411827335",
                    appId: "1:549411827335:android:6a23121f3a7e3741eb5222"
                };

                firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                const auth = firebase.auth();
                window.db = database;
                window.auth = auth;
                
                auth.onAuthStateChanged(user => {
                    updateLoginUI();
                    updatePremiumUI();
                });

                // displayAnnouncement definition needed here if separate function, assuming embedded logic or global
                if(typeof displayAnnouncement === 'function') displayAnnouncement(database); 
                else {
                     // Fallback simple announcement logic if function missing
                     database.ref('announcement').on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && data.message) {
                            currentAnnouncementMessage = data.message;
                            document.getElementById('app-announcement').innerHTML = data.message;
                            document.getElementById('app-announcement').style.display = 'block';
                            document.getElementById('modal-title').innerText = data.title || "ঘোষণা";
                            document.getElementById('modal-body').innerHTML = data.message.replace(/\n/g, '<br>');
                            document.querySelector('.notification-badge').style.display = 'block';
                        } else {
                            document.getElementById('app-announcement').style.display = 'none';
                            document.querySelector('.notification-badge').style.display = 'none';
                        }
                    });
                }

                // Load Settings logic
                database.ref('appSettings').on('value', snapshot => { appSettings = snapshot.val() || {}; });
                
                database.ref('electricityRates').on('value', (snapshot) => {
                    const rates = snapshot.val();
                    if (rates && rates.slabs) {
                        electricityRates = rates;
                        localStorage.setItem('electricityRates', JSON.stringify(rates));
                    }
                });

                database.ref('taxSettings').on('value', (snapshot) => {
                    const settings = snapshot.val();
                    if (settings && settings.taxFreeLimit && settings.slabs) {
                        taxSettings = settings;
                        localStorage.setItem('taxSettings', JSON.stringify(settings));
                    }
                });

                database.ref('calculatorSettings').on('value', (snapshot) => {
                    const settings = snapshot.val();
                    if (settings) {
                        calculatorSettings = settings;
                        localStorage.setItem('calculatorSettings', JSON.stringify(settings));
                        resetFishingTab(); 
                    }
                });
                
                database.ref('tabSettings').on('value', (snapshot) => {
                    const settings = snapshot.val();
                    if (settings) {
                        tabAccessSettings = settings;
                        localStorage.setItem('tabAccessSettings', JSON.stringify(settings));
                        
                        document.querySelectorAll('.tab-container .tab').forEach(tab => {
                            const tabId = tab.getAttribute('data-tab-id');
                            if (settings[tabId] && settings[tabId].visible === false) {
                                tab.style.display = 'none';
                            } else {
                                tab.style.display = 'inline-block';
                            }
                        });
                        document.querySelectorAll('.all-tabs-dropdown option').forEach(option => {
                            const tabId = option.getAttribute('data-tab-id');
                            if (tabId && settings[tabId] && settings[tabId].visible === false) {
                                option.style.display = 'none';
                            } else {
                                option.style.display = 'block';
                            }
                        });
                        updatePremiumUI();
                    }
                });


            } catch(e) {
                console.error("Firebase initialization failed:", e);
                 showToast("অনলাইন ফিচার লোড করা যায়নি।", "error");
            }
        }

        // Helper to close modals
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Helper to show info modal content
        function showInfoModal(tabId) {
            const modal = document.getElementById('info-modal');
            const title = document.getElementById('info-modal-title');
            const body = document.getElementById('info-modal-body');
            const lang = 'bn';
            
            // Default content if firebase fails or no data
            let content = "এই ক্যালকুলেটর সম্পর্কে বিস্তারিত তথ্য শীঘ্রই আসছে।";
            
            // Try to get from firebase loaded data or static map
            // For now static mapping for immediate response
            const infoMap = {
                'basic': 'সাধারণ যোগ, বিয়োগ, গুণ, ভাগ এবং শতকরা হিসাবের জন্য।',
                'offer': 'মোবাইল অপারেটরদের অফার প্যাকেজের সঠিক মূল্য এবং লাভ যাচাই করতে এটি ব্যবহার করুন।',
                'price': 'পণ্যের ওজন অনুযায়ী সঠিক দাম বের করুন।',
                'fishing': 'মাছ ধরার ট্রলারের আয়-ব্যয় এবং শেয়ার বন্টনের হিসাব।',
                'farming': 'পোলট্রি বা অন্যান্য খামারের লাভ-ক্ষতির হিসাব।',
                'age': 'নির্ভুল বয়স বের করা এবং দুইজনের বয়সের পার্থক্য দেখার জন্য।',
                'health': 'BMI এবং BMR হিসাব করে স্বাস্থ্য সচেতন হোন।',
                // Add others as needed
            };
            
            if (infoMap[tabId]) content = infoMap[tabId];
            
            // Check if we have firebase data
            if(tabInfoContent && tabInfoContent[tabId]) {
                content = tabInfoContent[tabId];
            }

            title.innerText = document.querySelector(`.tab[data-tab-id="${tabId}"]`).innerText.trim() + " তথ্য";
            body.innerHTML = content;
            modal.style.display = 'flex';
        }
        
        function loadTabInfo(database) {
             database.ref('tabInfo').on('value', (snapshot) => {
                tabInfoContent = snapshot.val() || {};
            });
        }
        
        function loadAppSettings(database) {
             // Already handled inside initializeFirebaseFeatures but kept function signature if needed
        }
        
        function displayAnnouncement(database) {
             // Logic moved inside initializeFirebaseFeatures for scope access
        }

        function hideAllPages() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('calc-history-page').style.display = 'none';
            document.getElementById('privacy-page').style.display = 'none';
            document.getElementById('password-recovery-page').style.display = 'none';
            document.getElementById('password-change-page').style.display = 'none';
            document.getElementById('help-support-page').style.display = 'none';
            document.getElementById('review-page').style.display = 'none';
            document.getElementById('other-apps-page').style.display = 'none';
            document.querySelector('.container').style.display = 'flex';
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const lang = 'bn';
                const originalText = button.innerHTML;
                button.innerHTML = `<i class="fas fa-check"></i>`;
                showToast(translations[lang].copied_to_clipboard);
                setTimeout(() => {
                   button.innerHTML = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Copy failed', err);
            });
        }
        
        function isValidBDPhoneNumber(number) {
            const pattern = /^(01[3-9])\d{8}$/;
            return pattern.test(number);
        }
        
        function shareApp() {
            const shareModal = document.getElementById('share-modal');
            const shareLinkInput = document.getElementById('share-link-input');
            const shareLink = appSettings.shareLink || window.location.href;
            
            shareLinkInput.value = shareLink;
            shareModal.style.display = 'flex';
        }

        function copyShareLink(button) {
            const shareLinkInput = document.getElementById('share-link-input');
            const lang = 'bn';
            const tr = translations[lang];

            const showCopySuccess = () => {
                const originalKey = button.getAttribute('data-translate-key');
                const originalText = tr[originalKey] || button.textContent;
                button.textContent = tr.copied_to_clipboard;
                showToast(tr.copied_to_clipboard);
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            };

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(shareLinkInput.value).then(showCopySuccess).catch(err => {
                    console.error('Async copy failed:', err);
                    alert('লিংক কপি করা যায়নি।');
                });
            } else {
                try {
                    shareLinkInput.select();
                    shareLinkInput.setSelectionRange(0, 99999); 
                    
                    if (document.execCommand('copy')) {
                        showCopySuccess();
                    } else {
                         throw new Error('execCommand failed');
                    }
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    alert('দুঃখিত, স্বয়ংক্রিয়ভাবে কপি করা যায়নি। অনুগ্রহ করে লিংকটি চেপে ধরে ম্যানুয়ালি কপি করুন।');
                } finally {
                    if (window.getSelection) {
                        window.getSelection().removeAllRanges();
                    }
                }
            }
        }
        
        function saveCalculationToHistory(type, inputs, result) {
            try {
                let history = JSON.parse(localStorage.getItem('calculationHistory')) || [];
                const lang = 'bn';
                const typeKey = `tab_${type}_option`;
                const typeName = (translations[lang] && translations[lang][typeKey]) ? translations[lang][typeKey] : type;

                if (history.length > 0) {
                    const lastEntry = history[0];
                    const cleanNewResult = result.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    
                    if (lastEntry.type === typeName &&
                        lastEntry.result === cleanNewResult &&
                        JSON.stringify(lastEntry.inputs) === JSON.stringify(inputs)) {
                        return; 
                    }
                }

                const newEntry = {
                    type: typeName,
                    inputs: inputs,
                    result: result.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim(),
                    timestamp: new Date().toISOString()
                };
                history.unshift(newEntry);
                if (history.length > 50) {
                    history.pop();
                }
                localStorage.setItem('calculationHistory', JSON.stringify(history));
            } catch (e) {
                console.error("Failed to save calculation history:", e);
            }
        }

        function showCalculationHistoryPage() {
            const historyPage = document.getElementById('calc-history-page');
            const lang = 'bn';
            const tr = translations[lang];

            const history = JSON.parse(localStorage.getItem('calculationHistory')) || [];
            let historyHTML = '';

            if (history.length === 0) {
                historyHTML = `<p style="text-align: center; opacity: 0.8;">${tr.no_calc_history_msg}</p>`;
            } else {
                history.forEach((item, index) => {
                    const date = new Date(item.timestamp);
                    const formattedDate = date.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' });
                    const formattedTime = date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });

                    historyHTML += `
                        <div class="calc-history-item">
                            <button class="delete-history-btn" onclick="deleteCalculationHistoryItem('${item.timestamp}')" title="মুছুন">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <div class="calc-history-header">
                                <span>${item.type}</span>
                                <span>${formattedDate} - ${formattedTime}</span>
                            </div>
                            <div class="calc-history-body">
                                <strong>${tr.inputs}:</strong>
                                <pre>${JSON.stringify(item.inputs, null, 2)}</pre>
                                <strong>${tr.result}:</strong>
                                <pre>${item.result}</pre>
                            </div>
                        </div>
                    `;
                });
            }

            historyPage.innerHTML = `
                <div class="page-content">
                    <div class="page-header">
                        <h2>${tr.calculation_history_title}</h2>
                        <button class="header-action-btn" onclick="clearCalculationHistory()">
                            <i class="fas fa-trash-alt"></i> <span>সব মুছুন</span>
                        </button>
                    </div>
                    <div id="calc-history-list">${historyHTML}</div>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            historyPage.style.display = 'block';
        }
        
        function deleteCalculationHistoryItem(timestamp) {
             if (confirm('আপনি কি এই হিস্টোরিটি মুছে ফেলতে চান?')) {
                let history = JSON.parse(localStorage.getItem('calculationHistory')) || [];
                const updatedHistory = history.filter(item => item.timestamp !== timestamp);
                localStorage.setItem('calculationHistory', JSON.stringify(updatedHistory));
                showCalculationHistoryPage();
            }
        }

        function clearCalculationHistory() {
            if (confirm('আপনি কি সব হিস্টেরি মুছে ফেলতে চান?')) {
                localStorage.removeItem('calculationHistory');
                showCalculationHistoryPage();
            }
        }
        
        function showPrivacyPolicyPage() {
            const privacyPage = document.getElementById('privacy-page');
            
            if (typeof firebase === 'undefined') {
                showToast("এই ফিচারটি ব্যবহার করতে ইন্টারনেট সংযোগ প্রয়োজন।", "error");
                return;
            }
             privacyPage.innerHTML = `
                <div class="page-content">
                    <div class="page-header">
                        <h2>প্রাইভেসি পলিসি</h2>
                    </div>
                    <p style="text-align: center;">লোড হচ্ছে...</p>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            privacyPage.style.display = 'block';

            window.db.ref('appSettings/privacyPolicy').once('value', (snapshot) => {
                const policyData = snapshot.val() || { text: "প্রাইভেসি পলিসি লোড করা যায়নি।", link: "#" };
                
                const formattedText = policyData.text
                    .replace(/\n/g, '<br>')
                    .replace(/### (.*?)(<br>|$)/g, '<h3>$1</h3>')
                    .replace(/## (.*?)(<br>|$)/g, '<h2>$1</h2>')
                    .replace(/\* \s*(.*?)(<br>|$)/g, '<li>$1</li>');

                privacyPage.querySelector('.page-content').innerHTML = `
                    <div class="page-header">
                        <h2>প্রাইভেসি পলিসি</h2>
                    </div>
                    <div style="line-height: 1.8; text-align: justify; padding: 0 10px;">
                        ${formattedText}
                    </div>
                    <br>
                    <p style="text-align: center;">
                        <a href="${policyData.link}" target="_blank" class="calculate-button" style="text-decoration: none; display: inline-block; width: auto; padding: 10px 20px;">
                            <i class="fas fa-external-link-alt"></i> ওয়েবসাইট ভিজিট করুন
                        </a>
                    </p>
                `;
            }).catch(error => {
                 showToast("প্রাইভেসি পলিসি লোড করতে সমস্যা হয়েছে: " + error.message, "error");
                 privacyPage.querySelector('p').textContent = "প্রাইভেসি পলিসি লোড করা যায়নি।";
            });
        }
        
        function showOtherAppsPage() {
            const page = document.getElementById('other-apps-page');
            
            if (typeof firebase === 'undefined') {
                showToast("এই ফিচারটি ব্যবহার করতে ইন্টারনেট সংযোগ প্রয়োজন।", "error");
                return;
            }

            page.innerHTML = `
                <div class="page-content" style="max-width: 500px;">
                    <div class="page-header">
                        <h2>অন্যান্য অ্যাপস</h2>
                    </div>
                    <div id="other-apps-container"><p style="text-align:center;">অ্যাপস লোড হচ্ছে...</p></div>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            page.style.display = 'block';

            window.db.ref('otherApps').orderByChild('order').on('value', (snapshot) => {
                const apps = snapshot.val();
                const container = document.getElementById('other-apps-container');
                container.innerHTML = '';
                if (apps) {
                    Object.values(apps).forEach(app => {
                        let screenshotsHTML = '';
                        if (app.screenshots && app.screenshots.length > 0) {
                            app.screenshots.forEach(ss => {
                                screenshotsHTML += `<img src="${ss}" alt="Screenshot" onclick="openImageViewer(this.src)">`;
                            });
                        }

                        const card = document.createElement('div');
                        card.className = 'other-app-card';
                        card.innerHTML = `
                            <img src="${app.logo}" alt="${app.name} Logo" class="logo">
                            <h3>${app.name}</h3>
                            <p>${app.description}</p>
                            ${screenshotsHTML ? `<div class="screenshots">${screenshotsHTML}</div>` : ''}
                            <a href="${app.downloadLink}" target="_blank" class="calculate-button">
                                <i class="fas fa-download"></i> ডাউনলোড করুন
                            </a>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p style="text-align:center;">এই মুহূর্তে কোনো অ্যাপ উপলব্ধ নেই।</p>';
                }
            }, (error) => {
                 container.innerHTML = '<p style="text-align:center; color: var(--danger-color);">অ্যাপস লোড করা যায়নি।</p>';
            });
        }

        function openImageViewer(src) {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('image-viewer-content');
            img.src = src;
            modal.style.display = 'flex';
            
            history.pushState({modal: 'imageViewer'}, '', location.href);
        }

        function closeImageViewer() {
            document.getElementById('image-viewer-modal').style.display = 'none';
            if (history.state && history.state.modal === 'imageViewer') {
                history.back();
            }
        }


        function handleExitConfirmation(e) {
            const lang = 'bn';
            const tr = translations[lang];
            const imageViewer = document.getElementById('image-viewer-modal');
            
            if (imageViewer.style.display === 'flex') {
                imageViewer.style.display = 'none';
                return; 
            }

            const isOverlayVisible = 
                document.getElementById('login-page').style.display === 'block' ||
                document.getElementById('calc-history-page').style.display === 'block' ||
                document.getElementById('privacy-page').style.display === 'block' ||
                document.getElementById('password-recovery-page').style.display === 'block' ||
                document.getElementById('password-change-page').style.display === 'block' ||
                document.getElementById('help-support-page').style.display === 'block' ||
                document.getElementById('review-page').style.display === 'block' ||
                document.getElementById('other-apps-page').style.display === 'block';

            if(isOverlayVisible) {
                 hideAllPages();
                 history.pushState(null, '', location.href);
            } else {
                if (!confirm(tr.exit_confirmation)) {
                    history.pushState(null, '', location.href);
                } else {
                    history.back();
                }
            }
        }
        
        function updateLoginUI() {
            const authContainer = document.getElementById('auth-menu-item');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const changePasswordItem = document.getElementById('change-password-menu-item');
            const lang = 'bn';
            const tr = translations[lang];
            const user = (typeof firebase !== 'undefined' && firebase.auth().currentUser);

            const existingLogout = document.getElementById('logout-menu-item');
            if (existingLogout) {
                existingLogout.remove();
            }
            
            if (user) {
                const userEmail = user.email;
                authContainer.innerHTML = `
                    <div class="menu-item">
                        <i class="fas fa-user-check"></i>
                        <span>${userEmail}</span>
                    </div>
                `;
                changePasswordItem.style.display = 'flex';
                const logoutItem = document.createElement('div');
                logoutItem.className = 'menu-item';
                logoutItem.id = 'logout-menu-item';
                logoutItem.onclick = logout;
                logoutItem.innerHTML = `<i class="fas fa-sign-out-alt"></i> <span>${tr.auth_logout}</span>`;
                dropdownMenu.appendChild(logoutItem);

            } else {
                authContainer.innerHTML = `
                    <div class="menu-item" onclick="showLoginPage()">
                        <i class="fas fa-user-plus"></i>
                        <span>${tr.auth_login_register}</span>
                    </div>
                `;
                changePasswordItem.style.display = 'none';
            }
        }

        function logout() {
            if (confirm("আপনি কি লগআউট করতে চান?")) {
                firebase.auth().signOut().catch(error => {
                    console.error("Logout failed:", error);
                    showToast("লগআউট করা যায়নি।", "error");
                });
            }
        }

        function showLoginPage() {
            const loginPage = document.getElementById('login-page');
            const lang = 'bn';
            const tr = translations[lang];

            loginPage.innerHTML = `
                <div class="page-content">
                    <div class="page-header">
                        <h2>${tr.auth_login_page_title}</h2>
                    </div>
                    <p style="text-align: center; margin-bottom: 20px;">${tr.auth_login_instructions}</p>
                    <div class="form-group">
                        <label for="login-user-email">${tr.auth_email_label}</label>
                        <input type="email" id="login-user-email" placeholder="${tr.auth_email_placeholder}">
                    </div>
                     <div class="form-group">
                        <label for="login-user-password">${tr.auth_password_label}</label>
                        <div class="input-wrapper">
                            <input type="password" id="login-user-password" placeholder="${tr.auth_password_placeholder}">
                            <button class="password-toggle-btn" onclick="togglePasswordVisibility('login-user-password', this)"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="calculate-button" onclick="handleAuthAction('login', this)">${tr.auth_login_btn}</button>
                        <button class="calculate-button" style="background-color: var(--info-color);" onclick="handleAuthAction('register', this)">${tr.auth_register_btn}</button>
                    </div>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            loginPage.style.display = 'block';
        }
        
        function handleAuthAction(action, button) {
            const emailInput = document.getElementById('login-user-email');
            const passwordInput = document.getElementById('login-user-password');
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                alert("অনুগ্রহ করে ইমেল এবং পাসওয়ার্ড লিখুন।");
                return;
            }

            if (password.length < 6) {
                alert("পাসওয়ার্ড অবশ্যই কমপক্ষে ৬ অক্ষরের হতে হবে।");
                return;
            }
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '...অপেক্ষা করুন';

            if (action === 'register') {
                firebase.auth().createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        window.db.ref('users/' + user.uid).set({
                            email: user.email,
                            registrationDate: new Date().toISOString(),
                            deviceId: getDeviceId() 
                        }).then(() => {
                            showToast("রেজিস্ট্রেশন সফল হয়েছে!");
                            hideAllPages();
                        });
                    })
                    .catch((error) => {
                        alert("রেজিস্ট্রেশন ব্যর্থ হয়েছে: " + error.message);
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            } else { 
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        showToast("লগইন সফল হয়েছে!");
                         hideAllPages();
                    })
                    .catch((error) => {
                         alert("লগইন ব্যর্থ হয়েছে: " + error.message);
                    })
                     .finally(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            }
        }
        
        function showPasswordRecoveryPage() {
            const page = document.getElementById('password-recovery-page');
            const lang = 'bn';
            const tr = translations[lang];
            
            page.innerHTML = `
                <div class="page-content">
                    <div class="page-header">
                        <h2>${tr.password_recovery_page_title}</h2>
                    </div>
                    <p style="text-align: center; margin-bottom: 20px;">${tr.password_recovery_instructions}</p>
                    <div class="form-group">
                        <label for="recovery-email">${tr.auth_email_label}</label>
                        <input type="email" id="recovery-email" placeholder="${tr.auth_email_placeholder}">
                    </div>
                    <button class="calculate-button" onclick="sendPasswordRecoveryEmail(this)">${tr.send_recovery_link_btn}</button>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            page.style.display = 'block';
        }

        function sendPasswordRecoveryEmail(button) {
            const emailInput = document.getElementById('recovery-email');
            const email = emailInput.value.trim();
            const lang = 'bn';
            const tr = translations[lang];

            if (!email) {
                alert("অনুগ্রহ করে আপনার ইমেইল ঠিকানা লিখুন।");
                return;
            }

            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '...অপেক্ষা করুন';

            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    showToast(tr.password_recovery_success);
                    hideAllPages();
                })
                .catch((error) => {
                    alert(tr.password_recovery_fail + error.message);
                })
                .finally(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                });
        }

        function showPasswordChangePage() {
            const page = document.getElementById('password-change-page');
            const lang = 'bn';
            const tr = translations[lang];

            if (!isUserLoggedIn()) {
                alert(tr.auth_login_required);
                showLoginPage();
                return;
            }

            page.innerHTML = `
                <div class="page-content">
                    <div class="page-header">
                        <h2>${tr.password_change_page_title}</h2>
                    </div>
                    <p style="text-align: center; margin-bottom: 20px;">${tr.password_change_instructions}</p>
                    <div class="form-group">
                        <label for="old-password">${tr.old_password_label}</label>
                        <div class="input-wrapper">
                            <input type="password" id="old-password" placeholder="${tr.old_password_placeholder}">
                            <button class="password-toggle-btn" onclick="togglePasswordVisibility('old-password', this)"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-password">${tr.new_password_label}</label>
                         <div class="input-wrapper">
                            <input type="password" id="new-password" placeholder="${tr.new_password_placeholder}">
                            <button class="password-toggle-btn" onclick="togglePasswordVisibility('new-password', this)"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">${tr.confirm_password_label}</label>
                        <div class="input-wrapper">
                            <input type="password" id="confirm-password" placeholder="${tr.confirm_password_placeholder}">
                            <button class="password-toggle-btn" onclick="togglePasswordVisibility('confirm-password', this)"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <button class="calculate-button" onclick="changeUserPassword(this)">${tr.change_password_btn}</button>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            page.style.display = 'block';
        }

        function changeUserPassword(button) {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const lang = 'bn';
            const tr = translations[lang];
            const user = firebase.auth().currentUser;

            if (!oldPassword) {
                alert("অনুগ্রহ করে আপনার পুরাতন পাসওয়ার্ড দিন।");
                return;
            }
            if (!newPassword || newPassword.length < 6) {
                alert("নতুন পাসওয়ার্ড অবশ্যই কমপক্ষে ৬ অক্ষরের হতে হবে।");
                return;
            }
            if (newPassword !== confirmPassword) {
                alert(tr.passwords_do_not_match);
                return;
            }

            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '...অপেক্ষা করুন';

            const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);

            user.reauthenticateWithCredential(credential).then(() => {
                return user.updatePassword(newPassword);
            }).then(() => {
                showToast(tr.password_change_success);
                hideAllPages();
            }).catch((error) => {
                if (error.code === 'auth/wrong-password') {
                    alert(tr.password_reauth_fail);
                } else {
                    alert(tr.password_change_fail + error.message);
                }
            }).finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }

        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }


        function showHelpSupportPage() {
            const page = document.getElementById('help-support-page');
            const lang = 'bn';
            const tr = translations[lang];
            
            if (typeof firebase === 'undefined') {
                showToast("এই ফিচারটি ব্যবহার করতে ইন্টারনেট সংযোগ প্রয়োজন।", "error");
                return;
            }

            page.innerHTML = `
                <div class="page-content">
                    <div class="page-header">
                        <h2>${tr.help_support_page_title}</h2>
                    </div>
                    <div id="support-content" style="text-align: center; padding: 20px;">
                        <p>${tr.help_support_loading}</p>
                    </div>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            page.style.display = 'block';

            window.db.ref('appSettings/supportInfo').once('value', (snapshot) => {
                const supportInfo = snapshot.val();
                const supportContentDiv = document.getElementById('support-content');
                let contentHTML = '';

                if (supportInfo && (supportInfo.phone || supportInfo.link)) {
                    contentHTML = `<p>${tr.help_support_contact_us}</p><br>`;
                    if (supportInfo.phone) {
                        contentHTML += `<a href="tel:${supportInfo.phone}" class="calculate-button" style="text-decoration: none; display: block; margin-bottom: 15px;"><i class="fas fa-phone"></i> ${tr.help_support_call} ${supportInfo.phone}</a>`;
                    }
                    if (supportInfo.link) {
                        contentHTML += `<a href="${supportInfo.link}" target="_blank" class="calculate-button" style="text-decoration: none; display: block; background-color: var(--info-color);"><i class="fas fa-external-link-alt"></i> ${tr.help_support_visit_link}</a>`;
                    }
                } else {
                    contentHTML = `<p>${tr.help_support_unavailable}</p>`;
                }
                supportContentDiv.innerHTML = contentHTML;
            }).catch(error => {
                document.getElementById('support-content').innerHTML = `<p>${tr.help_support_unavailable}</p>`;
            });
        }
        
        let currentRating = 0;

        async function showReviewPage() {
            const page = document.getElementById('review-page');
            const user = firebase.auth().currentUser;

            if (!user) {
                alert("রিভিউ দেওয়ার জন্য অনুগ্রহ করে লগইন করুন।");
                showLoginPage();
                return;
            }

            page.innerHTML = `
                <div class="page-content">
                    <div class="page-header">
                        <h2>রিভিউ দিন</h2>
                    </div>
                    <div id="review-form-container"><p style="text-align:center;">লোড হচ্ছে...</p></div>
                </div>
                <button class="page-back-button" onclick="hideAllPages()"><i class="fas fa-arrow-left"></i></button>
            `;
            document.querySelector('.container').style.display = 'none';
            page.style.display = 'block';

            try {
                const snapshot = await window.db.ref('reviews/' + user.uid).once('value');
                const existingReview = snapshot.val();
                const reviewContainer = document.getElementById('review-form-container');

                if (existingReview) {
                    reviewContainer.innerHTML = `
                        <h4 style="text-align:center;">আপনি ইতিমধ্যে একটি রিভিউ জমা দিয়েছেন।</h4>
                        <div class="result" style="display:block; text-align:left; margin-top: 15px;">
                            <p><strong>আপনার রেটিং:</strong> ${'★'.repeat(existingReview.rating)}${'☆'.repeat(5 - existingReview.rating)}</p>
                            <p><strong>আপনার মন্তব্য:</strong> ${existingReview.comment}</p>
                        </div>`;
                } else {
                    reviewContainer.innerHTML = `
                        <div class="form-group">
                            <label>আপনার ইমেইল:</label>
                            <input type="email" id="review-email" value="${user.email}" disabled>
                        </div>
                        <div class="form-group">
                            <label>আপনার রেটিং দিন:</label>
                            <div class="star-rating-container" id="star-rating">
                                <i class="fas fa-star" data-value="1"></i>
                                <i class="fas fa-star" data-value="2"></i>
                                <i class="fas fa-star" data-value="3"></i>
                                <i class="fas fa-star" data-value="4"></i>
                                <i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="review-comment">আপনার মন্তব্য:</label>
                            <textarea id="review-comment" placeholder="আপনার অভিজ্ঞতা শেয়ার করুন..."></textarea>
                        </div>
                        <button class="calculate-button" onclick="submitReview(this)">রিভিউ সাবমিট করুন</button>
                    `;
                    setupStarRating();
                }
            } catch (error) {
                document.getElementById('review-form-container').innerHTML = `<p style="text-align:center; color: var(--danger-color);">রিভিউ লোড করা যায়নি।</p>`;
                console.error("Error checking for existing review:", error);
            }
        }
        
        function setupStarRating() {
            const stars = document.querySelectorAll('#star-rating .fa-star');
            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    stars.forEach(s => {
                        s.classList.toggle('hover', s.dataset.value <= star.dataset.value);
                    });
                });
                star.addEventListener('mouseout', () => {
                    stars.forEach(s => s.classList.remove('hover'));
                });
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.value);
                    stars.forEach(s => {
                        s.classList.toggle('selected', s.dataset.value <= currentRating);
                    });
                });
            });
        }

        async function submitReview(button) {
            const user = firebase.auth().currentUser;
            const comment = document.getElementById('review-comment').value.trim();

            if (!user) return;
            if (currentRating === 0) {
                alert("অনুগ্রহ করে একটি স্টার রেটিং দিন।");
                return;
            }

            button.disabled = true;
            button.textContent = '...সাবমিট হচ্ছে';

            const reviewData = {
                userId: user.uid,
                email: user.email,
                rating: currentRating,
                comment: comment,
                timestamp: new Date().toISOString()
            };

            try {
                await window.db.ref('reviews/' + user.uid).set(reviewData);
                showToast("আপনার রিভিউ সফলভাবে জমা হয়েছে। ধন্যবাদ!", "success");
                hideAllPages();
            } catch (error) {
                showToast("একটি ত্রুটি ঘটেছে: " + error.message, "error");
                button.disabled = false;
                button.textContent = 'রিভিউ সাবমিট করুন';
            }
        }


        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = 'show ' + type;
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }

        
        document.addEventListener("DOMContentLoaded", function() {
            history.pushState(null, '', location.href);
            window.addEventListener('popstate', handleExitConfirmation);
            
            getDeviceId(); 
            makeDraggable(document.getElementById('floating-calculator'));
            
            try {
                const savedElecRates = localStorage.getItem('electricityRates');
                if (savedElecRates) electricityRates = JSON.parse(savedElecRates);

                const savedTaxSettings = localStorage.getItem('taxSettings');
                if (savedTaxSettings) taxSettings = JSON.parse(savedTaxSettings);
                
                const savedCalcSettings = localStorage.getItem('calculatorSettings');
                if (savedCalcSettings) calculatorSettings = JSON.parse(savedCalcSettings);

                const savedTabAccess = localStorage.getItem('tabAccessSettings');
                if (savedTabAccess) tabAccessSettings = JSON.parse(savedTabAccess);
            } catch (e) {
                console.error("Failed to load settings from localStorage", e);
            }

            const savedTheme = localStorage.getItem('theme');
            const themeSwitch = document.getElementById('theme-toggle-switch');
            const themeIcon = document.querySelector('#theme-toggle-menu i');

            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeSwitch.checked = true;
                themeIcon.classList.replace('fa-moon', 'fa-sun');
            } else {
                 document.body.removeAttribute('data-theme');
                 themeSwitch.checked = false;
                 themeIcon.classList.replace('fa-sun', 'fa-moon');
            }
            
            populateUnits();
            generateCrewInputs();
            togglePaintCarpetInputs();
            toggleInvestmentInputs();
            addIndividualFarmingSaleRow();
            addNoteListItem(); 
            toggleFarmingWeightInputs('total'); 
            updatePremiumUI();
            setLanguage(); 

            document.getElementById('notification-toggle').addEventListener('click', function() {
                if (currentAnnouncementMessage) {
                    document.getElementById('announcement-modal').style.display = 'flex';
                }
            });

            const menuToggle = document.getElementById('menu-toggle');
            const dropdownMenu = document.getElementById('dropdown-menu');
            menuToggle.addEventListener('click', function(event) {
                event.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });
            
            window.addEventListener('click', function(e) {
                if (!menuToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
            document.getElementById('converter-category').addEventListener('change', changeConverter);
            document.getElementById('converter-from-unit').addEventListener('change', convertUnits);
            document.getElementById('converter-to-unit').addEventListener('change', convertUnits);

            const offlineBanner = document.getElementById('offline-banner');
            window.addEventListener('online', () => {
                offlineBanner.style.display = 'none';
            });
            window.addEventListener('offline', () => {
                offlineBanner.style.display = 'block';
            });
            if (!navigator.onLine) {
                 offlineBanner.style.display = 'block';
            }
        });

        // ================= PWA SERVICE WORKER REGISTRATION START =================
        // এই কোডটি ব্রাউজারকে জানায় যে অ্যাপটির একটি Service Worker আছে,
        // যা অফলাইনে কাজ করতে সাহায্য করবে।
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service worker path updated: removed leading slash
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        // ================= PWA SERVICE WORKER REGISTRATION END =================

    </script>
</body>
</html>